<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0D0F14">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Showroom Manager">
<link rel="manifest" href="manifest.json">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js" crossorigin="anonymous"></script>
<title>Car Showroom Manager</title>
<style>
/* ================================================================
   ELITE AUTO MANAGER — BEAST EDITION
   4 Themes: Phantom (dark), Inferno (red/gold), Arctic (ice blue),
             Obsidian (pure black luxury)
   Award-winning 2025 design: depth lighting, bento grid,
   refined glassmorphism, bold type, micro-animations
   ZERO external fonts — renders identically on every device
================================================================ */

/* ── THEME DEFINITIONS ─────────────────────────────────────── */
:root,
[data-theme="phantom"] {
  --bg:           #0D0F14;
  --bg2:          #12151B;
  --surface:      #171B24;
  --surface2:     #1D2230;
  --surface3:     #232840;
  --border:       rgba(255,255,255,0.06);
  --border-hi:    rgba(139,92,246,0.35);
  --accent:       #8B5CF6;
  --accent2:      #A78BFA;
  --accent-glow:  rgba(139,92,246,0.25);
  --accent-dim:   rgba(139,92,246,0.1);
  --accent2-dim:  rgba(245,158,11,0.1);
  --accent2-hi:   rgba(245,158,11,0.3);
  --amber:        #F59E0B;
  --danger:       #F43F5E;
  --danger-dim:   rgba(244,63,94,0.1);
  --success:      #10B981;
  --warn:         #F59E0B;
  --text-1:       #F0F2F8;
  --text-2:       #8892AA;
  --text-3:       #4A5268;
  --glow-strong:  0 0 40px rgba(139,92,246,0.3), 0 0 80px rgba(139,92,246,0.1);
  --glow-soft:    0 0 20px rgba(139,92,246,0.15);
  --card-shadow:  0 24px 64px rgba(0,0,0,0.6), 0 8px 24px rgba(0,0,0,0.4);
  --header-bg:    linear-gradient(135deg,rgba(139,92,246,0.12) 0%,rgba(17,21,32,0.95) 100%);
  --btn-text:     #fff;
  --tab-active-bg:rgba(139,92,246,0.15);
  --shimmer1:     #8B5CF6;
  --shimmer2:     #A78BFA;
  --hero-glow1:   rgba(139,92,246,0.4);
  --hero-glow2:   rgba(245,158,11,0.2);
}

[data-theme="inferno"] {
  --bg:           #0F0A08;
  --bg2:          #150E0A;
  --surface:      #1C1108;
  --surface2:     #231508;
  --surface3:     #2A1B0A;
  --border:       rgba(255,255,255,0.06);
  --border-hi:    rgba(251,113,19,0.4);
  --accent:       #F97316;
  --accent2:      #FCD34D;
  --accent-glow:  rgba(249,115,22,0.3);
  --accent-dim:   rgba(249,115,22,0.1);
  --accent2-dim:  rgba(252,211,77,0.1);
  --accent2-hi:   rgba(252,211,77,0.3);
  --amber:        #FCD34D;
  --danger:       #EF4444;
  --danger-dim:   rgba(239,68,68,0.1);
  --success:      #22C55E;
  --warn:         #EAB308;
  --text-1:       #FDF4EC;
  --text-2:       #A08060;
  --text-3:       #5A3820;
  --glow-strong:  0 0 40px rgba(249,115,22,0.4), 0 0 80px rgba(249,115,22,0.15);
  --glow-soft:    0 0 20px rgba(249,115,22,0.2);
  --card-shadow:  0 24px 64px rgba(0,0,0,0.7), 0 8px 24px rgba(249,115,22,0.05);
  --header-bg:    linear-gradient(135deg,rgba(249,115,22,0.15) 0%,rgba(15,10,8,0.95) 100%);
  --btn-text:     #0F0A08;
  --tab-active-bg:rgba(249,115,22,0.12);
  --shimmer1:     #F97316;
  --shimmer2:     #FCD34D;
  --hero-glow1:   rgba(249,115,22,0.5);
  --hero-glow2:   rgba(252,211,77,0.2);
}

[data-theme="arctic"] {
  --bg:           #060C14;
  --bg2:          #081018;
  --surface:      #0C1826;
  --surface2:     #102030;
  --surface3:     #152840;
  --border:       rgba(255,255,255,0.07);
  --border-hi:    rgba(56,189,248,0.4);
  --accent:       #38BDF8;
  --accent2:      #818CF8;
  --accent-glow:  rgba(56,189,248,0.25);
  --accent-dim:   rgba(56,189,248,0.1);
  --accent2-dim:  rgba(129,140,248,0.1);
  --accent2-hi:   rgba(129,140,248,0.3);
  --amber:        #818CF8;
  --danger:       #FB7185;
  --danger-dim:   rgba(251,113,133,0.1);
  --success:      #34D399;
  --warn:         #FCD34D;
  --text-1:       #E8F4FF;
  --text-2:       #6A8EB8;
  --text-3:       #2A4870;
  --glow-strong:  0 0 40px rgba(56,189,248,0.3), 0 0 80px rgba(56,189,248,0.1);
  --glow-soft:    0 0 20px rgba(56,189,248,0.15);
  --card-shadow:  0 24px 64px rgba(0,0,0,0.65), 0 8px 24px rgba(0,0,0,0.4);
  --header-bg:    linear-gradient(135deg,rgba(56,189,248,0.1) 0%,rgba(6,12,20,0.95) 100%);
  --btn-text:     #040810;
  --tab-active-bg:rgba(56,189,248,0.12);
  --shimmer1:     #38BDF8;
  --shimmer2:     #818CF8;
  --hero-glow1:   rgba(56,189,248,0.4);
  --hero-glow2:   rgba(129,140,248,0.25);
}

[data-theme="obsidian"] {
  --bg:           #000000;
  --bg2:          #080808;
  --surface:      #0F0F0F;
  --surface2:     #161616;
  --surface3:     #1E1E1E;
  --border:       rgba(255,255,255,0.06);
  --border-hi:    rgba(212,175,55,0.4);
  --accent:       #D4AF37;
  --accent2:      #F5E070;
  --accent-glow:  rgba(212,175,55,0.25);
  --accent-dim:   rgba(212,175,55,0.08);
  --accent2-dim:  rgba(245,224,112,0.08);
  --accent2-hi:   rgba(245,224,112,0.3);
  --amber:        #F5E070;
  --danger:       #FF4444;
  --danger-dim:   rgba(255,68,68,0.1);
  --success:      #22C55E;
  --warn:         #F5A623;
  --text-1:       #F8F8F8;
  --text-2:       #888888;
  --text-3:       #444444;
  --glow-strong:  0 0 40px rgba(212,175,55,0.25), 0 0 80px rgba(212,175,55,0.08);
  --glow-soft:    0 0 20px rgba(212,175,55,0.12);
  --card-shadow:  0 24px 64px rgba(0,0,0,0.8), 0 8px 24px rgba(0,0,0,0.6);
  --header-bg:    linear-gradient(135deg,rgba(212,175,55,0.08) 0%,rgba(0,0,0,0.97) 100%);
  --btn-text:     #000;
  --tab-active-bg:rgba(212,175,55,0.1);
  --shimmer1:     #D4AF37;
  --shimmer2:     #F5E070;
  --hero-glow1:   rgba(212,175,55,0.35);
  --hero-glow2:   rgba(245,224,112,0.15);
}

/* ── BASE RESET ───────────────────────────────────────────── */
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
html { scroll-behavior:smooth; }

body {
  font-family: -apple-system,BlinkMacSystemFont,'SF Pro Display','Segoe UI','Helvetica Neue',Arial,sans-serif;
  background: var(--bg);
  min-height: 100vh;
  padding: 14px;
  color: var(--text-1);
  position: relative;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
  transition: background 0.5s ease, color 0.5s ease;
}

/* Deep layered background with animated glow orbs */
body::before {
  content:'';
  position:fixed; inset:0; z-index:0; pointer-events:none;
  background:
    radial-gradient(ellipse 55% 45% at 15%  5%,  var(--hero-glow1) 0%, transparent 55%),
    radial-gradient(ellipse 40% 35% at 85% 15%,  var(--hero-glow2) 0%, transparent 50%),
    radial-gradient(ellipse 60% 50% at 50% 95%,  var(--accent-glow) 0%, transparent 55%),
    var(--bg);
  animation: breathe 8s ease-in-out infinite alternate;
}

@keyframes breathe {
  0%   { opacity:0.7; }
  100% { opacity:1; }
}

/* Grain texture overlay — premium feel */
body::after {
  content:'';
  position:fixed; inset:0; z-index:0; pointer-events:none; opacity:0.35;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23n)' opacity='0.08'/%3E%3C/svg%3E");
}

body.urdu { font-family:'Noto Nastaliq Urdu',Georgia,serif; direction:rtl; text-align:right; }
body.urdu .tab-buttons { flex-direction:row-reverse; }
body.urdu input,body.urdu select { text-align:right; direction:rtl; }

.container { max-width:600px; margin:0 auto; position:relative; z-index:1; }

/* ── KEYFRAMES ───────────────────────────────────────────── */
@keyframes fadeUp   { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }
@keyframes fadeIn   { from{opacity:0} to{opacity:1} }
@keyframes shimmer  { 0%{background-position:-200% center} 100%{background-position:200% center} }
@keyframes spin     { to{transform:rotate(360deg)} }
@keyframes glow-pulse { 0%,100%{opacity:0.5} 50%{opacity:1} }
@keyframes float    { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-4px)} }
@keyframes border-dance { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
@keyframes scale-in { from{transform:scale(0.92);opacity:0} to{transform:scale(1);opacity:1} }

/* ── THEME SWITCHER ──────────────────────────────────────── */
/* theme-switcher moved to header */

/* theme-panel styles now in header panel section */

/* ── LOGIN ───────────────────────────────────────────────── */
.login-container {
  background: var(--header-bg);
  backdrop-filter:blur(40px) saturate(160%);
  -webkit-backdrop-filter:blur(40px) saturate(160%);
  border:1px solid var(--border);
  border-top:1px solid var(--border-hi);
  border-radius:28px; padding:56px 40px 48px;
  text-align:center; position:relative; overflow:hidden;
  box-shadow:var(--card-shadow), var(--glow-soft);
  animation:fadeUp 0.6s cubic-bezier(.4,0,.2,1) both;
}

/* Animated top border */
.login-container::before {
  content:'';
  position:absolute; top:0; left:0; right:0; height:2px;
  background:linear-gradient(90deg,transparent,var(--accent),var(--accent2),transparent);
  background-size:200% 100%;
  animation:border-dance 3s linear infinite, glow-pulse 2s ease infinite alternate;
}

/* Background glow blob */
.login-container::after {
  content:'';
  position:absolute; top:-100px; left:50%; transform:translateX(-50%);
  width:400px; height:300px;
  background:radial-gradient(ellipse,var(--accent-glow) 0%,transparent 65%);
  pointer-events:none;
}

.login-container h1 {
  font-size:30px; font-weight:800; letter-spacing:-0.5px;
  color:var(--text-1); margin-bottom:8px; position:relative; z-index:1;
}
.login-container h1 .hi { color:var(--accent); }
.login-container > p { color:var(--text-2); font-size:13px; margin-bottom:2px; }

/* ── HEADER ──────────────────────────────────────────────── */
.header {
  background:var(--header-bg);
  backdrop-filter:blur(30px) saturate(150%);
  -webkit-backdrop-filter:blur(30px) saturate(150%);
  border:1px solid var(--border);
  border-top:1px solid var(--border-hi);
  border-radius:22px; padding:18px 18px 14px;
  margin-bottom:12px; text-align:center;
  position:relative; overflow:hidden;
  box-shadow:var(--card-shadow);
  animation:fadeUp 0.5s cubic-bezier(.4,0,.2,1) both;
}

.header::before {
  content:'';
  position:absolute; top:0; left:0; right:0; height:1.5px;
  background:linear-gradient(90deg,transparent,var(--accent),var(--accent2),transparent);
  background-size:200% 100%;
  animation:border-dance 4s linear infinite;
}

.header h1 {
  font-size:19px; font-weight:800; letter-spacing:-0.3px;
  color:var(--text-1); margin-bottom:2px;
}
.header h1 .hi { color:var(--accent); }
.header > p { color:var(--text-3); font-size:10.5px; letter-spacing:0.3px; }

/* Header Buttons */
.logout-btn {
  display:inline-flex; align-items:center; gap:5px;
  background:var(--surface2); color:var(--text-2);
  border:1px solid var(--border); padding:7px 13px;
  border-radius:8px; font-size:11.5px; font-weight:600;
  cursor:pointer; margin-top:10px; margin-left:5px;
  transition:all 0.25s ease; font-family:inherit;
}
.logout-btn:hover { background:var(--surface3); color:var(--text-1); transform:translateY(-1px); box-shadow:var(--glow-soft); }

.manage-btn { border-color:var(--border-hi)!important; color:var(--accent)!important; background:var(--accent-dim)!important; }
.manage-btn:hover { background:rgba(139,92,246,0.18)!important; }
.lang-btn { border-color:var(--accent2-hi)!important; color:var(--accent2)!important; background:var(--accent2-dim)!important; }

/* ── NOTIFICATION BADGE ──────────────────────────────────── */
.notification-badge {
  position:absolute; top:12px; right:12px;
  background:var(--danger); color:#fff;
  padding:4px 10px; border-radius:20px;
  font-size:10.5px; font-weight:700; cursor:pointer;
  letter-spacing:0.2px; box-shadow:0 0 16px var(--danger);
  animation:glow-pulse 2s ease infinite;
}

/* ── INSTALL PROMPT ──────────────────────────────────────── */
.install-prompt {
  background:var(--accent-dim); border:1px solid var(--border-hi);
  color:var(--accent); padding:12px 15px; border-radius:14px;
  margin-bottom:12px; display:none; align-items:center; gap:10px; font-size:12.5px;
}
.install-prompt button {
  background:var(--accent); color:var(--btn-text);
  border:none; padding:7px 16px; border-radius:8px;
  font-weight:700; cursor:pointer; margin-left:auto; font-size:12px; font-family:inherit;
}

/* ── ALERT BOXES ─────────────────────────────────────────── */
.alert-box {
  background:var(--accent2-dim); border:1px solid var(--accent2-hi);
  border-left:2px solid var(--warn);
  padding:12px 14px; border-radius:12px; margin-bottom:12px;
  display:none; color:var(--text-1);
}
.alert-box.danger { background:var(--danger-dim); border-color:rgba(244,63,94,0.2); border-left-color:var(--danger); }
.alert-box strong { font-size:13px; display:block; margin-bottom:3px; }
.alert-box div { font-size:12px; line-height:1.7; color:var(--text-2); }

/* ── MAIN CARD ───────────────────────────────────────────── */
.card {
  background:rgba(17,20,28,0.7);
  backdrop-filter:blur(24px) saturate(150%);
  -webkit-backdrop-filter:blur(24px) saturate(150%);
  border:1px solid var(--border);
  border-radius:22px; padding:18px; padding-bottom:100px;
  margin-bottom:12px; min-height:calc(100vh - 180px);
  box-shadow:var(--card-shadow); position:relative; overflow:hidden;
}
.card::before {
  content:'';
  position:absolute; top:0; left:25%; right:25%; height:1px;
  background:linear-gradient(90deg,transparent,var(--border-hi),transparent);
}

/* ── BENTO STATS GRID ───────────────────────────────────── */
.bento-stats {
  display:grid; grid-template-columns:1fr 1fr; gap:9px; margin-bottom:16px;
}
.bento-card {
  background:var(--surface2); border:1px solid var(--border);
  border-radius:16px; padding:15px 14px;
  position:relative; overflow:hidden;
  transition:all 0.3s cubic-bezier(.4,0,.2,1);
  cursor:default;
}
.bento-card::before {
  content:'';
  position:absolute; top:0; left:0; right:0; height:1px;
  background:linear-gradient(90deg,transparent,var(--border-hi),transparent);
  opacity:0; transition:opacity 0.3s;
}
.bento-card:hover { border-color:var(--border-hi); transform:translateY(-3px); box-shadow:var(--glow-soft); }
.bento-card:hover::before { opacity:1; }

/* Glowing corner orb */
.bento-card::after {
  content:'';
  position:absolute; top:-20px; right:-20px;
  width:80px; height:80px;
  background:radial-gradient(circle,var(--accent-glow) 0%,transparent 65%);
  pointer-events:none;
}

.bento-icon { font-size:18px; margin-bottom:10px; display:block; line-height:1; }
.bento-value {
  font-size:23px; font-weight:800; color:var(--accent);
  letter-spacing:-0.5px; line-height:1; font-variant-numeric:tabular-nums;
  text-shadow:var(--glow-soft);
}
.bento-label {
  font-size:9.5px; color:var(--text-3); margin-top:5px;
  font-weight:600; text-transform:uppercase; letter-spacing:0.7px;
}

/* ── TAB NAVIGATION ─────────────────────────────────────── */
.tab-buttons {
  display:flex; gap:3px;
  background:rgba(0,0,0,0.85);
  backdrop-filter:blur(30px) saturate(120%);
  -webkit-backdrop-filter:blur(30px) saturate(120%);
  position:fixed; bottom:12px; left:50%; transform:translateX(-50%);
  padding:7px; border:1px solid var(--border);
  border-top:1px solid var(--border-hi);
  box-shadow:0 -4px 30px rgba(0,0,0,0.6), var(--glow-soft);
  z-index:100; max-width:580px; width:calc(100% - 28px); border-radius:20px;
}
.tab-btn {
  flex:1; padding:9px 3px 7px; border:none; background:transparent;
  color:var(--text-3); border-radius:13px;
  font-size:9px; font-weight:600; cursor:pointer;
  transition:all 0.3s cubic-bezier(.4,0,.2,1);
  display:flex; flex-direction:column; align-items:center; gap:4px;
  position:relative; letter-spacing:0.4px; font-family:inherit;
}
.tab-btn .tab-icon { font-size:17px; transition:transform 0.3s ease; }
.tab-btn:hover .tab-icon { transform:translateY(-2px); }
.tab-btn.active {
  background:var(--tab-active-bg); color:var(--accent);
  border:1px solid var(--border-hi); box-shadow:var(--glow-soft);
}
.tab-btn.active .tab-icon { transform:translateY(-2px); }
.tab-btn .badge {
  position:absolute; top:4px; right:4px;
  background:var(--danger); color:#fff;
  font-size:7px; padding:2px 4px; border-radius:7px; font-weight:700;
  box-shadow:0 0 8px var(--danger);
}

.tab-content { display:none; }
.tab-content.active { display:block; animation:fadeUp 0.3s cubic-bezier(.4,0,.2,1) both; }

/* ── SECTION HEADERS ────────────────────────────────────── */
.section-hd {
  display:flex; align-items:center; gap:8px; margin-bottom:14px;
}
.section-hd h3 { font-size:14px; font-weight:700; color:var(--text-1); letter-spacing:-0.2px; }
.section-dot {
  width:6px; height:6px; border-radius:50%; flex-shrink:0;
  background:var(--accent); box-shadow:0 0 8px var(--accent);
  animation:glow-pulse 2.5s ease infinite;
}

/* ── FORM ELEMENTS ──────────────────────────────────────── */
.form-group { margin-bottom:13px; }

label {
  display:block; margin-bottom:6px; color:var(--text-3);
  font-weight:500; font-size:10.5px; letter-spacing:0.7px; text-transform:uppercase;
}

input[type=text],input[type=password],input[type=date],input[type=number],select {
  width:100%; padding:12px 14px;
  border:1px solid var(--border); border-radius:10px;
  font-size:14.5px; font-family:inherit;
  background:var(--surface2); color:var(--text-1); font-weight:400;
  transition:all 0.25s ease; -webkit-appearance:none; appearance:none;
}
input:focus,select:focus {
  outline:none; border-color:var(--border-hi);
  background:var(--surface3); box-shadow:0 0 0 3px var(--accent-dim);
}
input::placeholder { color:var(--text-3); font-size:13.5px; }
select option { background:var(--surface2); color:var(--text-1); }

input[type=file] {
  width:100%; padding:16px 14px;
  border:1.5px dashed var(--border-hi); border-radius:10px;
  cursor:pointer; font-size:12.5px; font-family:inherit;
  background:var(--accent-dim); color:var(--text-2); transition:all 0.25s ease;
}
input[type=file]:hover { border-color:var(--accent); background:rgba(139,92,246,0.12); }

/* ── RADIO BUTTONS ──────────────────────────────────────── */
.radio-group { display:flex; gap:9px; margin:8px 0; flex-wrap:wrap; }
.radio-group label {
  display:flex; align-items:center; font-weight:500; cursor:pointer;
  font-size:13px; text-transform:none; letter-spacing:0;
  color:var(--text-2); background:var(--surface2);
  padding:9px 14px; border-radius:9px; border:1px solid var(--border);
  transition:all 0.2s ease;
}
.radio-group label:hover { border-color:var(--border-hi); color:var(--accent); }
input[type=radio] { margin-right:7px; accent-color:var(--accent); }

/* ── INSTALLMENT ────────────────────────────────────────── */
.installment-section {
  background:var(--surface2); padding:15px; border-radius:14px;
  margin-top:13px; display:none; border:1px solid var(--border-hi);
}
.installment-item {
  background:var(--surface3); padding:12px 14px; border-radius:9px;
  margin-bottom:9px; border:1px solid var(--border); border-left:2px solid var(--accent);
}

/* ── BUTTONS ────────────────────────────────────────────── */
.btn {
  width:100%; padding:14px; border:none; border-radius:10px;
  font-size:14.5px; font-weight:700; cursor:pointer;
  transition:all 0.3s cubic-bezier(.4,0,.2,1);
  margin-top:9px; font-family:inherit; letter-spacing:0.1px;
  position:relative; overflow:hidden;
}

.btn-primary {
  background:var(--accent); color:var(--btn-text);
  box-shadow:0 6px 24px var(--accent-glow);
}
/* shimmer sweep */
.btn-primary::before {
  content:'';
  position:absolute; inset:0;
  background:linear-gradient(90deg,transparent 0%,rgba(255,255,255,0.18) 50%,transparent 100%);
  background-size:200% 100%;
  animation:shimmer 2.5s infinite;
  pointer-events:none;
}
.btn-primary:hover { transform:translateY(-2px); box-shadow:0 10px 32px var(--accent-glow), var(--glow-strong); }
.btn-primary:active { transform:translateY(0); }
.btn-primary:disabled { opacity:0.45; cursor:not-allowed; transform:none; }

.btn-success {
  background:transparent; color:var(--accent);
  border:1px solid var(--border-hi); box-shadow:none;
}
.btn-success:hover { background:var(--accent-dim); }
.btn-success::before { display:none; }

.btn-small { padding:8px 14px; font-size:12px; width:auto; }

/* ── PREVIEW IMAGE ──────────────────────────────────────── */
.preview-image {
  width:100%; max-height:250px; object-fit:contain;
  border-radius:14px; margin-top:10px;
  border:1px solid var(--border); box-shadow:var(--glow-soft);
}

/* ── RECEIPT CARDS ──────────────────────────────────────── */
.receipt-item {
  background:var(--surface2); border:1px solid var(--border);
  border-radius:14px; padding:13px 15px; margin-bottom:7px;
  cursor:pointer; transition:all 0.25s cubic-bezier(.4,0,.2,1);
  position:relative; overflow:hidden;
}
/* Left glow bar on hover */
.receipt-item::before {
  content:'';
  position:absolute; top:0; left:0; bottom:0; width:2px;
  background:linear-gradient(180deg,var(--accent),var(--accent2));
  opacity:0; transition:opacity 0.25s;
}
.receipt-item:hover {
  border-color:var(--border-hi); transform:translateX(3px);
  box-shadow:var(--glow-soft);
}
.receipt-item:hover::before { opacity:1; }
.receipt-item.pending-payment { border-left:2px solid var(--warn); background:rgba(245,158,11,0.04); }
.receipt-item.overdue-payment { border-left:2px solid var(--danger); background:var(--danger-dim); }

.receipt-reg {
  font-size:15px; font-weight:700; color:var(--text-1);
  margin-bottom:5px; letter-spacing:-0.2px;
}
.receipt-date { font-size:11.5px; color:var(--text-3); margin-bottom:2px; }

/* ── PAYMENT BADGES ─────────────────────────────────────── */
.payment-badge {
  display:inline-flex; align-items:center; gap:4px;
  padding:3px 10px; border-radius:6px;
  font-size:10.5px; font-weight:600; margin-top:7px; letter-spacing:0.1px;
}
.payment-badge.cash       { background:rgba(16,185,129,0.1); color:var(--success); border:1px solid rgba(16,185,129,0.2); }
.payment-badge.installment{ background:var(--accent2-dim);   color:var(--amber);   border:1px solid var(--accent2-hi); }
.payment-badge.pending    { background:var(--danger-dim);    color:var(--danger);  border:1px solid rgba(244,63,94,0.2); }

/* ── STATS (tabs) ───────────────────────────────────────── */
.stats {
  display:flex; justify-content:space-around; padding:15px;
  background:var(--surface2); border-radius:14px; margin-bottom:14px;
  border:1px solid var(--border);
}
.stat-item { text-align:center; }
.stat-number {
  font-size:21px; font-weight:800; color:var(--accent);
  word-break:break-all; line-height:1.1;
  font-variant-numeric:tabular-nums;
  text-shadow:var(--glow-soft);
}
@media(max-width:480px) { .stat-number { font-size:16px; } }
.stat-label {
  font-size:9.5px; color:var(--text-3); margin-top:4px;
  font-weight:600; text-transform:uppercase; letter-spacing:0.5px;
}

/* ── MODAL ──────────────────────────────────────────────── */
.modal {
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,0.97); backdrop-filter:blur(20px);
  -webkit-backdrop-filter:blur(20px); z-index:1000; padding:18px; overflow-y:auto;
}
.modal.active { display:flex; align-items:center; justify-content:center; animation:fadeIn 0.2s ease; }
.modal-content { position:relative; max-width:900px; width:100%; }
.modal-image {
  width:100%; max-height:85vh; object-fit:contain;
  border-radius:18px; border:1px solid var(--border);
  box-shadow:var(--card-shadow), var(--glow-soft);
}
.close-modal {
  position:absolute; top:-46px; right:0;
  background:var(--surface2); border:1px solid var(--border);
  padding:9px 20px; border-radius:9px;
  font-size:13px; font-weight:600; cursor:pointer;
  color:var(--text-2); transition:all 0.2s ease; font-family:inherit;
}
.close-modal:hover { background:var(--surface3); color:var(--text-1); box-shadow:var(--glow-soft); }
body.urdu .close-modal { right:auto; left:0; }

/* ── MESSAGES ───────────────────────────────────────────── */
.success-msg,.error-msg {
  padding:11px 14px; border-radius:10px; margin-bottom:12px;
  display:none; font-weight:500; font-size:13px;
}
.success-msg { background:rgba(16,185,129,0.08); color:var(--success); border:1px solid rgba(16,185,129,0.2); border-left:2px solid var(--success); }
.error-msg   { background:var(--danger-dim); color:var(--danger); border:1px solid rgba(244,63,94,0.2); border-left:2px solid var(--danger); }

/* ── LOADING / EMPTY ────────────────────────────────────── */
.loading {
  text-align:center; padding:40px; color:var(--text-3); font-size:13px;
  display:flex; flex-direction:column; align-items:center; gap:12px;
}
.loading::before {
  content:''; width:22px; height:22px;
  border:2px solid var(--surface3); border-top-color:var(--accent);
  border-radius:50%; animation:spin 0.65s linear infinite;
}
.no-results { text-align:center; padding:48px; color:var(--text-3); font-size:13px; }

/* ── DELETE BUTTON ──────────────────────────────────────── */
.delete-btn {
  background:var(--danger-dim); color:var(--danger);
  border:1px solid rgba(244,63,94,0.2);
  padding:9px 15px; border-radius:9px;
  font-size:12.5px; font-weight:600; cursor:pointer;
  transition:all 0.2s ease; font-family:inherit;
}
.delete-btn:hover { background:rgba(244,63,94,0.18); box-shadow:0 0 12px var(--danger); }

.hidden { display:none!important; }

/* ── TAB HEADINGS ───────────────────────────────────────── */
.tab-content h3 {
  font-size:15px; font-weight:700; color:var(--text-1);
  margin-bottom:14px; letter-spacing:-0.2px;
}
.tab-content h4 { color:var(--text-2)!important; font-size:12px; font-weight:600; }

/* ── SCROLLBAR ──────────────────────────────────────────── */
::-webkit-scrollbar { width:4px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:var(--surface3); border-radius:4px; }
::-webkit-scrollbar-thumb:hover { background:var(--border-hi); }

/* ── RESPONSIVE ─────────────────────────────────────────── */
@media(max-width:480px) {
  body { padding:9px; }
  .header h1 { font-size:17px; }
  .card { padding:13px; padding-bottom:100px; }
  .tab-btn { font-size:8.5px; padding:8px 2px 6px; }
  .tab-btn .tab-icon { font-size:16px; }
  .login-container { padding:36px 22px; }
  .bento-value { font-size:19px; }
  .theme-switcher { bottom:85px; right:10px; }
}

/* ═══════════════════════════════════════
   DEVICE DETECTION RESPONSIVE
═══════════════════════════════════════ */
/* Mobile-first (default already set above) */

/* Tablet: 600px+ */
@media (min-width: 600px) {
  body { padding: 20px; }
  .container { max-width: 680px; }
  .card { padding: 28px; padding-bottom: 100px; border-radius: 28px; }
  .bento-stats { grid-template-columns: repeat(4, 1fr); gap: 12px; }
  .bento-value { font-size: 20px; }
  .tab-btn { font-size: 11px; padding: 10px 6px 8px; }
  .tab-btn .tab-icon { font-size: 20px; }
  .login-container { max-width: 440px; margin: 60px auto; }
}

/* Desktop: 1024px+ */
@media (min-width: 1024px) {
  body { padding: 30px; display: flex; align-items: flex-start; justify-content: center; min-height: 100vh; }
  .container { max-width: 780px; width: 100%; }
  .card { padding: 36px; padding-bottom: 110px; border-radius: 32px; }
  .header { display: flex; align-items: center; justify-content: space-between; text-align: left; padding: 20px 28px; }
  .header h1 { font-size: 22px; margin: 0; }
  .header > p { display: none; }
  .header-actions { display: flex; gap: 8px; margin-top: 0; }
  .logout-btn { margin-top: 0; }
  .bento-stats { grid-template-columns: repeat(4, 1fr); gap: 14px; }
  .bento-card { padding: 18px 16px; }
  .bento-value { font-size: 24px; }
  .bento-label { font-size: 10px; }
  .tab-buttons { max-width: 720px; bottom: 20px; }
  .tab-btn { font-size: 11px; padding: 11px 8px 9px; }
  .tab-btn .tab-icon { font-size: 22px; }
  .receipt-item { padding: 16px 20px; }
  .receipt-item:hover { transform: translateX(4px); }
  input[type=text],input[type=password],input[type=date],input[type=number],select { padding: 14px 16px; font-size: 15px; }
  .login-container { max-width: 480px; margin: 80px auto; }

}

/* Large Desktop: 1400px+ */
@media (min-width: 1400px) {
  .container { max-width: 900px; }

}

/* ═══════════════════════════════════════
   PREMIUM LOGIN PAGE
═══════════════════════════════════════ */
.login-container {
  position: relative;
  overflow: visible !important;
  margin-top: 40px;
}

/* Decorative spinning rings */
.login-rings {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  pointer-events: none;
  z-index: 0;
}
.ring {
  position: absolute;
  border-radius: 50%;
  border: 1px solid var(--border-hi);
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
}
.ring-1 { width: 300px; height: 300px; opacity: 0.15; animation: spin-slow 20s linear infinite; }
.ring-2 { width: 450px; height: 450px; opacity: 0.08; animation: spin-slow 35s linear infinite reverse; border-style: dashed; }
.ring-3 { width: 600px; height: 600px; opacity: 0.04; animation: spin-slow 50s linear infinite; }
@keyframes spin-slow { to { transform: translate(-50%,-50%) rotate(360deg); } }

.login-logo {
  position: relative; z-index: 1;
  display: flex; justify-content: center; margin-bottom: 20px;
}
.logo-icon {
  width: 72px; height: 72px; border-radius: 22px;
  background: var(--surface2);
  border: 1px solid var(--border-hi);
  display: flex; align-items: center; justify-content: center;
  box-shadow: var(--glow-strong);
  animation: float 4s ease-in-out infinite;
  position: relative; overflow: hidden;
}
.logo-icon::before {
  content: '';
  position: absolute; inset: 0; border-radius: 22px;
  background: linear-gradient(135deg, var(--accent-dim), transparent);
}

.login-brand { position: relative; z-index: 1; margin-bottom: 28px; }
.login-brand-sub {
  font-size: 9px; letter-spacing: 4px; color: var(--text-3);
  font-weight: 700; text-transform: uppercase; display: block; margin-bottom: 6px;
}
.login-brand-title {
  font-size: 32px !important; font-weight: 900; letter-spacing: -1px;
  line-height: 1; margin-bottom: 8px !important;
}
.login-brand-desc {
  color: var(--text-3) !important; font-size: 12px !important;
  letter-spacing: 0.5px; margin-bottom: 0 !important;
}

.login-divider {
  display: flex; align-items: center; gap: 12px;
  margin-bottom: 24px; position: relative; z-index: 1;
}
.login-divider-line { flex: 1; height: 1px; background: var(--border); }
.login-divider-text { font-size: 9px; letter-spacing: 2px; color: var(--text-3); font-weight: 700; white-space: nowrap; }

.login-form { position: relative; z-index: 1; }

.login-field {
  position: relative; margin-bottom: 14px;
}
.login-field-icon {
  position: absolute; left: 14px; top: 50%; transform: translateY(-50%);
  display: flex; align-items: center; pointer-events: none;
}
.login-input {
  padding-left: 42px !important;
  padding-right: 44px !important;
  border-radius: 12px !important;
  font-size: 15px !important;
  letter-spacing: 0.5px;
}
.pw-toggle {
  position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
  background: none; border: none; cursor: pointer;
  display: flex; align-items: center; padding: 4px;
}
.pw-toggle:hover svg { stroke: var(--accent); }

.login-btn {
  border-radius: 12px !important;
  font-size: 15px !important;
  letter-spacing: 0.5px;
  margin-top: 6px !important;
}
.login-btn-content {
  display: flex; align-items: center; justify-content: center; gap: 8px;
}

.login-footer {
  position: relative; z-index: 1;
  margin-top: 24px; font-size: 10px; letter-spacing: 1.5px;
  color: var(--text-3); text-transform: uppercase;
}

/* ═══════════════════════════════════════
   MODAL BUTTONS ROW
═══════════════════════════════════════ */
.modal-actions {
  display: flex; gap: 8px; justify-content: center;
  flex-wrap: wrap; margin-top: 16px;
}
.modal-actions button {
  cursor: pointer; font-family: inherit; transition: all 0.2s ease;
}
.modal-actions button:hover { transform: translateY(-2px); opacity: 0.85; }

/* ═══════════════════════════════════════
   TAB ICON UPGRADE — Symbol chars
═══════════════════════════════════════ */
.tab-btn .tab-icon {
  font-size: 20px;
  font-style: normal;
  line-height: 1;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI Symbol', sans-serif;
}

/* ═══════════════════════════════════════
   SECTION HEADER UPGRADE
═══════════════════════════════════════ */
.upload-section-title {
  font-size: 11px; font-weight: 700; letter-spacing: 1.5px;
  text-transform: uppercase; color: var(--text-3);
  display: flex; align-items: center; gap: 8px;
  margin-bottom: 16px; margin-top: 8px;
}
.upload-section-title::before {
  content: ''; flex: 0 0 24px; height: 1px; background: var(--border-hi);
}
.upload-section-title::after {
  content: ''; flex: 1; height: 1px; background: var(--border);
}

/* ═══════════════════════════════════════
   DESKTOP LAYOUT EXTRAS
═══════════════════════════════════════ */
@media (min-width: 1024px) {
  /* Two column form on desktop */
  .form-row-2 {
    display: grid; grid-template-columns: 1fr 1fr; gap: 14px;
  }
  .form-row-2 .form-group { margin-bottom: 0; }
}


/* ═══════════════════════════════
   PROFIT TAB — 3 VIEW STYLES
═══════════════════════════════ */
.profit-style-bar {
  display:flex; gap:6px; margin-bottom:16px;
}
.ps-btn {
  flex:1; padding:8px 6px; border:1px solid var(--border);
  border-radius:8px; background:var(--surface2);
  color:var(--text-3); font-size:11px; font-weight:600;
  cursor:pointer; transition:all 0.2s ease; font-family:inherit;
  letter-spacing:0.3px;
}
.ps-btn.active { background:var(--accent-dim); color:var(--accent); border-color:var(--border-hi); }
.ps-btn:hover:not(.active) { background:var(--surface3); color:var(--text-2); }

.profit-view { display:none; }
.profit-view.active-view { display:block; }

/* Bento Cards */
.profit-bento {
  display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px;
}
.profit-card {
  background:var(--surface2); border:1px solid var(--border);
  border-radius:14px; padding:15px 14px; position:relative; overflow:hidden;
  transition:all 0.25s ease;
}
.profit-card:hover { border-color:var(--border-hi); transform:translateY(-2px); box-shadow:var(--glow-soft); }
.pc-icon {
  font-size:18px; font-weight:900; color:var(--accent); margin-bottom:8px;
  line-height:1; opacity:0.7;
}
.profit-card--cost .pc-icon { color:var(--danger); }
.profit-card--expenses .pc-icon { color:var(--warn); }
.profit-card--margin .pc-icon { color:var(--accent2); font-size:13px; font-weight:800; }

.pc-label { font-size:9.5px; color:var(--text-3); text-transform:uppercase; letter-spacing:0.6px; font-weight:600; margin-bottom:4px; }
.pc-value { font-size:16px; font-weight:800; color:var(--text-1); word-break:break-all; line-height:1.1; font-variant-numeric:tabular-nums; }

.pc-bar { height:3px; background:var(--border); border-radius:2px; margin-top:10px; overflow:hidden; }
.pc-bar-fill { height:100%; border-radius:2px; transition:width 0.8s cubic-bezier(.4,0,.2,1); }

.pc-ring-wrap { position:absolute; bottom:8px; right:8px; width:40px; height:40px; opacity:0.6; }
.pc-ring { width:100%; height:100%; transform:rotate(-90deg); }

/* Net Profit Hero */
.profit-hero {
  background:var(--surface2); border:1px solid var(--border-hi);
  border-radius:16px; padding:20px; text-align:center;
  position:relative; overflow:hidden; margin-bottom:14px;
}
.profit-hero::before {
  content:''; position:absolute; inset:0;
  background:linear-gradient(135deg,var(--accent-dim),transparent);
  pointer-events:none;
}
.profit-hero-label { font-size:10px; color:var(--text-3); letter-spacing:1px; text-transform:uppercase; margin-bottom:6px; }
.profit-hero-value {
  font-size:32px; font-weight:900; color:var(--accent);
  letter-spacing:-1px; font-variant-numeric:tabular-nums;
  text-shadow:var(--glow-soft); line-height:1;
}
.profit-hero-sub { font-size:11px; color:var(--text-3); margin-top:6px; }

/* Gauge Style */
.gauge-wrap { text-align:center; padding:10px 0 0; }
.gauge-svg { width:200px; height:120px; }
.gauge-value { font-size:28px; font-weight:900; color:var(--accent); letter-spacing:-1px; margin-top:-10px; }
.gauge-label { font-size:10px; color:var(--text-3); letter-spacing:1px; text-transform:uppercase; margin-bottom:16px; }
.gauge-stats { display:flex; flex-direction:column; gap:8px; background:var(--surface2); border-radius:12px; padding:14px; border:1px solid var(--border); }
.gs-item { display:flex; align-items:center; gap:8px; font-size:13px; color:var(--text-2); }
.gs-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }

/* Minimal Style */
.minimal-profit { background:var(--surface2); border:1px solid var(--border); border-radius:16px; padding:20px; }
.mp-row { display:flex; justify-content:space-between; align-items:center; padding:10px 0; font-size:13.5px; color:var(--text-2); }
.mp-net { font-size:16px; font-weight:700; color:var(--text-1); }
.mp-val { font-weight:700; color:var(--text-1); font-variant-numeric:tabular-nums; }
.mp-val.danger { color:var(--danger); }
.mp-val.accent { color:var(--accent); font-size:20px; text-shadow:var(--glow-soft); }
.mp-divider { height:1px; background:var(--border); margin:4px 0; }
.mp-divider.accent { background:var(--border-hi); }
.mp-margin-bar { height:6px; background:var(--border); border-radius:3px; margin-top:14px; overflow:hidden; position:relative; }
.mp-mb-fill { height:100%; background:linear-gradient(90deg,var(--danger),var(--warn),var(--accent)); border-radius:3px; width:0; transition:width 0.8s cubic-bezier(.4,0,.2,1); }
.mp-mb-label { position:absolute; right:0; top:-16px; font-size:10px; color:var(--accent); font-weight:700; }

/* icon-option styles now in header panel section */

/* ═══════════════════════════════════════════════
   HEADER THEME PANEL (moved from floating button)
═══════════════════════════════════════════════ */
.theme-hdr-btn {
  background: var(--accent-dim) !important;
  border-color: var(--border-hi) !important;
  color: var(--accent) !important;
}

.theme-panel {
  position: absolute;
  top: calc(100% + 10px);
  left: 50%; transform: translateX(-50%);
  width: min(420px, calc(100vw - 28px));
  background: var(--surface);
  border: 1px solid var(--border-hi);
  border-radius: 20px;
  padding: 18px;
  box-shadow: var(--card-shadow), var(--glow-soft);
  display: none;
  flex-direction: column;
  gap: 12px;
  z-index: 500;
  backdrop-filter: blur(30px);
  -webkit-backdrop-filter: blur(30px);
  animation: scale-in 0.22s cubic-bezier(.4,0,.2,1) both;
}
.theme-panel.open { display: flex; }

.tp-header {
  display: flex; align-items: center; justify-content: space-between;
}
.tp-title {
  font-size: 14px; font-weight: 700; color: var(--text-1); letter-spacing: -0.2px;
}
.tp-close {
  background: var(--surface2); border: 1px solid var(--border);
  color: var(--text-3); width: 28px; height: 28px; border-radius: 8px;
  cursor: pointer; font-size: 13px; display: flex;
  align-items: center; justify-content: center;
  transition: all 0.2s ease; font-family: inherit;
}
.tp-close:hover { background: var(--surface3); color: var(--text-1); }

.tp-section-label {
  font-size: 9.5px; font-weight: 700; letter-spacing: 1.2px;
  text-transform: uppercase; color: var(--text-3);
  margin-bottom: -4px;
}

/* 2×2 theme grid */
.theme-grid {
  display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
}
.theme-option {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 12px; border-radius: 12px; cursor: pointer;
  border: 1px solid transparent; transition: all 0.2s ease; background: transparent;
}
.theme-option:hover { background: var(--surface2); border-color: var(--border-hi); }
.theme-option.active { background: var(--accent-dim); border-color: var(--border-hi); }
.theme-swatch {
  width: 26px; height: 26px; border-radius: 8px; flex-shrink: 0;
}
.theme-option-name { font-size: 12.5px; font-weight: 600; color: var(--text-1); flex: 1; }
.theme-check { font-size: 13px; color: var(--accent); opacity: 0; transition: opacity 0.2s; }
.theme-option.active .theme-check { opacity: 1; }

/* 4×2 icon grid */
.icon-grid {
  display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px;
}
.icon-option {
  display: flex; flex-direction: column; align-items: center; gap: 4px;
  padding: 10px 6px; border-radius: 12px; cursor: pointer;
  border: 1px solid transparent; transition: all 0.2s ease; background: transparent;
  position: relative;
}
.icon-option:hover { background: var(--surface2); border-color: var(--border-hi); }
.icon-option.active { background: var(--accent-dim); border-color: var(--border-hi); }
.icon-preview { font-size: 15px; line-height: 1; letter-spacing: -2px; }
.icon-opt-name { font-size: 9.5px; font-weight: 600; color: var(--text-2); }
.icon-check {
  position: absolute; top: 3px; right: 5px;
  font-size: 10px; color: var(--accent); opacity: 0; transition: opacity 0.2s;
}
.icon-option.active .icon-check { opacity: 1; }

/* Install button inside panel */
.install-inline-btn {
  display: flex; align-items: center; gap: 12px;
  background: var(--surface2); border: 1px solid var(--border-hi);
  border-radius: 14px; padding: 13px 15px; cursor: pointer;
  transition: all 0.25s ease; width: 100%; font-family: inherit;
  text-align: left;
}
.install-inline-btn:hover {
  background: var(--accent-dim);
  box-shadow: var(--glow-soft);
  transform: translateY(-1px);
}
.install-inline-btn:disabled {
  opacity: 0.4; cursor: default; transform: none;
}
.iib-icon {
  font-size: 22px; color: var(--accent); line-height: 1;
  width: 36px; height: 36px; background: var(--accent-dim);
  border-radius: 10px; display: flex; align-items: center;
  justify-content: center; flex-shrink: 0;
}
.iib-text { flex: 1; display: flex; flex-direction: column; gap: 2px; }
.iib-title { font-size: 13px; font-weight: 700; color: var(--text-1); }
.iib-sub { font-size: 10.5px; color: var(--text-3); }
.iib-arrow { font-size: 20px; color: var(--text-3); }
.install-inline-btn:hover .iib-arrow { color: var(--accent); }

.install-ios-hint {
  background: var(--accent-dim); border: 1px solid var(--border-hi);
  border-radius: 10px; padding: 10px 14px;
  font-size: 12px; color: var(--text-2); text-align: center;
  line-height: 1.5;
}

/* Header positioning context */
.header { position: relative; overflow: visible !important; }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen" class="container">
  <div class="login-container">

    <!-- Decorative rings -->
    <div class="login-rings">
      <div class="ring ring-1"></div>
      <div class="ring ring-2"></div>
      <div class="ring ring-3"></div>
    </div>

    <!-- Logo mark -->
    <div class="login-logo">
      <div class="logo-icon">
        <svg width="38" height="38" viewBox="0 0 38 38" fill="none">
          <circle cx="19" cy="19" r="18" stroke="var(--accent)" stroke-width="1.5" stroke-dasharray="4 2" opacity="0.4"/>
          <circle cx="19" cy="19" r="12" fill="var(--accent-dim)" stroke="var(--accent)" stroke-width="1.5"/>
          <path d="M10 22h18M12 22l2-5h10l2 5M14 22v2M24 22v2M13 17h12" stroke="var(--accent)" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
      </div>
    </div>

    <!-- Brand -->
    <div class="login-brand">
      <span class="login-brand-sub">ELITE</span>
      <h1 id="login-title" class="login-brand-title"><span class="hi">AUTO</span> MANAGER</h1>
      <p id="login-sub" class="login-brand-desc">Premium Showroom Intelligence</p>
    </div>

    <!-- Divider -->
    <div class="login-divider">
      <span class="login-divider-line"></span>
      <span class="login-divider-text">SECURE ACCESS</span>
      <span class="login-divider-line"></span>
    </div>

    <!-- Form -->
    <div class="login-form">
      <div class="error-msg" id="login-error"></div>
      <div class="login-field">
        <div class="login-field-icon">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--text-3)" stroke-width="2" stroke-linecap="round">
            <rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/>
          </svg>
        </div>
        <input type="password" id="login-password" placeholder="Enter your password" class="login-input">
        <button class="pw-toggle" onclick="togglePw()" type="button">
          <svg id="pw-eye" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--text-3)" stroke-width="2" stroke-linecap="round">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
          </svg>
        </button>
      </div>
      <button class="btn btn-primary login-btn" onclick="login()" id="btn-login">
        <span class="login-btn-content">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
            <path d="M15 3h4a2 2 0 012 2v14a2 2 0 01-2 2h-4M10 17l5-5-5-5M15 12H3"/>
          </svg>
          <span id="btn-login-text">Sign In</span>
        </span>
      </button>
    </div>

    <p class="login-footer">Powered by Advanced Technology</p>
  </div>
</div>

<!-- MAIN APP -->
<div id="main-app" class="container hidden">
  <div class="header">
    <h1 id="header-title"><svg style="width:20px;height:20px;vertical-align:middle;margin-right:6px;margin-top:-2px;" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round"><path d="M5 17H3a2 2 0 01-2-2v-4l3.5-7h13L21 11v4a2 2 0 01-2 2h-2"/><circle cx="7.5" cy="17.5" r="2.5"/><circle cx="16.5" cy="17.5" r="2.5"/><path d="M5 11h14"/></svg><span class="hi">AUTO</span> MANAGER</h1>
    <p>Premium Sales Management System</p>
    <p style="font-size:11px;color:#999;margin-top:8px;">Powered by Advanced Technology</p>
    <div class="notification-badge hidden" id="overdue-badge" onclick="switchTabDirect('payments')">
      <span id="overdue-count">0</span> <span id="lbl-overdue">Overdue</span>
    </div>
    <button class="logout-btn lang-btn" onclick="toggleLanguage()">🌐 <span id="lang-text">اردو</span></button>
    <button class="logout-btn manage-btn" onclick="manageEmployees()">👥 <span id="lbl-employees">Employees</span></button>
    <button class="logout-btn theme-hdr-btn" onclick="toggleThemePanel()" id="theme-hdr-btn">🎨 <span>Style</span></button>
    <button class="logout-btn" onclick="logout()">🚪 <span id="lbl-logout">Logout</span></button>
  </div>

  <!-- THEME PANEL — anchored to header -->
  <div class="theme-panel" id="theme-panel">
    <div class="tp-header">
      <span class="tp-title">Appearance</span>
      <button class="tp-close" onclick="toggleThemePanel()">✕</button>
    </div>

    <div class="tp-section-label">Theme</div>
    <div class="theme-grid">
      <div class="theme-option active" data-theme="phantom" onclick="setTheme('phantom',this)">
        <div class="theme-swatch" style="background:linear-gradient(135deg,#8B5CF6,#1D2230);"></div>
        <div class="theme-option-name">Phantom</div>
        <span class="theme-check">✓</span>
      </div>
      <div class="theme-option" data-theme="inferno" onclick="setTheme('inferno',this)">
        <div class="theme-swatch" style="background:linear-gradient(135deg,#F97316,#1C1108);"></div>
        <div class="theme-option-name">Inferno</div>
        <span class="theme-check">✓</span>
      </div>
      <div class="theme-option" data-theme="arctic" onclick="setTheme('arctic',this)">
        <div class="theme-swatch" style="background:linear-gradient(135deg,#38BDF8,#060C14);"></div>
        <div class="theme-option-name">Arctic</div>
        <span class="theme-check">✓</span>
      </div>
      <div class="theme-option" data-theme="obsidian" onclick="setTheme('obsidian',this)">
        <div class="theme-swatch" style="background:linear-gradient(135deg,#D4AF37,#000000);"></div>
        <div class="theme-option-name">Obsidian</div>
        <span class="theme-check">✓</span>
      </div>
    </div>

    <div class="tp-section-label">Icon Style</div>
    <div class="icon-grid">
      <div class="icon-option active" onclick="setIconPack('minimal',this)">
        <span class="icon-preview">⊕◎≡</span>
        <span class="icon-opt-name">Minimal</span>
        <span class="icon-check">✓</span>
      </div>
      <div class="icon-option" onclick="setIconPack('arrows',this)">
        <span class="icon-preview">→⬆⬇</span>
        <span class="icon-opt-name">Arrows</span>
        <span class="icon-check">✓</span>
      </div>
      <div class="icon-option" onclick="setIconPack('emoji',this)">
        <span class="icon-preview">🚗💰📊</span>
        <span class="icon-opt-name">Emoji</span>
        <span class="icon-check">✓</span>
      </div>
      <div class="icon-option" onclick="setIconPack('sharp',this)">
        <span class="icon-preview">▲◆●</span>
        <span class="icon-opt-name">Sharp</span>
        <span class="icon-check">✓</span>
      </div>
      <div class="icon-option" onclick="setIconPack('neon',this)">
        <span class="icon-preview">⚡★◉</span>
        <span class="icon-opt-name">Neon</span>
        <span class="icon-check">✓</span>
      </div>
      <div class="icon-option" onclick="setIconPack('rounded',this)">
        <span class="icon-preview">⬡⬢⬣</span>
        <span class="icon-opt-name">Hex</span>
        <span class="icon-check">✓</span>
      </div>
      <div class="icon-option" onclick="setIconPack('dots',this)">
        <span class="icon-preview">•••</span>
        <span class="icon-opt-name">Dots</span>
        <span class="icon-check">✓</span>
      </div>
      <div class="icon-option" onclick="setIconPack('lines',this)">
        <span class="icon-preview">⌇⌇⌇</span>
        <span class="icon-opt-name">Lines</span>
        <span class="icon-check">✓</span>
      </div>
    </div>

    <div class="tp-section-label">Install App</div>
    <button class="install-inline-btn" id="install-inline-btn" onclick="installApp()">
      <span class="iib-icon">⊕</span>
      <div class="iib-text">
        <span class="iib-title">Install on Device</span>
        <span class="iib-sub">Open like a native app</span>
      </div>
      <span class="iib-arrow">›</span>
    </button>
    <div class="install-ios-hint" id="ios-hint" style="display:none;">
      <span>📱 iOS: Tap <strong>Share</strong> → <strong>Add to Home Screen</strong></span>
    </div>
  </div>

<!-- install moved to theme panel -->

  <div class="card">

    <!-- UPLOAD TAB -->
    <div id="upload-tab" class="tab-content active">
      <div class="success-msg" id="upload-success"></div>
      <div class="error-msg" id="upload-error"></div>
      <div class="form-row-2"><div class="form-group"><label id="lbl-car-name">Car Name / Model *</label><input type="text" id="car-name" placeholder="e.g., Toyota Corolla 2020"></div><div class="form-group"><label id="lbl-reg-number">Registration No. *</label><input type="text" id="reg-number" placeholder="e.g., ABC-123" style="text-transform:uppercase"></div></div>
      <div class="form-row-2"><div class="form-group"><label id="lbl-cust-name">Customer Name *</label><input type="text" id="customer-name" placeholder="e.g., Ahmed Khan"></div><div class="form-group"><label id="lbl-cust-phone">Phone *</label><input type="text" id="customer-phone" placeholder="03001234567"></div></div>
      <div class="form-row-2"><div class="form-group"><label id="lbl-sell-date">Sale Date *</label><input type="date" id="selling-date"></div><div class="form-group"><label id="lbl-sell-price">Selling Price (PKR) *</label><input type="number" id="selling-price" placeholder="2500000" min="0" step="1000"></div></div>
      <div class="form-group"><label id="lbl-purch-cost">Purchase Cost (PKR) *</label><input type="number" id="purchase-cost" placeholder="e.g., 2000000" min="0" step="1000">
        <small id="lbl-purch-hint" style="color:#666;font-size:12px;display:block;margin-top:5px;">💡 How much did you pay to buy this car?</small>
      </div>
      <div class="form-group">
        <label id="lbl-expenses">Additional Expenses (Optional)</label>
        <small id="lbl-exp-hint" style="color:#666;font-size:12px;display:block;margin-bottom:10px;">Repairs, maintenance, modifications, etc.</small>
        <div id="expenses-container"></div>
        <button type="button" class="btn btn-primary" onclick="addExpenseField()" style="width:auto;padding:10px 15px;margin-top:5px;" id="btn-add-expense">+ Add Expense</button>
      </div>
      <div class="form-group">
        <label id="lbl-pay-type">Payment Type *</label>
        <div class="radio-group">
          <label><input type="radio" name="payment-type" value="CASH" checked onchange="toggleInstallmentSection()"> 💵 <span id="lbl-cash">Cash (Full Payment)</span></label>
          <label><input type="radio" name="payment-type" value="INSTALLMENT" onchange="toggleInstallmentSection()"> 📅 <span id="lbl-inst">Installment</span></label>
        </div>
      </div>
      <div class="installment-section" id="installment-section">
        <div class="form-group"><label id="lbl-down">Down Payment (PKR) *</label><input type="number" id="down-payment" placeholder="e.g., 500000" min="0" step="1000"></div>
        <div class="form-group">
          <label id="lbl-inst-count">Number of Installments *</label>
          <select id="installment-count" onchange="generateInstallmentFields()">
            <option value="1">1</option><option value="2">2</option><option value="3">3</option>
            <option value="4">4</option><option value="5">5</option><option value="6">6</option>
          </select>
        </div>
        <div id="installment-fields"></div>
      </div>
      <div class="form-group"><label id="lbl-sold-by">Sold By (Employee) *</label><select id="sold-by"><option value="">Select Employee</option></select></div>
      <div class="form-group"><label id="lbl-receipt-photo">Receipt Photo *</label><input type="file" id="receipt-photo" accept="image/*"></div>
      <img id="preview" class="preview-image" style="display:none">
      <button class="btn btn-primary" onclick="uploadReceipt()" id="btn-save-receipt">Save Receipt</button>
    </div>

    <!-- PAYMENTS TAB -->
    <div id="payments-tab" class="tab-content">
      <h3 style="color:#E8C870;margin-bottom:20px;font-weight:700;font-family:Georgia,'Times New Roman',serif;font-size:22px;">💰 <span id="lbl-pay-track">Payment Tracking</span></h3>
      <div class="alert-box danger" id="overdue-alert"><strong id="lbl-overdue-title">⚠️ Overdue Payments!</strong><div id="overdue-list" style="margin-top:10px;"></div></div>
      <div class="alert-box" id="upcoming-alert"><strong id="lbl-upcoming-title">📅 Upcoming Payments</strong><div id="upcoming-list" style="margin-top:10px;"></div></div>
      <div class="stats" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:15px;background:var(--surface2);border-radius:12px;border:1px solid var(--border);margin-bottom:14px;">
        <div class="stat-item"><div class="stat-number" id="total-pending">₨0</div><div class="stat-label" id="lbl-total-pending">Total Pending</div></div>
        <div class="stat-item"><div class="stat-number" id="total-received">₨0</div><div class="stat-label" id="lbl-total-received">Total Received</div></div>
      </div>
      <button class="btn btn-primary" onclick="loadPayments()" style="margin-bottom:15px;" id="btn-refresh-pay">↻ Refresh</button>
      <div id="payments-list"></div>
    </div>

    <!-- SEARCH TAB -->
    <div id="search-tab" class="tab-content">
      <div class="form-group"><label id="lbl-search-reg">Search by Registration Number</label><input type="text" id="search-input" placeholder="e.g., ABC-123" style="text-transform:uppercase"></div>
      <div class="form-group"><label id="lbl-filter-emp">Filter by Employee</label><select id="search-employee"><option value="">All Employees</option></select></div>
      <button class="btn btn-primary" onclick="performSearch()" id="btn-search">Search Records</button>
      <div id="search-results"></div>
    </div>

    <!-- ALL TAB -->
    <div id="all-tab" class="tab-content">
      <div class="stats"><div class="stat-item"><div class="stat-number" id="total-receipts">0</div><div class="stat-label" id="lbl-total-receipts">Total Receipts</div></div></div>
      <button class="btn btn-primary" onclick="loadAllReceipts()" style="margin-bottom:15px;" id="btn-refresh-all">↻ Refresh</button>
      <div id="all-receipts"></div>
    </div>

    <!-- PROFIT TAB -->
    <div id="profit-tab" class="tab-content">
      <h3 style="color:var(--text-1);margin-bottom:14px;font-weight:700;font-size:15px;letter-spacing:-0.2px;">◈ <span id="lbl-profit-title">Profit &amp; Loss</span></h3>
      <!-- Profit Style Switcher -->
      <div class="profit-style-bar">
        <button class="ps-btn active" onclick="setProfitStyle('cards',this)">⬛ Cards</button>
        <button class="ps-btn" onclick="setProfitStyle('gauge',this)">◉ Gauge</button>
        <button class="ps-btn" onclick="setProfitStyle('minimal',this)">— Minimal</button>
      </div>

      <!-- STYLE 1: Bento Cards (default) -->
      <div id="profit-style-cards" class="profit-view active-view">
        <div class="profit-bento">
          <div class="profit-card profit-card--revenue">
            <div class="pc-icon">↑</div>
            <div class="pc-label" id="lbl-tot-rev">Total Revenue</div>
            <div class="pc-value" id="profit-revenue">₨0</div>
            <div class="pc-bar"><div class="pc-bar-fill" style="width:100%;background:var(--accent);"></div></div>
          </div>
          <div class="profit-card profit-card--cost">
            <div class="pc-icon">↓</div>
            <div class="pc-label" id="lbl-purch-cost-p">Purchase Cost</div>
            <div class="pc-value" id="profit-purchase">₨0</div>
            <div class="pc-bar"><div class="pc-bar-fill" id="purchase-bar" style="width:0%;background:var(--danger);"></div></div>
          </div>
          <div class="profit-card profit-card--expenses">
            <div class="pc-icon">◎</div>
            <div class="pc-label" id="lbl-tot-exp">Total Expenses</div>
            <div class="pc-value" id="profit-expenses">₨0</div>
            <div class="pc-bar"><div class="pc-bar-fill" id="expense-bar" style="width:0%;background:var(--warn);"></div></div>
          </div>
          <div class="profit-card profit-card--margin">
            <div class="pc-icon">%</div>
            <div class="pc-label" id="lbl-profit-margin">Profit Margin</div>
            <div class="pc-value" id="profit-margin">0%</div>
            <div class="pc-ring-wrap">
              <svg class="pc-ring" viewBox="0 0 36 36">
                <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="var(--border)" stroke-width="3"/>
                <path id="ring-path" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="var(--accent)" stroke-width="3" stroke-dasharray="0, 100"/>
              </svg>
            </div>
          </div>
        </div>
        <!-- Net Profit Hero -->
        <div class="profit-hero">
          <div class="profit-hero-label" id="lbl-net-profit">Net Profit</div>
          <div class="profit-hero-value" id="profit-net">₨0</div>
          <div class="profit-hero-sub" id="profit-hero-tag">—</div>
        </div>
      </div>

      <!-- STYLE 2: Gauge -->
      <div id="profit-style-gauge" class="profit-view">
        <div class="gauge-wrap">
          <svg class="gauge-svg" viewBox="0 0 200 120">
            <defs>
              <linearGradient id="ggrad" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" style="stop-color:var(--danger)"/>
                <stop offset="50%" style="stop-color:var(--warn)"/>
                <stop offset="100%" style="stop-color:var(--accent)"/>
              </linearGradient>
            </defs>
            <!-- Track -->
            <path d="M20 100 A80 80 0 0 1 180 100" fill="none" stroke="var(--border)" stroke-width="14" stroke-linecap="round"/>
            <!-- Fill -->
            <path id="gauge-fill" d="M20 100 A80 80 0 0 1 180 100" fill="none" stroke="url(#ggrad)" stroke-width="14" stroke-linecap="round" stroke-dasharray="0 251.2"/>
            <!-- Needle -->
            <line id="gauge-needle" x1="100" y1="100" x2="100" y2="30" stroke="var(--text-1)" stroke-width="2" stroke-linecap="round" transform="rotate(0,100,100)"/>
            <circle cx="100" cy="100" r="5" fill="var(--accent)"/>
          </svg>
          <div class="gauge-value" id="gauge-margin-val">0%</div>
          <div class="gauge-label">Profit Margin</div>
        </div>
        <div class="gauge-stats">
          <div class="gs-item"><span class="gs-dot" style="background:var(--accent)"></span><span id="gs-rev">Revenue ₨0</span></div>
          <div class="gs-item"><span class="gs-dot" style="background:var(--danger)"></span><span id="gs-cost">Cost ₨0</span></div>
          <div class="gs-item"><span class="gs-dot" style="background:var(--warn)"></span><span id="gs-exp">Expenses ₨0</span></div>
          <div class="gs-item"><span class="gs-dot" style="background:var(--accent)"></span><strong id="gs-net" style="color:var(--accent)">Net ₨0</strong></div>
        </div>
      </div>

      <!-- STYLE 3: Minimal -->
      <div id="profit-style-minimal" class="profit-view">
        <div class="minimal-profit">
          <div class="mp-row"><span id="mp-rev-l">Revenue</span><span class="mp-val" id="mp-rev">₨0</span></div>
          <div class="mp-divider"></div>
          <div class="mp-row"><span id="mp-cost-l">Purchase</span><span class="mp-val danger" id="mp-cost">₨0</span></div>
          <div class="mp-row"><span id="mp-exp-l">Expenses</span><span class="mp-val danger" id="mp-exp">₨0</span></div>
          <div class="mp-divider accent"></div>
          <div class="mp-row mp-net"><span id="mp-net-l">Net Profit</span><span class="mp-val accent" id="mp-net">₨0</span></div>
          <div class="mp-margin-bar">
            <div class="mp-mb-fill" id="mp-mb-fill"></div>
            <span class="mp-mb-label" id="mp-mb-label">0%</span>
          </div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px;">
        <button class="btn btn-primary" onclick="exportSalesReport()" style="font-size:14px;">📊 <span id="lbl-exp-sales">Sales</span></button>
        <button class="btn btn-primary" onclick="exportProfitReport()" style="font-size:14px;">💵 <span id="lbl-exp-profit">Profit</span></button>
        <button class="btn btn-primary" onclick="exportPaymentReport()" style="font-size:14px;">💰 <span id="lbl-exp-payments">Payments</span></button>
        <button class="btn btn-primary" onclick="exportExpenseReport()" style="font-size:14px;">💸 <span id="lbl-exp-expenses">Expenses</span></button>
      </div>
      <button class="btn btn-primary" onclick="calculateProfit()" style="margin-bottom:15px;" id="btn-refresh-profit">↻ Refresh</button>
      <h4 style="color:var(--text-3);margin:16px 0 11px 0;font-weight:600;font-size:11px;letter-spacing:0.8px;text-transform:uppercase;" id="lbl-profit-by-car">Profit by Car</h4>
      <div id="profit-breakdown"></div>
    </div>

    <!-- ANALYTICS TAB -->
    <div id="analytics-tab" class="tab-content">
      <h3 style="color:#00D4FF;margin-bottom:20px;text-align:center;font-weight:800;">📊 <span id="lbl-analytics">Sales Analytics</span></h3>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:15px;margin-bottom:25px;">
        <div style="background:var(--surface2);padding:16px;border-radius:12px;color:var(--text-1);text-align:center;border:1px solid var(--border-hi);">
          <div style="font-size:28px;font-weight:700" id="total-cars">0</div>
          <div style="font-size:12px;margin-top:5px" id="lbl-total-cars">Total Cars Sold</div>
        </div>
        <div style="background:var(--surface2);padding:16px;border-radius:12px;color:var(--text-1);text-align:center;border:1px solid var(--accent2-hi);">
          <div style="font-size:22px;font-weight:700;word-break:break-all" id="total-revenue">₨0</div>
          <div style="font-size:12px;margin-top:5px" id="lbl-total-rev-a">Total Revenue</div>
        </div>
      </div>
      <div style="background:var(--surface2);padding:15px;border-radius:12px;margin-bottom:11px;border:1px solid var(--border);">
        <h4 style="color:#C9A84C;margin-bottom:15px;font-weight:700;">🏆 <span id="lbl-top-sales">Top Salespeople</span></h4>
        <div id="top-salespeople-list"></div>
      </div>
      <div style="background:var(--surface2);padding:15px;border-radius:12px;margin-bottom:11px;border:1px solid var(--border);">
        <h4 style="color:#C9A84C;margin-bottom:15px;font-weight:700;">🚗 <span id="lbl-best-cars">Best Selling Cars</span></h4>
        <div id="best-selling-list"></div>
      </div>
      <div style="background:var(--surface2);padding:15px;border-radius:12px;margin-bottom:11px;border:1px solid var(--border);">
        <h4 style="color:#C9A84C;margin-bottom:15px;font-weight:700;">📅 <span id="lbl-this-week">This Week</span></h4>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:15px;background:var(--surface2);border-radius:12px;border:1px solid var(--border);margin-bottom:14px;">
          <div><div style="font-size:12px;color:#666" id="lbl-cars-sold-w">Cars Sold</div><div style="font-size:24px;font-weight:700;color:#C9A84C;font-family:Georgia,'Times New Roman',serif;" id="week-cars">0</div></div>
          <div><div style="font-size:12px;color:#666" id="lbl-rev-w">Revenue</div><div style="font-size:22px;font-weight:700;color:var(--amber);word-break:break-all;letter-spacing:-0.3px;" id="week-revenue">₨0</div></div>
        </div>
      </div>
      <div style="background:var(--surface2);padding:15px;border-radius:12px;margin-bottom:11px;border:1px solid var(--border);">
        <h4 style="color:#C9A84C;margin-bottom:15px;font-weight:700;">📆 <span id="lbl-this-month">This Month</span></h4>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:15px;background:var(--surface2);border-radius:12px;border:1px solid var(--border);margin-bottom:14px;">
          <div><div style="font-size:12px;color:#666" id="lbl-cars-sold-m">Cars Sold</div><div style="font-size:24px;font-weight:700;color:#C9A84C;font-family:Georgia,'Times New Roman',serif;" id="month-cars">0</div></div>
          <div><div style="font-size:12px;color:#666" id="lbl-rev-m">Revenue</div><div style="font-size:22px;font-weight:700;color:var(--amber);word-break:break-all;letter-spacing:-0.3px;" id="month-revenue">₨0</div></div>
        </div>
      </div>
      <button class="btn btn-primary" onclick="calculateAnalytics()" style="margin-bottom:15px;" id="btn-refresh-analytics">↻ Refresh Analytics</button>
    </div>

    <div style="text-align:center;padding:20px 0 100px 0;color:var(--text-3);font-size:10px;font-weight:500;letter-spacing:2px;text-transform:uppercase;">Crafted by WM ❤️</div>

    <!-- BOTTOM NAV -->
    <div class="tab-buttons">
      <button class="tab-btn active" onclick="switchTab('upload',event)"><span class="tab-icon">⊕</span><span id="tab-upload">New Sale</span></button>
      <button class="tab-btn" onclick="switchTab('payments',event)"><span class="tab-icon">◎</span><span id="tab-payments">Payments</span><span class="badge hidden" id="payment-badge">0</span></button>
      <button class="tab-btn" onclick="switchTab('search',event)"><span class="tab-icon">⊙</span><span id="tab-search">Search</span></button>
      <button class="tab-btn" onclick="switchTab('all',event)"><span class="tab-icon">≡</span><span id="tab-all">Records</span></button>
      <button class="tab-btn" onclick="switchTab('profit',event)"><span class="tab-icon">◈</span><span id="tab-profit">Profit</span></button>
      <button class="tab-btn" onclick="switchTab('analytics',event)"><span class="tab-icon">⋯</span><span id="tab-analytics">Analytics</span></button>
    </div>
  </div>
</div>

<!-- RECEIPT MODAL -->
<div id="modal" class="modal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeModal()" id="btn-close-modal">✕ Close</button>
    <img id="modal-image" class="modal-image">
    <div style="text-align:center;margin-top:15px;">
      <div style="color:white;font-size:20px;font-weight:700" id="modal-reg"></div>
      <div style="color:white;font-size:14px;margin-top:5px" id="modal-details"></div>
      <div id="modal-installments" style="margin-top:15px;"></div>
      <div class="modal-actions">
        <button onclick="downloadReceipt()" id="btn-download" style="padding:9px 18px;background:rgba(16,185,129,0.12);color:#10B981;border:1px solid rgba(16,185,129,0.25);border-radius:9px;font-size:13px;font-weight:600;">⬇ Download</button>
        <button onclick="editReceipt()" id="btn-edit" style="padding:9px 18px;background:var(--accent-dim);color:var(--accent);border:1px solid var(--border-hi);border-radius:9px;font-size:13px;font-weight:600;">✎ Edit</button>
        <button onclick="openDriveLink()" id="btn-drive" style="padding:9px 18px;background:var(--accent2-dim);color:var(--accent2);border:1px solid var(--accent2-hi);border-radius:9px;font-size:13px;font-weight:600;">⬗ Drive</button>
        <button onclick="deleteReceipt()" id="btn-delete" class="delete-btn">✕ Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- EDIT MODAL -->
<div id="edit-modal" class="modal">
  <div class="modal-content" style="max-width:600px;">
    <button class="close-modal" onclick="closeEditModal()" id="btn-close-edit">✕ Close</button>
    <div style="background:var(--surface);padding:26px;border-radius:18px;margin-top:50px;border:1px solid var(--border-hi);">
      <h3 style="color:var(--text-1);margin-bottom:16px;font-weight:700;text-align:center;font-size:16px;letter-spacing:-0.2px;">✏️ <span id="lbl-edit-title">Edit Receipt</span></h3>
      <div class="success-msg" id="edit-success"></div>
      <div class="error-msg" id="edit-error"></div>
      <div class="form-group"><label id="lbl-edit-car">Car Name/Model</label><input type="text" id="edit-car-name"></div>
      <div class="form-group"><label id="lbl-edit-reg">Registration Number</label><input type="text" id="edit-reg-number" style="text-transform:uppercase"></div>
      <div class="form-group"><label id="lbl-edit-cust">Customer Name</label><input type="text" id="edit-customer-name"></div>
      <div class="form-group"><label id="lbl-edit-phone">Customer Phone</label><input type="text" id="edit-customer-phone"></div>
      <div class="form-group"><label id="lbl-edit-date">Selling Date</label><input type="date" id="edit-selling-date"></div>
      <div class="form-group"><label id="lbl-edit-price">Selling Price (PKR)</label><input type="number" id="edit-selling-price" min="0" step="1000"></div>
      <div class="form-group"><label id="lbl-edit-cost">Purchase Cost (PKR)</label><input type="number" id="edit-purchase-cost" min="0" step="1000"></div>
      <div class="form-group"><label id="lbl-edit-sold">Sold By</label><select id="edit-sold-by"><option value="">Select Employee</option></select></div>
      <button class="btn btn-primary" onclick="saveEditedReceipt()" id="btn-save-edit">💾 Save Changes</button>
      <button class="btn" onclick="closeEditModal()" id="btn-cancel-edit" style="background:#6c757d;color:white;margin-top:10px;">Cancel</button>
    </div>
  </div>
</div>

<script>
const CONFIG = {
  PASSWORD: 'hasnain123',
  SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbzAaxqPHhGV9sLotNqpSLQXNliyZJyqywB31WGOUOmxRYHgF2zA8_ZDQYKqSSDk_PjDEA/exec'
};

// ===================== FULL TRANSLATIONS =====================
const LANG = {
  en: {
    'login-title':'🚗 CAR SHOWROOM MANAGER','login-sub':'Premium Sales Management System',
    'lbl-password':'Password','btn-login':'🔓 Login','login-error':'❌ Incorrect password',
    'header-title':'🚗 CAR SHOWROOM MANAGER','lbl-overdue':'Overdue',
    'lbl-employees':'Employees','lbl-logout':'Logout','lang-text':'اردو',
    'lbl-install':'📱 Install this app for easier access!','btn-install':'Install',
    'lbl-car-name':'Car Name/Model *','lbl-reg-number':'Car Registration Number *',
    'lbl-cust-name':'Customer Name *','lbl-cust-phone':'Customer Phone *',
    'lbl-sell-date':'Selling Date *','lbl-sell-price':'Selling Price (PKR) *',
    'lbl-purch-cost':'Purchase Cost (PKR) *',
    'lbl-purch-hint':'💡 How much did you pay to buy this car?',
    'lbl-expenses':'Additional Expenses (Optional)',
    'lbl-exp-hint':'Repairs, maintenance, modifications, etc.',
    'btn-add-expense':'➕ Add Expense','lbl-pay-type':'Payment Type *',
    'lbl-cash':'Cash (Full Payment)','lbl-inst':'Installment',
    'lbl-down':'Down Payment (PKR) *','lbl-inst-count':'Number of Installments *',
    'lbl-sold-by':'Sold By (Employee) *','lbl-receipt-photo':'Receipt Photo *',
    'btn-save-receipt':'💾 Save Receipt',
    'lbl-pay-track':'Payment Tracking','lbl-overdue-title':'⚠️ Overdue Payments!',
    'lbl-upcoming-title':'📅 Upcoming Payments',
    'lbl-total-pending':'Total Pending','lbl-total-received':'Total Received',
    'btn-refresh-pay':'🔄 Refresh',
    'lbl-search-reg':'Search by Registration Number','lbl-filter-emp':'Filter by Employee',
    'btn-search':'🔍 Search',
    'lbl-total-receipts':'Total Receipts','btn-refresh-all':'🔄 Refresh',
    'lbl-profit-title':'Profit & Loss','lbl-tot-rev':'Total Revenue',
    'lbl-purch-cost-p':'Purchase Cost','lbl-tot-exp':'Total Expenses',
    'lbl-profit-margin':'Profit Margin','lbl-net-profit':'Net Profit',
    'lbl-exp-sales':'Sales','lbl-exp-profit':'Profit',
    'lbl-exp-payments':'Payments','lbl-exp-expenses':'Expenses',
    'btn-refresh-profit':'🔄 Refresh','lbl-profit-by-car':'Profit by Car',
    'lbl-analytics':'Sales Analytics','lbl-total-cars':'Total Cars Sold',
    'lbl-total-rev-a':'Total Revenue','lbl-top-sales':'Top Salespeople',
    'lbl-best-cars':'Best Selling Cars','lbl-this-week':'This Week',
    'lbl-this-month':'This Month','lbl-cars-sold-w':'Cars Sold','lbl-rev-w':'Revenue',
    'lbl-cars-sold-m':'Cars Sold','lbl-rev-m':'Revenue',
    'btn-refresh-analytics':'🔄 Refresh Analytics',
    'btn-close-modal':'✕ Close','btn-download':'💾 Download',
    'btn-edit':'✏️ Edit','btn-drive':'📁 Drive','btn-delete':'🗑️ Delete',
    'btn-close-edit':'✕ Close','lbl-edit-title':'Edit Receipt',
    'lbl-edit-car':'Car Name/Model','lbl-edit-reg':'Registration Number',
    'lbl-edit-cust':'Customer Name','lbl-edit-phone':'Customer Phone',
    'lbl-edit-date':'Selling Date','lbl-edit-price':'Selling Price (PKR)',
    'lbl-edit-cost':'Purchase Cost (PKR)','lbl-edit-sold':'Sold By',
    'btn-save-edit':'💾 Save Changes','btn-cancel-edit':'Cancel',
    'tab-upload':'Upload','tab-payments':'Payments','tab-search':'Search',
    'tab-all':'All','tab-profit':'Profit','tab-analytics':'Stats'
  },
  ur: {
    'login-title':'🚗 کار شو روم مینیجر','login-sub':'پریمیم سیلز مینجمنٹ سسٹم',
    'lbl-password':'پاس ورڈ','btn-login':'🔓 لاگ ان','login-error':'❌ غلط پاس ورڈ',
    'header-title':'🚗 کار شو روم مینیجر','lbl-overdue':'ادائیگی باقی',
    'lbl-employees':'ملازمین','lbl-logout':'لاگ آؤٹ','lang-text':'English',
    'lbl-install':'📱 آسان رسائی کے لیے انسٹال کریں!','btn-install':'انسٹال',
    'lbl-car-name':'گاڑی کا نام/ماڈل *','lbl-reg-number':'رجسٹریشن نمبر *',
    'lbl-cust-name':'گاہک کا نام *','lbl-cust-phone':'گاہک کا فون *',
    'lbl-sell-date':'فروخت کی تاریخ *','lbl-sell-price':'فروخت کی قیمت (PKR) *',
    'lbl-purch-cost':'خریداری کی قیمت (PKR) *',
    'lbl-purch-hint':'💡 آپ نے یہ گاڑی کتنے میں خریدی؟',
    'lbl-expenses':'اضافی اخراجات (اختیاری)',
    'lbl-exp-hint':'مرمت، دیکھ بھال، تبدیلیاں وغیرہ',
    'btn-add-expense':'➕ اخراجات شامل کریں','lbl-pay-type':'ادائیگی کی قسم *',
    'lbl-cash':'نقد (مکمل ادائیگی)','lbl-inst':'قسطیں',
    'lbl-down':'پیشگی ادائیگی (PKR) *','lbl-inst-count':'قسطوں کی تعداد *',
    'lbl-sold-by':'فروخت کنندہ (ملازم) *','lbl-receipt-photo':'رسید کی تصویر *',
    'btn-save-receipt':'💾 رسید محفوظ کریں',
    'lbl-pay-track':'ادائیگی ٹریکنگ','lbl-overdue-title':'⚠️ ادائیگی میں تاخیر!',
    'lbl-upcoming-title':'📅 آنے والی ادائیگیاں',
    'lbl-total-pending':'کل باقی','lbl-total-received':'کل وصول شدہ',
    'btn-refresh-pay':'🔄 تازہ کریں',
    'lbl-search-reg':'رجسٹریشن نمبر سے تلاش','lbl-filter-emp':'ملازم سے فلٹر کریں',
    'btn-search':'🔍 تلاش',
    'lbl-total-receipts':'کل رسیدیں','btn-refresh-all':'🔄 تازہ کریں',
    'lbl-profit-title':'منافع اور نقصان','lbl-tot-rev':'کل آمدنی',
    'lbl-purch-cost-p':'خریداری کی لاگت','lbl-tot-exp':'کل اخراجات',
    'lbl-profit-margin':'منافع کا مارجن','lbl-net-profit':'خالص منافع',
    'lbl-exp-sales':'فروخت','lbl-exp-profit':'منافع',
    'lbl-exp-payments':'ادائیگیاں','lbl-exp-expenses':'اخراجات',
    'btn-refresh-profit':'🔄 تازہ کریں','lbl-profit-by-car':'گاڑی کے لحاظ سے منافع',
    'lbl-analytics':'سیلز تجزیہ','lbl-total-cars':'کل فروخت شدہ گاڑیاں',
    'lbl-total-rev-a':'کل آمدنی','lbl-top-sales':'اعلیٰ فروخت کنندگان',
    'lbl-best-cars':'سب سے زیادہ فروخت ہونے والی گاڑیاں',
    'lbl-this-week':'اس ہفتے','lbl-this-month':'اس مہینے',
    'lbl-cars-sold-w':'فروخت شدہ گاڑیاں','lbl-rev-w':'آمدنی',
    'lbl-cars-sold-m':'فروخت شدہ گاڑیاں','lbl-rev-m':'آمدنی',
    'btn-refresh-analytics':'🔄 تجزیہ تازہ کریں',
    'btn-close-modal':'✕ بند کریں','btn-download':'💾 ڈاؤن لوڈ',
    'btn-edit':'✏️ ترمیم','btn-drive':'📁 ڈرائیو','btn-delete':'🗑️ حذف کریں',
    'btn-close-edit':'✕ بند کریں','lbl-edit-title':'رسید میں ترمیم',
    'lbl-edit-car':'گاڑی کا نام/ماڈل','lbl-edit-reg':'رجسٹریشن نمبر',
    'lbl-edit-cust':'گاہک کا نام','lbl-edit-phone':'گاہک کا فون',
    'lbl-edit-date':'فروخت کی تاریخ','lbl-edit-price':'فروخت کی قیمت (PKR)',
    'lbl-edit-cost':'خریداری کی قیمت (PKR)','lbl-edit-sold':'فروخت کنندہ',
    'btn-save-edit':'💾 تبدیلیاں محفوظ کریں','btn-cancel-edit':'منسوخ کریں',
    'tab-upload':'اپ لوڈ','tab-payments':'ادائیگیاں','tab-search':'تلاش',
    'tab-all':'تمام','tab-profit':'منافع','tab-analytics':'اعدادوشمار'
  ,
  ar: {
    'login-title':'🚗 مدير صالة عرض السيارات','login-sub':'نظام إدارة المبيعات المتميز',
    'lbl-password':'كلمة المرور','btn-login':'🔓 تسجيل الدخول','login-error':'❌ كلمة مرور غير صحيحة',
    'header-title':'🚗 مدير صالة العرض','lbl-overdue':'متأخر',
    'lbl-employees':'الموظفون','lbl-logout':'تسجيل الخروج','lang-text':'EN',
    'lbl-install':'📱 ثبّت التطبيق للوصول السريع!','btn-install':'تثبيت',
    'lbl-car-name':'اسم السيارة / الموديل *','lbl-reg-number':'رقم التسجيل *',
    'lbl-cust-name':'اسم العميل *','lbl-cust-phone':'هاتف العميل *',
    'lbl-sell-date':'تاريخ البيع *','lbl-sell-price':'سعر البيع (ر.س) *',
    'lbl-purch-cost':'تكلفة الشراء (ر.س) *','lbl-purch-hint':'💡 كم دفعت لشراء هذه السيارة؟',
    'lbl-expenses':'مصاريف إضافية (اختياري)','lbl-exp-hint':'إصلاحات، صيانة، تعديلات...',
    'btn-add-expense':'➕ إضافة مصروف','lbl-pay-type':'نوع الدفع *',
    'lbl-cash':'نقداً (دفع كامل)','lbl-inst':'أقساط',
    'lbl-down':'الدفعة الأولى (ر.س) *','lbl-inst-count':'عدد الأقساط *',
    'lbl-sold-by':'بيع بواسطة (الموظف) *','lbl-receipt-photo':'صورة الإيصال *',
    'btn-save-receipt':'💾 حفظ الإيصال','lbl-pay-track':'تتبع المدفوعات',
    'lbl-overdue-title':'⚠️ مدفوعات متأخرة!','lbl-upcoming-title':'📅 مدفوعات قادمة',
    'lbl-total-pending':'إجمالي المعلق','lbl-total-received':'إجمالي المستلم',
    'btn-refresh-pay':'↻ تحديث','lbl-search-reg':'بحث برقم التسجيل','lbl-filter-emp':'تصفية حسب الموظف',
    'btn-search':'🔍 بحث','lbl-total-receipts':'إجمالي الإيصالات','btn-refresh-all':'↻ تحديث',
    'lbl-profit-title':'الأرباح والخسائر','lbl-tot-rev':'إجمالي الإيرادات',
    'lbl-purch-cost-p':'تكلفة الشراء','lbl-tot-exp':'إجمالي المصاريف',
    'lbl-profit-margin':'هامش الربح','lbl-net-profit':'صافي الربح',
    'lbl-exp-sales':'المبيعات','lbl-exp-profit':'الأرباح','lbl-exp-payments':'المدفوعات','lbl-exp-expenses':'المصاريف',
    'btn-refresh-profit':'↻ تحديث','lbl-profit-by-car':'الربح حسب السيارة',
    'lbl-analytics':'تحليلات المبيعات','lbl-total-cars':'إجمالي السيارات المباعة',
    'lbl-total-rev-a':'إجمالي الإيرادات','lbl-top-sales':'أفضل البائعين','lbl-best-cars':'أكثر السيارات مبيعاً',
    'lbl-this-week':'هذا الأسبوع','lbl-this-month':'هذا الشهر',
    'lbl-cars-sold-w':'سيارات مباعة','lbl-rev-w':'الإيرادات','lbl-cars-sold-m':'سيارات مباعة','lbl-rev-m':'الإيرادات',
    'btn-refresh-analytics':'↻ تحديث التحليلات',
    'btn-close-modal':'✕ إغلاق','btn-download':'💾 تنزيل','btn-edit':'✎ تعديل','btn-drive':'⬗ درايف','btn-delete':'✕ حذف',
    'btn-close-edit':'✕ إغلاق','lbl-edit-title':'تعديل الإيصال',
    'lbl-edit-car':'اسم السيارة','lbl-edit-reg':'رقم التسجيل','lbl-edit-cust':'اسم العميل',
    'lbl-edit-phone':'هاتف العميل','lbl-edit-date':'تاريخ البيع','lbl-edit-price':'سعر البيع (ر.س)',
    'lbl-edit-cost':'تكلفة الشراء (ر.س)','lbl-edit-sold':'بيع بواسطة',
    'btn-save-edit':'💾 حفظ التغييرات','btn-cancel-edit':'إلغاء',
    'tab-upload':'بيع جديد','tab-payments':'المدفوعات','tab-search':'بحث',
    'tab-all':'السجلات','tab-profit':'الأرباح','tab-analytics':'إحصائيات'
  },
  sd: {
    'login-title':'🚗 ڪار شوروم مئنيجر','login-sub':'پريميم سيلز مئنيجمينٽ سسٽم',
    'lbl-password':'پاسورڊ','btn-login':'🔓 لاگ ان','login-error':'❌ غلط پاسورڊ',
    'header-title':'🚗 ڪار شوروم مئنيجر','lbl-overdue':'دير ٿيل',
    'lbl-employees':'ملازم','lbl-logout':'لاگ آئوٽ','lang-text':'EN',
    'lbl-install':'📱 آسان رسائي لاءِ انسٽال ڪريو!','btn-install':'انسٽال',
    'lbl-car-name':'گاڏيءَ جو نالو / ماڊل *','lbl-reg-number':'رجسٽريشن نمبر *',
    'lbl-cust-name':'گراهڪ جو نالو *','lbl-cust-phone':'گراهڪ جو فون *',
    'lbl-sell-date':'وڪري جي تاريخ *','lbl-sell-price':'وڪري جي قيمت (PKR) *',
    'lbl-purch-cost':'خريداري جي قيمت (PKR) *','lbl-purch-hint':'💡 هيءَ گاڏي خريد ڪرڻ تي ڪيترو ڏنو؟',
    'lbl-expenses':'اضافي خرچا (اختياري)','lbl-exp-hint':'مرمت، سار سنڀال، تبديليون...',
    'btn-add-expense':'➕ خرچو شامل ڪريو','lbl-pay-type':'ادائيگي جو قسم *',
    'lbl-cash':'نقد (مڪمل ادائيگي)','lbl-inst':'قسطون',
    'lbl-down':'پهرين ادائيگي (PKR) *','lbl-inst-count':'قسطن جو تعداد *',
    'lbl-sold-by':'فروخت ڪندڙ (ملازم) *','lbl-receipt-photo':'رسيد جي تصوير *',
    'btn-save-receipt':'💾 رسيد محفوظ ڪريو','lbl-pay-track':'ادائيگي ٽريڪنگ',
    'lbl-overdue-title':'⚠️ دير ٿيل ادائيگيون!','lbl-upcoming-title':'📅 ايندڙ ادائيگيون',
    'lbl-total-pending':'ڪل باقي','lbl-total-received':'ڪل وصول ٿيل',
    'btn-refresh-pay':'↻ تازو ڪريو','lbl-search-reg':'رجسٽريشن نمبر سان ڳوليو','lbl-filter-emp':'ملازم سان فلٽر',
    'btn-search':'🔍 ڳوليو','lbl-total-receipts':'ڪل رسيدون','btn-refresh-all':'↻ تازو ڪريو',
    'lbl-profit-title':'نفعو ۽ نقصان','lbl-tot-rev':'ڪل آمدني',
    'lbl-purch-cost-p':'خريداري جي لاڳت','lbl-tot-exp':'ڪل خرچا',
    'lbl-profit-margin':'نفعي جو مارجن','lbl-net-profit':'خالص نفعو',
    'lbl-exp-sales':'وڪري','lbl-exp-profit':'نفعو','lbl-exp-payments':'ادائيگيون','lbl-exp-expenses':'خرچا',
    'btn-refresh-profit':'↻ تازو ڪريو','lbl-profit-by-car':'گاڏي مطابق نفعو',
    'lbl-analytics':'سيلز تجزيو','lbl-total-cars':'ڪل فروخت ٿيل گاڏيون',
    'lbl-total-rev-a':'ڪل آمدني','lbl-top-sales':'بهترين سيلزمئن','lbl-best-cars':'سڀ کان وڌيڪ وڪامل گاڏيون',
    'lbl-this-week':'هن هفتي','lbl-this-month':'هن مهيني',
    'lbl-cars-sold-w':'فروخت ٿيل گاڏيون','lbl-rev-w':'آمدني','lbl-cars-sold-m':'فروخت ٿيل گاڏيون','lbl-rev-m':'آمدني',
    'btn-refresh-analytics':'↻ تجزيو تازو ڪريو',
    'btn-close-modal':'✕ بند ڪريو','btn-download':'💾 ڊائونلوڊ','btn-edit':'✎ ترميم','btn-drive':'⬗ ڊرائيو','btn-delete':'✕ ڊليٽ',
    'btn-close-edit':'✕ بند ڪريو','lbl-edit-title':'رسيد ۾ ترميم',
    'lbl-edit-car':'گاڏيءَ جو نالو','lbl-edit-reg':'رجسٽريشن نمبر','lbl-edit-cust':'گراهڪ جو نالو',
    'lbl-edit-phone':'گراهڪ جو فون','lbl-edit-date':'وڪري جي تاريخ','lbl-edit-price':'وڪري جي قيمت (PKR)',
    'lbl-edit-cost':'خريداري جي قيمت (PKR)','lbl-edit-sold':'فروخت ڪندڙ',
    'btn-save-edit':'💾 تبديليون محفوظ ڪريو','btn-cancel-edit':'منسوخ',
    'tab-upload':'نئون وڪرو','tab-payments':'ادائيگيون','tab-search':'ڳولا',
    'tab-all':'رڪارڊ','tab-profit':'نفعو','tab-analytics':'اعداد شمار'
  },
  fa: {
    'login-title':'🚗 مدیر نمایشگاه خودرو','login-sub':'سیستم مدیریت فروش حرفه‌ای',
    'lbl-password':'رمز عبور','btn-login':'🔓 ورود','login-error':'❌ رمز عبور اشتباه است',
    'header-title':'🚗 مدیر نمایشگاه خودرو','lbl-overdue':'معوقه',
    'lbl-employees':'کارمندان','lbl-logout':'خروج','lang-text':'EN',
    'lbl-install':'📱 برای دسترسی آسان نصب کنید!','btn-install':'نصب',
    'lbl-car-name':'نام/مدل خودرو *','lbl-reg-number':'شماره پلاک *',
    'lbl-cust-name':'نام مشتری *','lbl-cust-phone':'تلفن مشتری *',
    'lbl-sell-date':'تاریخ فروش *','lbl-sell-price':'قیمت فروش (تومان) *',
    'lbl-purch-cost':'هزینه خرید (تومان) *','lbl-purch-hint':'💡 این خودرو را به چه قیمتی خریدید؟',
    'lbl-expenses':'هزینه‌های اضافی (اختیاری)','lbl-exp-hint':'تعمیرات، نگهداری، تغییرات...',
    'btn-add-expense':'➕ افزودن هزینه','lbl-pay-type':'نوع پرداخت *',
    'lbl-cash':'نقدی (پرداخت کامل)','lbl-inst':'اقساط',
    'lbl-down':'پیش پرداخت (تومان) *','lbl-inst-count':'تعداد اقساط *',
    'lbl-sold-by':'فروشنده (کارمند) *','lbl-receipt-photo':'عکس رسید *',
    'btn-save-receipt':'💾 ذخیره رسید','lbl-pay-track':'پیگیری پرداخت‌ها',
    'lbl-overdue-title':'⚠️ پرداخت‌های معوقه!','lbl-upcoming-title':'📅 پرداخت‌های پیش رو',
    'lbl-total-pending':'کل معلق','lbl-total-received':'کل دریافتی',
    'btn-refresh-pay':'↻ بروزرسانی','lbl-search-reg':'جستجو با شماره پلاک','lbl-filter-emp':'فیلتر بر اساس کارمند',
    'btn-search':'🔍 جستجو','lbl-total-receipts':'کل رسیدها','btn-refresh-all':'↻ بروزرسانی',
    'lbl-profit-title':'سود و زیان','lbl-tot-rev':'کل درآمد',
    'lbl-purch-cost-p':'هزینه خرید','lbl-tot-exp':'کل هزینه‌ها',
    'lbl-profit-margin':'حاشیه سود','lbl-net-profit':'سود خالص',
    'lbl-exp-sales':'فروش','lbl-exp-profit':'سود','lbl-exp-payments':'پرداخت‌ها','lbl-exp-expenses':'هزینه‌ها',
    'btn-refresh-profit':'↻ بروزرسانی','lbl-profit-by-car':'سود بر اساس خودرو',
    'lbl-analytics':'تحلیل فروش','lbl-total-cars':'کل خودروهای فروخته شده',
    'lbl-total-rev-a':'کل درآمد','lbl-top-sales':'برترین فروشندگان','lbl-best-cars':'پرفروش‌ترین خودروها',
    'lbl-this-week':'این هفته','lbl-this-month':'این ماه',
    'lbl-cars-sold-w':'خودرو فروخته شده','lbl-rev-w':'درآمد','lbl-cars-sold-m':'خودرو فروخته شده','lbl-rev-m':'درآمد',
    'btn-refresh-analytics':'↻ بروزرسانی تحلیل‌ها',
    'btn-close-modal':'✕ بستن','btn-download':'💾 دانلود','btn-edit':'✎ ویرایش','btn-drive':'⬗ درایو','btn-delete':'✕ حذف',
    'btn-close-edit':'✕ بستن','lbl-edit-title':'ویرایش رسید',
    'lbl-edit-car':'نام/مدل خودرو','lbl-edit-reg':'شماره پلاک','lbl-edit-cust':'نام مشتری',
    'lbl-edit-phone':'تلفن مشتری','lbl-edit-date':'تاریخ فروش','lbl-edit-price':'قیمت فروش (تومان)',
    'lbl-edit-cost':'هزینه خرید (تومان)','lbl-edit-sold':'فروشنده',
    'btn-save-edit':'💾 ذخیره تغییرات','btn-cancel-edit':'لغو',
    'tab-upload':'فروش جدید','tab-payments':'پرداخت‌ها','tab-search':'جستجو',
    'tab-all':'سوابق','tab-profit':'سود','tab-analytics':'آمار'
  }  }
};

let currentLang = localStorage.getItem('lang') || 'en';
let employeesList = JSON.parse(localStorage.getItem('employees')) || [];
let currentViewingReceipt = null;
let allReceiptsCache = [];
let allInstallmentsCache = [];
let allExpensesCache = [];
let expenseFieldCount = 0;
let deferredPrompt;

// ===================== LANGUAGE =====================
function applyLanguage() {
  const t = LANG[currentLang];
  const isRTL = ['ur','ar','sd','fa'].includes(currentLang);
  document.body.classList.toggle('urdu', isRTL);
  // Show current language name on button
  const names = {en:'EN',ur:'اردو',ar:'عربي',sd:'سنڌي',fa:'فارسی'};
  const lbtn = document.getElementById('lang-text');
  if(lbtn) lbtn.textContent = names[currentLang] || 'EN';
  // update every translatable element by id
  Object.keys(t).forEach(id => {
    const el = document.getElementById(id);
    if (el) el.innerHTML = t[id];
  });
}

function toggleLanguage() {
  // Cycle through all languages
  const langs = ['en','ur','ar','sd','fa'];
  const idx = langs.indexOf(currentLang);
  currentLang = langs[(idx+1) % langs.length];
  localStorage.setItem('lang', currentLang);
  applyLanguage();
}

// ===================== EMPLOYEES =====================
function loadEmployeesIntoDropdowns() {
  ['sold-by','search-employee'].forEach(id => {
    const sel = document.getElementById(id);
    if (!sel) return;
    const first = sel.options[0].textContent;
    sel.innerHTML = `<option value="">${first}</option>`;
    employeesList.forEach(e => { const o = document.createElement('option'); o.value = o.textContent = e; sel.appendChild(o); });
  });
}

function manageEmployees() {
  const a = prompt('👥 Manage Employees\n\n1 - View All\n2 - Add New\n3 - Remove\n\nEnter choice (1/2/3):');
  if (a === '1') { alert(employeesList.length ? 'Employees:\n' + employeesList.join('\n') : 'No employees yet.'); }
  else if (a === '2') {
    const n = prompt('Enter employee name:');
    if (n && n.trim() && !employeesList.includes(n.trim())) {
      employeesList.push(n.trim()); employeesList.sort();
      localStorage.setItem('employees', JSON.stringify(employeesList));
      loadEmployeesIntoDropdowns(); alert('✅ Added: ' + n.trim());
    }
  } else if (a === '3') {
    const r = prompt('Remove:\n' + employeesList.join('\n') + '\n\nEnter name:');
    const i = employeesList.indexOf(r && r.trim());
    if (i > -1) { employeesList.splice(i,1); localStorage.setItem('employees', JSON.stringify(employeesList)); loadEmployeesIntoDropdowns(); alert('✅ Removed'); }
  }
}

// ===================== EXPENSES =====================
function addExpenseField() {
  expenseFieldCount++;
  const c = document.getElementById('expenses-container');
  const d = document.createElement('div');
  d.className = 'installment-item'; d.id = 'expense-' + expenseFieldCount; d.style.marginBottom = '10px';
  d.innerHTML = `<div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
    <select id="expense-type-${expenseFieldCount}" style="flex:1;min-width:90px;">
      <option value="Repair">Repair</option><option value="Maintenance">Maintenance</option>
      <option value="Modification">Modification</option><option value="Other">Other</option>
    </select>
    <input type="text" id="expense-desc-${expenseFieldCount}" placeholder="Description" style="flex:2;min-width:100px;">
    <input type="number" id="expense-amount-${expenseFieldCount}" placeholder="Amount" min="0" step="1000" style="flex:1;min-width:80px;">
    <button type="button" onclick="removeExpenseField(${expenseFieldCount})" class="delete-btn" style="padding:8px 12px;">✕</button>
  </div>`;
  c.appendChild(d);
}
function removeExpenseField(id) { const el = document.getElementById('expense-'+id); if(el) el.remove(); }

// ===================== PWA =====================
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
  // Update install button to show it's available
  const btn = document.getElementById('install-inline-btn');
  if (btn) {
    btn.querySelector('.iib-title').textContent = 'Install on this Device';
    btn.querySelector('.iib-sub').textContent = 'Tap to add to home screen';
    btn.disabled = false;
  }
});
// iOS — always show hint option
(function() {
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  if (isIOS) {
    const btn = document.getElementById('install-inline-btn');
    if (btn) {
      btn.querySelector('.iib-title').textContent = 'Install on iPhone/iPad';
      btn.querySelector('.iib-sub').textContent = 'Tap to see instructions';
    }
  }
})();
function installApp() {
  // iOS Safari — show manual instructions
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
  const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
  if (isIOS || isSafari) {
    const hint = document.getElementById('ios-hint');
    if (hint) { hint.style.display = hint.style.display === 'none' ? 'block' : 'none'; }
    return;
  }
  // Android/Chrome — native prompt
  if (deferredPrompt) {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(choice => {
      if (choice.outcome === 'accepted') {
        const btn = document.getElementById('install-inline-btn');
        if (btn) { btn.disabled = true; btn.querySelector('.iib-title').textContent = '✓ App Installed!'; }
      }
      deferredPrompt = null;
    });
  } else {
    // Already installed or not supported
    const btn = document.getElementById('install-inline-btn');
    if (btn) btn.querySelector('.iib-sub').textContent = 'Already installed or not supported on this browser';
  }
}
if ('serviceWorker' in navigator) {
  // Generate SW and manifest inline so they work from ANY hosting (GitHub Pages, etc.)
  // Create inline service worker
  const swCode = `
const CACHE = 'elite-auto-v2';
const ASSETS = [location.href];
self.addEventListener('install', e => {
  e.waitUntil(caches.open(CACHE).then(cache => cache.addAll(ASSETS)).catch(()=>{}));
  self.skipWaiting();
});
self.addEventListener('activate', e => {
  e.waitUntil(caches.keys().then(keys => Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k)))));
  self.clients.claim();
});
self.addEventListener('fetch', e => {
  e.respondWith(caches.match(e.request).then(r => r || fetch(e.request).catch(()=>caches.match(e.request))));
});
  `;
  const blob = new Blob([swCode], {type:'application/javascript'});
  const swURL = URL.createObjectURL(blob);
  navigator.serviceWorker.register(swURL).then(reg => {
    console.log('SW registered (inline)');
  }).catch(err => {
    // Fallback to file-based
    navigator.serviceWorker.register('sw.js').catch(()=>{});
  });
}

// Auto-generate manifest if manifest.json is missing
fetch('manifest.json').catch(() => {
  const manifest = {
    name: 'Elite Auto Manager',
    short_name: 'AutoMgr',
    description: 'Premium Car Showroom Management System',
    start_url: location.href,
    display: 'standalone',
    background_color: '#0D0F14',
    theme_color: '#0D0F14',
    orientation: 'portrait-primary',
    icons: [
      { src: 'data:image/svg+xml,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 192 192"><rect width="192" height="192" rx="40" fill="#0D0F14"/><circle cx="96" cy="96" r="70" fill="none" stroke="#8B5CF6" stroke-width="4" opacity=".4"/><path d="M56 110h80M62 110l10-25h48l10 25M72 110v8M120 110v8M65 85h62" stroke="#8B5CF6" stroke-width="6" stroke-linecap="round" fill="none"/></svg>`), sizes: '192x192', type: 'image/svg+xml' },
      { src: 'data:image/svg+xml,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><rect width="512" height="512" rx="100" fill="#0D0F14"/><circle cx="256" cy="256" r="185" fill="none" stroke="#8B5CF6" stroke-width="8" opacity=".4"/><path d="M140 290h232M158 290l28-68h140l28 68M190 290v24M322 290v24M165 222h182" stroke="#8B5CF6" stroke-width="18" stroke-linecap="round" fill="none"/></svg>`), sizes: '512x512', type: 'image/svg+xml' }
    ]
  };
  // Inject manifest dynamically
  const blob = new Blob([JSON.stringify(manifest)], {type:'application/manifest+json'});
  const url = URL.createObjectURL(blob);
  let link = document.querySelector('link[rel="manifest"]');
  if(!link) { link = document.createElement('link'); link.rel = 'manifest'; document.head.appendChild(link); }
  link.href = url;
});

// ===================== INIT =====================
document.addEventListener('DOMContentLoaded', () => {
  checkLogin(); applyLanguage(); loadEmployeesIntoDropdowns();
  document.getElementById('receipt-photo').addEventListener('change', e => {
    const f = e.target.files[0];
    if (f) { const r = new FileReader(); r.onload = ev => { const p = document.getElementById('preview'); p.src = ev.target.result; p.style.display = 'block'; }; r.readAsDataURL(f); }
  });
  document.getElementById('login-password').addEventListener('keyup', e => { if(e.key==='Enter') login(); });
  document.getElementById('selling-date').value = new Date().toISOString().split('T')[0];
});

function checkLogin() { if(sessionStorage.getItem('loggedIn')==='true') showMainApp(); else showLoginScreen(); }
function login() {
  const pw = document.getElementById('login-password').value;
  const err = document.getElementById('login-error');
  if (pw === CONFIG.PASSWORD) { sessionStorage.setItem('loggedIn','true'); showMainApp(); }
  else { err.textContent = LANG[currentLang]['login-error'] || '❌ Incorrect password'; err.style.display = 'block'; }
}
function logout() { sessionStorage.removeItem('loggedIn'); showLoginScreen(); }
function showLoginScreen() { document.getElementById('login-screen').classList.remove('hidden'); document.getElementById('main-app').classList.add('hidden'); }
function showMainApp() { document.getElementById('login-screen').classList.add('hidden'); document.getElementById('main-app').classList.remove('hidden'); loadAllReceipts(); loadPayments(); }

function switchTab(tab, ev) {
  if (ev) { document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); ev.target.closest('.tab-btn').classList.add('active'); }
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.getElementById(tab+'-tab').classList.add('active');
  if (tab==='all') loadAllReceipts();
  else if (tab==='analytics') calculateAnalytics();
  else if (tab==='payments') loadPayments();
  else if (tab==='profit') calculateProfit();
}
function switchTabDirect(tab) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.getElementById(tab+'-tab').classList.add('active');
  if (tab==='payments') loadPayments();
}

function toggleInstallmentSection() {
  const pt = document.querySelector('input[name="payment-type"]:checked').value;
  document.getElementById('installment-section').style.display = pt==='INSTALLMENT' ? 'block' : 'none';
  if (pt==='INSTALLMENT') generateInstallmentFields();
}
function generateInstallmentFields() {
  const cnt = parseInt(document.getElementById('installment-count').value);
  let h = '<h4 style="color:#00D4FF;margin:15px 0 10px 0;font-weight:700;">Installment Details:</h4>';
  for (let i=1; i<=cnt; i++) {
    h += `<div class="installment-item"><strong>Installment ${i}</strong>
      <div class="form-group"><label>Due Date</label><input type="date" id="inst-date-${i}"></div>
      <div class="form-group"><label>Amount (PKR)</label><input type="number" id="inst-amount-${i}" placeholder="Amount" min="0" step="1000"></div></div>`;
  }
  document.getElementById('installment-fields').innerHTML = h;
}

// ===================== UPLOAD =====================
async function uploadReceipt() {
  const v = {
    carName: document.getElementById('car-name').value.trim(),
    regNumber: document.getElementById('reg-number').value.trim().toUpperCase(),
    customerName: document.getElementById('customer-name').value.trim(),
    customerPhone: document.getElementById('customer-phone').value.trim(),
    sellingDate: document.getElementById('selling-date').value,
    sellingPrice: document.getElementById('selling-price').value.trim(),
    purchaseCost: document.getElementById('purchase-cost').value.trim(),
    soldBy: document.getElementById('sold-by').value
  };
  const expenses = [];
  for (let i=1; i<=expenseFieldCount; i++) {
    const tEl=document.getElementById(`expense-type-${i}`), dEl=document.getElementById(`expense-desc-${i}`), aEl=document.getElementById(`expense-amount-${i}`);
    if (tEl&&dEl&&aEl) { const amt=parseFloat(aEl.value)||0; if(amt>0) expenses.push({type:tEl.value, description:dEl.value.trim()||'No description', amount:amt}); }
  }
  const paymentType = document.querySelector('input[name="payment-type"]:checked').value;
  const photoFile = document.getElementById('receipt-photo').files[0];
  const sMsg = document.getElementById('upload-success'), eMsg = document.getElementById('upload-error');
  sMsg.style.display='none'; eMsg.style.display='none';
  if (!v.carName||!v.regNumber||!v.customerName||!v.customerPhone||!v.sellingDate||!v.sellingPrice||parseFloat(v.sellingPrice)<=0||!v.purchaseCost||parseFloat(v.purchaseCost)<=0||!v.soldBy||!photoFile) {
    eMsg.textContent='Please fill all required fields'; eMsg.style.display='block'; return;
  }
  let downPayment=0, installments=[];
  if (paymentType==='INSTALLMENT') {
    downPayment = parseFloat(document.getElementById('down-payment').value)||0;
    if (downPayment<=0) { eMsg.textContent='Please enter down payment'; eMsg.style.display='block'; return; }
    const cnt = parseInt(document.getElementById('installment-count').value);
    for (let i=1; i<=cnt; i++) {
      const dt=document.getElementById(`inst-date-${i}`).value, am=parseFloat(document.getElementById(`inst-amount-${i}`).value)||0;
      if (!dt||am<=0) { eMsg.textContent=`Fill installment ${i} details`; eMsg.style.display='block'; return; }
      installments.push({dueDate:dt, amount:am});
    }
    const ti = installments.reduce((s,x)=>s+x.amount,0), te = parseFloat(v.sellingPrice)-downPayment;
    if (Math.abs(ti-te)>100) { eMsg.textContent=`Installments ₨${ti.toLocaleString()} does not match remaining ₨${te.toLocaleString()}`; eMsg.style.display='block'; return; }
  }
  if (photoFile.size>10*1024*1024) { eMsg.textContent='Image too large (max 10MB)'; eMsg.style.display='block'; return; }
  const btn=event.target, origTxt=btn.innerHTML; btn.innerHTML='⏳ Uploading...'; btn.disabled=true;
  try {
    const imageData = await new Promise((res,rej)=>{const r=new FileReader();r.onload=e=>res(e.target.result);r.onerror=()=>rej(new Error('Failed to read image'));r.readAsDataURL(photoFile);});
    const receiptId = v.regNumber+'_'+v.sellingDate+'_'+Date.now();
    const result = await post({action:'upload', receiptId, ...v, sellingPrice:parseFloat(v.sellingPrice), purchaseCost:parseFloat(v.purchaseCost), expenses, paymentType, downPayment, installments, imageData, fileName:receiptId+'.'+photoFile.name.split('.').pop(), mimeType:photoFile.type, timestamp:new Date().toISOString()});
    if (result.success) {
      sMsg.textContent=`✅ Receipt saved for ${v.carName} (${v.regNumber})`; sMsg.style.display='block';
      ['car-name','reg-number','customer-name','customer-phone','selling-price','purchase-cost','sold-by'].forEach(id=>document.getElementById(id).value='');
      document.getElementById('expenses-container').innerHTML=''; expenseFieldCount=0;
      document.getElementById('receipt-photo').value=''; document.getElementById('preview').style.display='none';
      document.querySelector('input[name="payment-type"][value="CASH"]').checked=true; toggleInstallmentSection();
      window.scrollTo(0,0);
    } else throw new Error(result.error||'Upload failed');
  } catch(err) { eMsg.textContent='❌ '+err.message; eMsg.style.display='block'; }
  finally { btn.innerHTML=origTxt; btn.disabled=false; }
}

// ===================== API HELPER =====================
async function post(data) {
  const res = await fetch(CONFIG.SCRIPT_URL, {method:'POST', body:JSON.stringify(data)});
  return res.json();
}

// ===================== LOAD DATA - FIXED EXPENSE MERGE =====================
async function loadAllData() {
  const result = await post({action:'getAll'});
  if (result.success) {
    allReceiptsCache = result.receipts || [];
    allInstallmentsCache = result.installments || [];
    allExpensesCache = result.expenses || [];
    // KEY FIX: merge expenses from sheet into each receipt object
    allReceiptsCache.forEach(r => {
      const sheetExps = allExpensesCache.filter(e => e.receiptId === r.receiptId);
      if (sheetExps.length > 0) {
        // Always use sheet expenses (they are the source of truth)
        r.expenses = sheetExps.map(e => ({
          type: e.expenseType || e.type || 'Other',
          description: e.description || '',
          amount: parseFloat(e.amount) || 0
        }));
      } else if (!r.expenses) {
        r.expenses = [];
      }
    });
  }
  return result;
}

async function loadAllReceipts() {
  const div = document.getElementById('all-receipts');
  div.innerHTML='<div class="loading">Loading...</div>';
  try {
    await loadAllData();
    document.getElementById('total-receipts').textContent = allReceiptsCache.length;
    if (allReceiptsCache.length > 0) {
      allReceiptsCache.sort((a,b)=>new Date(b.sellingDate)-new Date(a.sellingDate));
      div.innerHTML = allReceiptsCache.map(r => receiptCardHTML(r)).join('');
    } else {
      div.innerHTML='<div class="no-results">No receipts yet</div>';
    }
  } catch(err) { div.innerHTML='<div class="no-results">Error loading receipts</div>'; console.error(err); }
}

async function loadPayments() {
  try {
    await loadAllData();
    displayPaymentSummary(); checkOverduePayments();
  } catch(err) { console.error(err); }
}

function receiptCardHTML(r) {
  const dt = new Date(r.sellingDate).toLocaleDateString();
  const pr = '₨'+parseFloat(r.sellingPrice).toLocaleString();
  let sc='', sb='';
  if (r.paymentType==='CASH') { sb='<span class="payment-badge cash">💵 Paid in Full</span>'; }
  else {
    const ri=allInstallmentsCache.filter(i=>i.receiptId===r.receiptId);
    const pend=ri.filter(i=>i.status==='PENDING'), over=pend.filter(i=>new Date(i.dueDate)<new Date());
    if(over.length>0){sc='overdue-payment';sb=`<span class="payment-badge pending">⚠️ ${over.length} Overdue</span>`;}
    else if(pend.length>0){sc='pending-payment';sb=`<span class="payment-badge installment">📅 ${pend.length} Pending</span>`;}
    else sb='<span class="payment-badge cash">✅ Completed</span>';
  }
  return `<div class="receipt-item ${sc}" onclick='viewReceiptByData(${JSON.stringify(r).replace(/'/g,"&#39;")})'>
    <div class="receipt-reg">${r.carName||'N/A'}</div>
    <div class="receipt-date">Reg: ${r.regNumber}</div>
    <div class="receipt-date">Customer: ${r.customerName||'N/A'}</div>
    <div class="receipt-date">Date: ${dt} · Price: ${pr}</div>
    <div class="receipt-date">Sold by: ${r.soldBy||'N/A'}</div>
    ${sb}</div>`;
}

function displayPaymentSummary() {
  const ir = allReceiptsCache.filter(r=>r.paymentType==='INSTALLMENT');
  let tp=0, tr=0, pl='';
  ir.forEach(r=>{
    const ri=allInstallmentsCache.filter(i=>i.receiptId===r.receiptId);
    const pend=ri.filter(i=>i.status==='PENDING'), paid=ri.filter(i=>i.status==='PAID');
    tp+=pend.reduce((s,i)=>s+parseFloat(i.amount),0);
    tr+=parseFloat(r.downPayment||0)+paid.reduce((s,i)=>s+parseFloat(i.amount),0);
    if(pend.length>0){const ov=pend.filter(i=>new Date(i.dueDate)<new Date()); pl+=`<div class="receipt-item ${ov.length>0?'overdue-payment':'pending-payment'}" onclick='viewReceiptByData(${JSON.stringify(r).replace(/'/g,"&#39;")})'><div class="receipt-reg">${r.carName} (${r.regNumber})</div><div class="receipt-date">Customer: ${r.customerName}</div><div class="receipt-date">Pending: ₨${pend.reduce((s,i)=>s+parseFloat(i.amount),0).toLocaleString()}</div>${ov.length>0?`<span class="payment-badge pending">⚠️ ${ov.length} Overdue</span>`:`<span class="payment-badge installment">📅 ${pend.length} Pending</span>`}</div>`;}
  });
  document.getElementById('total-pending').textContent='₨'+tp.toLocaleString();
  document.getElementById('total-received').textContent='₨'+tr.toLocaleString();
  document.getElementById('payments-list').innerHTML=pl||'<div class="no-results">No pending payments</div>';
}

function checkOverduePayments() {
  const today=new Date();
  const ov=allInstallmentsCache.filter(i=>i.status==='PENDING'&&new Date(i.dueDate)<today);
  const up=allInstallmentsCache.filter(i=>{const d=new Date(i.dueDate),df=Math.ceil((d-today)/86400000);return i.status==='PENDING'&&df>=0&&df<=7;});
  if(ov.length>0){document.getElementById('overdue-badge').classList.remove('hidden');document.getElementById('overdue-count').textContent=ov.length;document.getElementById('payment-badge').classList.remove('hidden');document.getElementById('payment-badge').textContent=ov.length;}
  else{document.getElementById('overdue-badge').classList.add('hidden');document.getElementById('payment-badge').classList.add('hidden');}
  if(ov.length>0){document.getElementById('overdue-list').innerHTML=ov.map(i=>{const r=allReceiptsCache.find(x=>x.receiptId===i.receiptId);return r?`<div>• ${r.carName} (${r.regNumber}) - ₨${parseFloat(i.amount).toLocaleString()} - ${Math.ceil((today-new Date(i.dueDate))/86400000)} days overdue</div>`:''}).join('');document.getElementById('overdue-alert').style.display='block';}
  else document.getElementById('overdue-alert').style.display='none';
  if(up.length>0){document.getElementById('upcoming-list').innerHTML=up.map(i=>{const r=allReceiptsCache.find(x=>x.receiptId===i.receiptId);return r?`<div>• ${r.carName} (${r.regNumber}) - ₨${parseFloat(i.amount).toLocaleString()} - Due in ${Math.ceil((new Date(i.dueDate)-today)/86400000)} days</div>`:''}).join('');document.getElementById('upcoming-alert').style.display='block';}
  else document.getElementById('upcoming-alert').style.display='none';
}

async function performSearch() {
  const si=document.getElementById('search-input').value.trim().toUpperCase();
  const se=document.getElementById('search-employee').value;
  const rd=document.getElementById('search-results');
  rd.innerHTML='<div class="loading">Searching...</div>';
  if(allReceiptsCache.length===0) await loadAllData();
  let f=allReceiptsCache;
  if(si) f=f.filter(r=>r.regNumber.includes(si)||(r.carName||'').toUpperCase().includes(si)||(r.customerName||'').toUpperCase().includes(si));
  if(se) f=f.filter(r=>r.soldBy===se);
  rd.innerHTML = f.length ? f.map(r=>receiptCardHTML(r)).join('') : '<div class="no-results">❌ Not found</div>';
}

async function viewReceiptByData(receipt) {
  const mi=document.getElementById('modal-image');
  mi.src=`https://drive.google.com/thumbnail?id=${receipt.driveFileId}&sz=w1000`;
  mi.onerror=function(){this.src=`https://drive.google.com/uc?export=view&id=${receipt.driveFileId}`;};
  document.getElementById('modal-reg').textContent=`${receipt.carName} (${receipt.regNumber})`;
  const dt=new Date(receipt.sellingDate).toLocaleDateString();
  document.getElementById('modal-details').innerHTML=`Customer: ${receipt.customerName}<br>Phone: ${receipt.customerPhone}<br>Date: ${dt}<br>Price: ₨${parseFloat(receipt.sellingPrice).toLocaleString()}<br>Sold by: ${receipt.soldBy}<br>Payment: ${receipt.paymentType}`;
  const mi2=document.getElementById('modal-installments');
  if(receipt.paymentType==='INSTALLMENT'){
    const ri=allInstallmentsCache.filter(i=>i.receiptId===receipt.receiptId);
    let h='<div style="background:rgba(255,255,255,.1);padding:15px;border-radius:10px;margin-top:15px;">';
    h+=`<div style="color:white;font-weight:700;margin-bottom:10px;">Down Payment: ₨${parseFloat(receipt.downPayment).toLocaleString()}</div>`;
    ri.forEach(i=>{
      const ip=i.status==='PAID',io=!ip&&new Date(i.dueDate)<new Date();
      const sc=ip?'#28a745':io?'#dc3545':'#D4AF37', st=ip?'✅ Paid':io?'⚠️ Overdue':'📅 Pending';
      h+=`<div style="background:rgba(255,255,255,.2);padding:10px;border-radius:8px;margin-bottom:8px;border-left:4px solid ${sc};">
        <div style="color:white;">Installment ${i.installmentNumber}: ₨${parseFloat(i.amount).toLocaleString()}</div>
        <div style="color:white;font-size:12px;">Due: ${new Date(i.dueDate).toLocaleDateString()}</div>
        <div style="color:${sc};font-weight:700;font-size:12px;">${st}</div>
        ${!ip?`<button class="btn btn-success btn-small" style="margin-top:8px;" onclick="markInstallmentPaid('${i.installmentId}',event)">Mark as Paid</button>`:''}
      </div>`;
    });
    h+='</div>'; mi2.innerHTML=h;
  } else mi2.innerHTML='';
  document.getElementById('modal').classList.add('active');
  currentViewingReceipt=receipt;
}

async function markInstallmentPaid(iid,ev) {
  ev.stopPropagation();
  if(!confirm('Mark as paid?')) return;
  try {
    const r=await post({action:'markInstallmentPaid', installmentId:iid});
    if(r.success){alert('✅ Marked as paid');await loadAllReceipts();await loadPayments();closeModal();}
    else throw new Error(r.error);
  } catch(e){alert('❌ Error: '+e.message);}
}

function closeModal(){document.getElementById('modal').classList.remove('active');currentViewingReceipt=null;}
function openDriveLink(){if(currentViewingReceipt&&currentViewingReceipt.driveLink)window.open(currentViewingReceipt.driveLink,'_blank');}

async function deleteReceipt() {
  if(!currentViewingReceipt||!confirm('Delete this receipt?')) return;
  try {
    const r=await post({action:'delete', receiptId:currentViewingReceipt.receiptId, driveFileId:currentViewingReceipt.driveFileId});
    if(r.success){closeModal();loadAllReceipts();alert('✅ Deleted');}
    else throw new Error(r.error);
  } catch(e){alert('❌ Error: '+e.message);}
}

async function downloadReceipt() {
  if(!currentViewingReceipt) return;
  const link=document.createElement('a');
  link.href=`https://drive.google.com/uc?export=download&id=${currentViewingReceipt.driveFileId}`;
  link.download=`${currentViewingReceipt.regNumber}_${currentViewingReceipt.carName}.jpg`;
  link.target='_blank'; document.body.appendChild(link); link.click(); document.body.removeChild(link);
  alert('✅ Download started!');
}

function editReceipt() {
  if(!currentViewingReceipt) return;
  const r=currentViewingReceipt; // save BEFORE closeModal nulls it
  closeModal();
  document.getElementById('edit-car-name').value=r.carName||'';
  document.getElementById('edit-reg-number').value=r.regNumber||'';
  document.getElementById('edit-customer-name').value=r.customerName||'';
  document.getElementById('edit-customer-phone').value=r.customerPhone||'';
  document.getElementById('edit-selling-date').value=r.sellingDate||'';
  document.getElementById('edit-selling-price').value=r.sellingPrice||'';
  document.getElementById('edit-purchase-cost').value=r.purchaseCost||'';
  const sel=document.getElementById('edit-sold-by');
  sel.innerHTML='<option value="">Select Employee</option>';
  employeesList.forEach(e=>{const o=document.createElement('option');o.value=o.textContent=e;if(e===r.soldBy)o.selected=true;sel.appendChild(o);});
  document.getElementById('edit-modal').classList.add('active');
  ['edit-success','edit-error'].forEach(id=>document.getElementById(id).style.display='none');
}
function closeEditModal(){document.getElementById('edit-modal').classList.remove('active');}

async function saveEditedReceipt() {
  const vals={
    carName:document.getElementById('edit-car-name').value.trim(),
    regNumber:document.getElementById('edit-reg-number').value.trim().toUpperCase(),
    customerName:document.getElementById('edit-customer-name').value.trim(),
    customerPhone:document.getElementById('edit-customer-phone').value.trim(),
    sellingDate:document.getElementById('edit-selling-date').value,
    sellingPrice:document.getElementById('edit-selling-price').value.trim(),
    purchaseCost:document.getElementById('edit-purchase-cost').value.trim(),
    soldBy:document.getElementById('edit-sold-by').value,
    paymentType:currentViewingReceipt.paymentType,
    downPayment:currentViewingReceipt.downPayment||0
  };
  const err=document.getElementById('edit-error'), suc=document.getElementById('edit-success');
  err.style.display='none'; suc.style.display='none';
  if(!vals.carName||!vals.regNumber||!vals.customerName||!vals.customerPhone||!vals.sellingDate||!vals.sellingPrice||!vals.purchaseCost||!vals.soldBy){
    err.textContent='Please fill all fields';err.style.display='block';return;
  }
  const btn=event.target, ot=btn.innerHTML; btn.innerHTML='⏳ Saving...'; btn.disabled=true;
  try {
    const r=await post({
      action:'updateReceipt',
      receiptId:currentViewingReceipt.receiptId,
      carName:vals.carName,
      regNumber:vals.regNumber,
      customerName:vals.customerName,
      customerPhone:vals.customerPhone,
      sellingDate:vals.sellingDate,
      sellingPrice:parseFloat(vals.sellingPrice),
      purchaseCost:parseFloat(vals.purchaseCost),
      soldBy:vals.soldBy,
      paymentType:vals.paymentType,
      downPayment:vals.downPayment
    });
    if(r.success){suc.textContent='✅ Updated!';suc.style.display='block';await loadAllReceipts();await loadPayments();setTimeout(closeEditModal,1500);}
    else throw new Error(r.error||'Update failed');
  } catch(e){err.textContent='❌ '+e.message;err.style.display='block';}
  finally{btn.innerHTML=ot;btn.disabled=false;}
}

// ===================== PROFIT - FIXED: reads expenses from sheet =====================
function getExpensesForReceipt(r) {
  // Priority: merged expenses on receipt object (from sheet), fallback to inline
  if (r.expenses && r.expenses.length > 0) return r.expenses;
  return allExpensesCache
    .filter(e => e.receiptId === r.receiptId)
    .map(e => ({ type: e.expenseType||e.type||'Other', description: e.description||'', amount: parseFloat(e.amount)||0 }));
}

async function calculateProfit() {
  if(allReceiptsCache.length===0) await loadAllData();
  let tr=0, tp=0, te=0;
  allReceiptsCache.forEach(r=>{
    tr+=parseFloat(r.sellingPrice)||0;
    tp+=parseFloat(r.purchaseCost)||0;
    te+=getExpensesForReceipt(r).reduce((s,e)=>s+(parseFloat(e.amount)||0),0);
  });
  const np=tr-tp-te, pm=tr>0?((np/tr)*100):0;
  document.getElementById('profit-revenue').textContent='₨'+tr.toLocaleString();
  document.getElementById('profit-purchase').textContent='₨'+tp.toLocaleString();
  document.getElementById('profit-expenses').textContent='₨'+te.toLocaleString();
  document.getElementById('profit-net').textContent='₨'+np.toLocaleString();
  document.getElementById('profit-margin').textContent=pm.toFixed(1)+'%';
  showProfitBreakdown();
}

function showProfitBreakdown() {
  const c=document.getElementById('profit-breakdown');
  if(!allReceiptsCache.length){c.innerHTML='<div class="no-results">No data</div>';return;}
  c.innerHTML=allReceiptsCache.map(r=>{
    const s=parseFloat(r.sellingPrice)||0, p=parseFloat(r.purchaseCost)||0;
    const e=getExpensesForReceipt(r).reduce((sum,x)=>sum+(parseFloat(x.amount)||0),0);
    const pf=s-p-e, mg=s>0?((pf/s)*100):0, col=pf>=0?'#28a745':'#dc3545';
    return `<div class="receipt-item" style="border-left:4px solid ${col};">
      <div class="receipt-reg">${r.carName||'N/A'} (${r.regNumber})</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;font-size:12px;">
        <div>Selling: ₨${s.toLocaleString()}</div><div>Purchase: ₨${p.toLocaleString()}</div>
        <div>Expenses: ₨${e.toLocaleString()}</div>
        <div style="font-weight:700;color:${col};">Profit: ₨${pf.toLocaleString()} (${mg.toFixed(1)}%)</div>
      </div>
      <div class="receipt-date" style="margin-top:8px;">Sold by: ${r.soldBy||'N/A'}</div></div>`;
  }).join('');
}

// ===================== EXPORT =====================
function exportSalesReport(){
  const d=allReceiptsCache.map(r=>{const e=getExpensesForReceipt(r).reduce((s,x)=>s+(parseFloat(x.amount)||0),0);const pf=(parseFloat(r.sellingPrice)||0)-(parseFloat(r.purchaseCost)||0)-e;return{'Receipt ID':r.receiptId,'Car':r.carName,'Reg':r.regNumber,'Customer':r.customerName,'Phone':r.customerPhone,'Date':r.sellingDate,'Selling':r.sellingPrice,'Purchase':r.purchaseCost||0,'Expenses':e,'Profit':pf,'Payment':r.paymentType,'Sold By':r.soldBy};});
  exportToExcel(d,'Sales_Report_'+new Date().toISOString().split('T')[0]);
}
function exportProfitReport(){
  const d=allReceiptsCache.map(r=>{const s=parseFloat(r.sellingPrice)||0,p=parseFloat(r.purchaseCost)||0,e=getExpensesForReceipt(r).reduce((s2,x)=>s2+(parseFloat(x.amount)||0),0),pf=s-p-e;return{'Car':r.carName,'Reg':r.regNumber,'Date':r.sellingDate,'Selling':s,'Purchase':p,'Expenses':e,'Gross':s-p,'Net Profit':pf,'Margin %':(s>0?((pf/s)*100).toFixed(2):0),'Sold By':r.soldBy};});
  exportToExcel(d,'Profit_Report_'+new Date().toISOString().split('T')[0]);
}
function exportPaymentReport(){
  const d=[];allReceiptsCache.forEach(r=>{if(r.paymentType==='INSTALLMENT'){allInstallmentsCache.filter(i=>i.receiptId===r.receiptId).forEach(i=>{d.push({'Car':r.carName,'Reg':r.regNumber,'Customer':r.customerName,'Phone':r.customerPhone,'Inst #':i.installmentNumber,'Due':i.dueDate,'Amount':i.amount,'Status':i.status,'Paid':i.paidDate||'N/A'});});}});
  exportToExcel(d,'Payment_Report_'+new Date().toISOString().split('T')[0]);
}
function exportExpenseReport(){
  const d=allExpensesCache.map(e=>{const r=allReceiptsCache.find(x=>x.receiptId===e.receiptId);return{'Car':r?r.carName:'N/A','Reg':e.receiptId,'Type':e.expenseType||e.type,'Description':e.description,'Amount':e.amount,'Date':e.date};});
  exportToExcel(d,'Expense_Report_'+new Date().toISOString().split('T')[0]);
}
function exportToExcel(data,name){
  if(!data||!data.length){alert('❌ No data to export');return;}
  const ws=XLSX.utils.json_to_sheet(data),wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Report');XLSX.writeFile(wb,name+'.xlsx');
}

// ===================== ANALYTICS =====================
async function calculateAnalytics() {
  if(allReceiptsCache.length===0) await loadAllData();
  const now=new Date();
  const total=allReceiptsCache.length;
  const rev=allReceiptsCache.reduce((s,r)=>s+(parseFloat(r.sellingPrice)||0),0);
  const today=new Date(now.getFullYear(),now.getMonth(),now.getDate());
  const dw=today.getDay(), mo=dw===0?-6:1-dw;
  const ws=new Date(today); ws.setDate(today.getDate()+mo);
  const wr=allReceiptsCache.filter(r=>new Date(r.sellingDate)>=ws);
  const mr=allReceiptsCache.filter(r=>new Date(r.sellingDate)>=new Date(now.getFullYear(),now.getMonth(),1));
  document.getElementById('total-cars').textContent=total;
  document.getElementById('total-revenue').textContent='₨'+rev.toLocaleString();
  document.getElementById('week-cars').textContent=wr.length;
  document.getElementById('week-revenue').textContent='₨'+wr.reduce((s,r)=>s+(parseFloat(r.sellingPrice)||0),0).toLocaleString();
  document.getElementById('month-cars').textContent=mr.length;
  document.getElementById('month-revenue').textContent='₨'+mr.reduce((s,r)=>s+(parseFloat(r.sellingPrice)||0),0).toLocaleString();
  calculateTopSalespeople(); calculateBestSellingCars();
}

function calculateTopSalespeople(){
  const es={};allReceiptsCache.forEach(r=>{const e=r.soldBy||'Unknown';if(!es[e])es[e]={count:0,revenue:0};es[e].count++;es[e].revenue+=parseFloat(r.sellingPrice)||0;});
  const s=Object.entries(es).sort((a,b)=>b[1].count-a[1].count).slice(0,5);
  const medals=['🥇','🥈','🥉','🏅'];
  document.getElementById('top-salespeople-list').innerHTML=s.length?s.map(([n,d],i)=>`<div style="background:white;padding:12px;border-radius:8px;margin-bottom:10px;display:flex;align-items:center;gap:10px;"><span style="font-size:24px;">${medals[Math.min(i,3)]}</span><div><div style="font-weight:700;color:var(--accent);">${n}</div><div style="font-size:12px;color:#666;">${d.count} cars · ₨${d.revenue.toLocaleString()}</div></div></div>`).join(''):'<div class="no-results">No data</div>';
}
function calculateBestSellingCars(){
  const cc={};allReceiptsCache.forEach(r=>{const c=r.carName||'Unknown';if(!cc[c])cc[c]={count:0,revenue:0};cc[c].count++;cc[c].revenue+=parseFloat(r.sellingPrice)||0;});
  const s=Object.entries(cc).sort((a,b)=>b[1].count-a[1].count).slice(0,5);
  const medals=['🥇','🥈','🥉','🏅'];
  document.getElementById('best-selling-list').innerHTML=s.length?s.map(([n,d],i)=>`<div style="background:white;padding:12px;border-radius:8px;margin-bottom:10px;display:flex;align-items:center;gap:10px;"><span style="font-size:24px;">${medals[Math.min(i,3)]}</span><div><div style="font-weight:700;color:var(--accent);">${n}</div><div style="font-size:12px;color:#666;">${d.count} sold · ₨${d.revenue.toLocaleString()}</div></div></div>`).join(''):'<div class="no-results">No data</div>';
}


// Password visibility toggle
function togglePw() {
  const inp = document.getElementById('login-password');
  const eye = document.getElementById('pw-eye');
  if (inp.type === 'password') {
    inp.type = 'text';
    eye.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94"/><path d="M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19"/><line x1="1" y1="1" x2="23" y2="23" stroke="var(--accent)" stroke-width="2"/>';
  } else {
    inp.type = 'password';
    eye.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>';
  }
}

// Device detection banner
(function detectDevice() {
  const w = window.innerWidth;
  const isMobile = w < 600;
  const isTablet = w >= 600 && w < 1024;
  const isDesktop = w >= 1024;
  document.documentElement.setAttribute('data-device', isMobile ? 'mobile' : isTablet ? 'tablet' : 'desktop');
  window.addEventListener('resize', () => {
    const ww = window.innerWidth;
    document.documentElement.setAttribute('data-device', ww < 600 ? 'mobile' : ww < 1024 ? 'tablet' : 'desktop');
  });
})();

document.getElementById('modal').addEventListener('click',e=>{if(e.target===document.getElementById('modal'))closeModal();});
document.getElementById('edit-modal').addEventListener('click',e=>{if(e.target===document.getElementById('edit-modal'))closeEditModal();});
</script>



<script>
// ══════════════════════════════════════
// THEME ENGINE
// ══════════════════════════════════════
(function() {
  const THEMES = ['phantom','inferno','arctic','obsidian'];
  let panelOpen = false;

  function applyTheme(theme) {
    if (!THEMES.includes(theme)) theme = 'phantom';
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('elite-theme', theme);

    // Update active state in panel
    document.querySelectorAll('.theme-option').forEach(opt => {
      opt.classList.toggle('active', opt.dataset.theme === theme);
    });

    // Update meta theme-color
    const colors = {
      phantom:'#0D0F14', inferno:'#0F0A08',
      arctic:'#060C14',  obsidian:'#000000'
    };
    document.querySelector('meta[name="theme-color"]').setAttribute('content', colors[theme]);
  }

  window.setTheme = function(theme, el) {
    applyTheme(theme);
    // Smooth close after pick
    setTimeout(() => {
      panelOpen = false;
      document.getElementById('theme-panel').classList.remove('open');
    }, 300);
  };

  window.toggleThemePanel = function() {
    panelOpen = !panelOpen;
    document.getElementById('theme-panel').classList.toggle('open', panelOpen);
  };

  // Close on outside click
  document.addEventListener('click', function(e) {
    const panel = document.getElementById('theme-panel');
    const btn = document.getElementById('theme-hdr-btn');
    if (panel && btn && !panel.contains(e.target) && !btn.contains(e.target)) {
      panelOpen = false;
      panel.classList.remove('open');
    }
  });

  // Load saved theme on start
  const saved = localStorage.getItem('elite-theme') || 'phantom';
  applyTheme(saved);
})();

// ══════════════════════════════════════
// ICON PACK ENGINE
// ══════════════════════════════════════
const ICON_PACKS = {
  minimal: { upload:'⊕',  payments:'◎',  search:'⊙',  all:'≡',  profit:'◈',  analytics:'⋯'  },
  arrows:  { upload:'↑',  payments:'↔',  search:'↗',  all:'↕',  profit:'↑↓', analytics:'∿'  },
  emoji:   { upload:'🚗', payments:'💰', search:'🔍', all:'📋', profit:'💵', analytics:'📊' },
  sharp:   { upload:'▲',  payments:'◆',  search:'●',  all:'■',  profit:'▶',  analytics:'▪▪' },
  neon:    { upload:'⚡', payments:'★',  search:'◉',  all:'⊞',  profit:'◑',  analytics:'⊛'  },
  rounded: { upload:'⬡',  payments:'⬢',  search:'⬣',  all:'⬡',  profit:'⬢',  analytics:'⬣'  },
  dots:    { upload:'⦿',  payments:'⦾',  search:'⦿',  all:'⊡',  profit:'⊞',  analytics:'⊟'  },
  lines:   { upload:'⌇',  payments:'⌇⌇', search:'⌇',  all:'⌇⌇', profit:'⌇',  analytics:'⌇⌇⌇'}
};
const TAB_IDS = ['upload','payments','search','all','profit','analytics'];

function setIconPack(pack, el) {
  localStorage.setItem('elite-icons', pack);
  document.querySelectorAll('.icon-option').forEach(o => o.classList.remove('active'));
  if(el) el.classList.add('active');
  const icons = ICON_PACKS[pack] || ICON_PACKS.minimal;
  TAB_IDS.forEach(id => {
    const btn = document.querySelector(`.tab-btn[onclick*="'${id}'"]`);
    if(btn) {
      const ic = btn.querySelector('.tab-icon');
      if(ic) ic.textContent = icons[id] || ic.textContent;
    }
  });
}

// Apply saved icon pack
(function(){
  const savedPack = localStorage.getItem('elite-icons') || 'minimal';
  const savedEl = document.querySelector(`.icon-option[onclick*="'${savedPack}'"]`);
  setIconPack(savedPack, savedEl);
})();

// ══════════════════════════════════════
// PROFIT VIEW ENGINE
// ══════════════════════════════════════
function setProfitStyle(style, btn) {
  localStorage.setItem('profit-style', style);
  document.querySelectorAll('.ps-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.profit-view').forEach(v => v.classList.remove('active-view'));
  if(btn) btn.classList.add('active');
  const el = document.getElementById('profit-style-'+style);
  if(el) el.classList.add('active-view');
}
// Apply saved profit style
(function(){
  const ps = localStorage.getItem('profit-style') || 'cards';
  const psBtn = document.querySelector(`.ps-btn[onclick*="'${ps}'"]`);
  setProfitStyle(ps, psBtn);
})();

// Override calculateProfit to also update new views
const _origCalcProfit = calculateProfit;
calculateProfit = async function() {
  await _origCalcProfit();
  updateProfitViews();
};

function updateProfitViews() {
  const rev = parseFloat(document.getElementById('profit-revenue').textContent.replace(/[^0-9.-]/g,'')) || 0;
  const cost = parseFloat(document.getElementById('profit-purchase').textContent.replace(/[^0-9.-]/g,'')) || 0;
  const exp = parseFloat(document.getElementById('profit-expenses').textContent.replace(/[^0-9.-]/g,'')) || 0;
  const net = parseFloat(document.getElementById('profit-net').textContent.replace(/[^0-9.-]/g,'')) || 0;
  const margin = parseFloat(document.getElementById('profit-margin').textContent) || 0;

  // Update progress bars in cards view
  if(rev > 0) {
    const pb = document.getElementById('purchase-bar');
    const eb = document.getElementById('expense-bar');
    if(pb) pb.style.width = Math.min(100,(cost/rev*100)) + '%';
    if(eb) eb.style.width = Math.min(100,(exp/rev*100)) + '%';
    const rp = document.getElementById('ring-path');
    if(rp) rp.style.strokeDasharray = Math.min(100,margin) + ', 100';
  }

  // Hero tag
  const tag = document.getElementById('profit-hero-tag');
  if(tag) tag.textContent = net >= 0 ? '▲ Profitable' : '▼ Loss';
  if(tag) tag.style.color = net >= 0 ? 'var(--accent)' : 'var(--danger)';

  // Gauge view
  const gm = document.getElementById('gauge-margin-val');
  if(gm) gm.textContent = margin.toFixed(1) + '%';
  const gf = document.getElementById('gauge-fill');
  if(gf) {
    const pct = Math.min(100, Math.max(0, margin));
    gf.style.strokeDasharray = (pct * 2.512) + ' 251.2';
  }
  const gn = document.getElementById('gauge-needle');
  if(gn) { const deg = -90 + (margin/100 * 180); gn.setAttribute('transform','rotate('+deg+',100,100)'); }
  const fmt = n => '₨'+Math.round(n).toLocaleString();
  const gsRev = document.getElementById('gs-rev'); if(gsRev) gsRev.textContent = 'Revenue ' + fmt(rev);
  const gsCost = document.getElementById('gs-cost'); if(gsCost) gsCost.textContent = 'Cost ' + fmt(cost);
  const gsExp = document.getElementById('gs-exp'); if(gsExp) gsExp.textContent = 'Expenses ' + fmt(exp);
  const gsNet = document.getElementById('gs-net'); if(gsNet) { gsNet.textContent = 'Net ' + fmt(net); gsNet.style.color = net>=0 ? 'var(--accent)' : 'var(--danger)'; }

  // Minimal view
  const mpRev = document.getElementById('mp-rev'); if(mpRev) mpRev.textContent = fmt(rev);
  const mpCost = document.getElementById('mp-cost'); if(mpCost) mpCost.textContent = fmt(cost);
  const mpExp = document.getElementById('mp-exp'); if(mpExp) mpExp.textContent = fmt(exp);
  const mpNet = document.getElementById('mp-net'); if(mpNet) { mpNet.textContent = fmt(net); mpNet.style.color = net>=0?'var(--accent)':'var(--danger)'; }
  const mbFill = document.getElementById('mp-mb-fill'); if(mbFill) mbFill.style.width = Math.min(100,Math.max(0,margin)) + '%';
  const mbLabel = document.getElementById('mp-mb-label'); if(mbLabel) mbLabel.textContent = margin.toFixed(1) + '%';
}
</script>
</body>
</html>
