<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0A1628">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Showroom Manager">
<link rel="manifest" href="manifest.json">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
<title>Car Showroom Manager</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;700&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto',sans-serif;background:linear-gradient(135deg,#0A1628 0%,#1E3A5F 50%,#2C5F8D 100%);min-height:100vh;padding:20px;position:relative;overflow-x:hidden}
body.urdu{font-family:'Noto Nastaliq Urdu',serif;direction:rtl;text-align:right}
body.arabic{font-family:'Noto Sans Arabic',sans-serif;direction:rtl;text-align:right}
body.hindi{font-family:'Noto Sans Devanagari',sans-serif}
body.chinese{font-family:'Noto Sans SC',sans-serif}
body.spanish,body.french,body.german,body.turkish,body.russian{font-family:Roboto,sans-serif}
body.urdu .tab-buttons{flex-direction:row-reverse}
body.urdu input,body.urdu select{text-align:right;direction:rtl}
body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background-image:radial-gradient(circle at 20% 50%,rgba(0,212,255,.1) 0%,transparent 50%),radial-gradient(circle at 80% 80%,rgba(107,70,193,.1) 0%,transparent 50%);pointer-events:none;z-index:0}
.container{max-width:600px;margin:0 auto;position:relative;z-index:1}
.login-container{background:rgba(255,255,255,.95);backdrop-filter:blur(20px);padding:40px;border-radius:24px;box-shadow:0 20px 60px rgba(0,0,0,.3);text-align:center;border:1px solid rgba(255,255,255,.2)}
.login-container h1{background:linear-gradient(135deg,#0A1628 0%,#00D4FF 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;font-size:28px;font-weight:800;margin-bottom:10px}
.login-container p{color:#555;margin-bottom:10px;font-weight:500}
.header{background:rgba(255,255,255,.98);backdrop-filter:blur(20px);padding:24px;border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,.15);margin-bottom:20px;text-align:center;position:relative;border:1px solid rgba(255,255,255,.2)}
.header h1{background:linear-gradient(135deg,#0A1628 0%,#00D4FF 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;font-size:26px;font-weight:800;margin-bottom:8px}
.header p{color:#666;font-size:14px;font-weight:500}
.logout-btn{background:linear-gradient(135deg,#dc3545 0%,#c82333 100%);color:white;border:none;padding:10px 20px;border-radius:12px;font-size:13px;font-weight:600;cursor:pointer;margin-top:12px;margin-left:8px;transition:all .3s ease;box-shadow:0 4px 15px rgba(220,53,69,.3)}
.logout-btn:hover{transform:translateY(-2px)}
.manage-btn{background:linear-gradient(135deg,#00D4FF 0%,#6B46C1 100%);box-shadow:0 4px 15px rgba(0,212,255,.3)}
.lang-btn{background:linear-gradient(135deg,#D4AF37 0%,#FFD700 100%);color:#333 !important;font-weight:700 !important;box-shadow:0 4px 15px rgba(212,175,55,.3)}
.notification-badge{position:absolute;top:15px;right:15px;background:linear-gradient(135deg,#dc3545 0%,#c82333 100%);color:white;padding:6px 14px;border-radius:20px;font-size:12px;font-weight:700;cursor:pointer;animation:pulse 2s infinite;box-shadow:0 4px 15px rgba(220,53,69,.4)}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
.install-prompt{background:linear-gradient(135deg,#00D4FF 0%,#6B46C1 100%);color:white;padding:16px;border-radius:16px;margin-bottom:20px;display:none;align-items:center;gap:12px}
.install-prompt button{background:white;color:#6B46C1;border:none;padding:10px 20px;border-radius:10px;font-weight:700;cursor:pointer;margin-left:auto}
.alert-box{background:rgba(255,243,205,.95);border-left:4px solid #D4AF37;padding:16px;border-radius:12px;margin-bottom:16px;display:none}
.alert-box.danger{background:rgba(248,215,218,.95);border-left-color:#dc3545}
.alert-box strong{font-size:18px}
.alert-box div{font-size:16px;line-height:1.6}
.card{background:rgba(255,255,255,.98);backdrop-filter:blur(20px);padding:24px;padding-bottom:90px;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.15);margin-bottom:20px;min-height:calc(100vh - 200px);border:1px solid rgba(255,255,255,.2)}
.tab-buttons{display:flex;gap:6px;background:rgba(255,255,255,.98);backdrop-filter:blur(20px);position:fixed;bottom:20px;left:50%;transform:translateX(-50%);padding:12px;box-shadow:0 10px 40px rgba(0,0,0,.2);z-index:100;max-width:560px;width:calc(100% - 40px);border-radius:20px;border:1px solid rgba(255,255,255,.2)}
.tab-btn{flex:1;padding:10px 4px;border:none;background:transparent;color:#666;border-radius:14px;font-size:10px;font-weight:700;cursor:pointer;transition:all .4s cubic-bezier(.4,0,.2,1);display:flex;flex-direction:column;align-items:center;gap:4px;position:relative}
.tab-btn .tab-icon{font-size:20px}
.tab-btn.active{background:linear-gradient(135deg,#00D4FF 0%,#6B46C1 100%);color:white;transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,212,255,.4)}
.tab-btn .badge{position:absolute;top:6px;right:8px;background:#dc3545;color:white;font-size:9px;padding:2px 5px;border-radius:10px;font-weight:700}
.tab-content{display:none}
.tab-content.active{display:block}
.form-group{margin-bottom:18px}
label{display:block;margin-bottom:8px;color:#2C3E50;font-weight:700;font-size:14px}
input[type=text],input[type=password],input[type=date],input[type=number],select{width:100%;padding:14px 16px;border:2px solid #E8ECF0;border-radius:12px;font-size:16px;transition:all .3s ease;background:#F8F9FA;color:#2C3E50;font-weight:500}
input:focus,select:focus{outline:none;border-color:#00D4FF;background:white;box-shadow:0 0 0 4px rgba(0,212,255,.1)}
input[type=file]{width:100%;padding:14px;border:2px dashed #00D4FF;border-radius:12px;cursor:pointer;font-size:14px;background:rgba(0,212,255,.05)}
.radio-group{display:flex;gap:20px;margin:10px 0;flex-wrap:wrap}
.radio-group label{display:flex;align-items:center;font-weight:normal;cursor:pointer}
input[type=radio]{margin-right:8px}
.installment-section{background:rgba(0,212,255,.05);padding:16px;border-radius:12px;margin-top:16px;display:none;border:2px solid rgba(0,212,255,.2)}
.installment-item{background:white;padding:14px;border-radius:10px;margin-bottom:12px;border-left:4px solid #00D4FF;box-shadow:0 2px 8px rgba(0,0,0,.05)}
.btn{width:100%;padding:16px;border:none;border-radius:14px;font-size:16px;font-weight:700;cursor:pointer;transition:all .4s cubic-bezier(.4,0,.2,1);margin-top:12px}
.btn-primary{background:linear-gradient(135deg,#00D4FF 0%,#6B46C1 100%);color:white;box-shadow:0 8px 25px rgba(0,212,255,.3)}
.btn-primary:hover{transform:translateY(-3px)}
.btn-primary:disabled{opacity:.6;cursor:not-allowed;transform:none}
.btn-success{background:linear-gradient(135deg,#28a745 0%,#20c997 100%);color:white}
.btn-small{padding:10px 16px;font-size:13px;width:auto}
.preview-image{width:100%;max-height:300px;object-fit:contain;border-radius:12px;margin-top:12px;border:2px solid #E8ECF0}
.receipt-item{padding:18px;border:2px solid #E8ECF0;border-radius:16px;margin-bottom:12px;cursor:pointer;transition:all .3s cubic-bezier(.4,0,.2,1);background:linear-gradient(135deg,#fff 0%,#f8f9fa 100%)}
.receipt-item:hover{border-color:#00D4FF;transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,212,255,.15)}
.receipt-item.pending-payment{border-left:5px solid #D4AF37;background:linear-gradient(135deg,#FFFBF0 0%,#FFF8E1 100%)}
.receipt-item.overdue-payment{border-left:5px solid #dc3545;background:linear-gradient(135deg,#FFF5F7 0%,#FFE8EB 100%)}
.receipt-reg{font-size:19px;font-weight:800;background:linear-gradient(135deg,#0A1628 0%,#00D4FF 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:8px}
.receipt-date{font-size:13px;color:#7C8B9A;font-weight:500;margin-bottom:4px}
.payment-badge{display:inline-block;padding:6px 12px;border-radius:8px;font-size:12px;font-weight:700;margin-top:8px}
.payment-badge.cash{background:linear-gradient(135deg,#d4edda 0%,#c3e6cb 100%);color:#155724}
.payment-badge.installment{background:linear-gradient(135deg,#fff3cd 0%,#ffeaa7 100%);color:#856404}
.payment-badge.pending{background:linear-gradient(135deg,#f8d7da 0%,#f5c6cb 100%);color:#721c24}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(10,22,40,.98);backdrop-filter:blur(20px);z-index:1000;padding:20px;overflow-y:auto}
.modal.active{display:flex;align-items:center;justify-content:center}
.modal-content{position:relative;max-width:900px;width:100%}
.modal-image{width:100%;max-height:85vh;object-fit:contain;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.close-modal{position:absolute;top:-50px;right:0;background:linear-gradient(135deg,#fff 0%,#f8f9fa 100%);border:none;padding:12px 24px;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;box-shadow:0 8px 25px rgba(0,0,0,.3);color:#333}
body.urdu .close-modal{right:auto;left:0}
.success-msg,.error-msg{padding:14px 18px;border-radius:12px;margin-bottom:16px;display:none;font-weight:600}
.success-msg{background:linear-gradient(135deg,#d4edda 0%,#c3e6cb 100%);color:#155724;border-left:4px solid #28a745}
.error-msg{background:linear-gradient(135deg,#f8d7da 0%,#f5c6cb 100%);color:#721c24;border-left:4px solid #dc3545}
.loading{text-align:center;padding:30px;color:#00D4FF;font-weight:700;font-size:16px}
.no-results{text-align:center;padding:50px;color:#B0BEC5;font-weight:600}
.stats{display:flex;justify-content:space-around;padding:20px;background:linear-gradient(135deg,rgba(0,212,255,.1) 0%,rgba(107,70,193,.1) 100%);border-radius:16px;margin-bottom:20px;border:1px solid rgba(0,212,255,.2)}
.stat-item{text-align:center}
.stat-number{font-size:26px;font-weight:800;background:linear-gradient(135deg,#00D4FF 0%,#6B46C1 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;word-break:break-all;line-height:1.2}
@media(max-width:480px){.stat-number{font-size:18px}}
.stat-label{font-size:12px;color:#7C8B9A;margin-top:6px;font-weight:600}
.delete-btn{background:linear-gradient(135deg,#dc3545 0%,#c82333 100%);color:white;border:none;padding:10px 18px;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;box-shadow:0 4px 15px rgba(220,53,69,.3)}
.hidden{display:none !important}
@media(max-width:480px){body{padding:12px}.header h1{font-size:20px}.card{padding:16px;padding-bottom:90px}.tab-btn{font-size:9px;padding:8px 3px}.tab-btn .tab-icon{font-size:18px}}
::-webkit-scrollbar{width:8px}
::-webkit-scrollbar-track{background:rgba(255,255,255,.1)}
::-webkit-scrollbar-thumb{background:linear-gradient(135deg,#00D4FF 0%,#6B46C1 100%);border-radius:10px}

.export-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(10,22,40,.95);backdrop-filter:blur(10px);z-index:1000;padding:20px;overflow-y:auto}
.export-modal.active{display:flex;align-items:center;justify-content:center}
.export-modal-content{background:white;border-radius:20px;padding:30px;max-width:500px;width:100%;max-height:90vh;overflow-y:auto}
.export-modal h3{color:#00D4FF;margin-bottom:20px;text-align:center;font-weight:800}
.export-option{background:linear-gradient(135deg,#f8f9fa 0%,#fff 100%);border:2px solid #E8ECF0;border-radius:12px;padding:16px;margin-bottom:12px;cursor:pointer;transition:all .3s ease;display:flex;align-items:center;gap:12px}
.export-option:hover{border-color:#00D4FF;transform:translateY(-2px);box-shadow:0 4px 15px rgba(0,212,255,.2)}
.export-option .icon{font-size:24px;width:40px;text-align:center}
.export-option .text{flex:1}
.export-option .title{font-weight:700;font-size:15px;color:#333;margin-bottom:4px}
.export-option .desc{font-size:12px;color:#7C8B9A}
.status-badge{display:inline-block;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:700;margin-left:8px}
.status-badge.available{background:#d4edda;color:#155724}
.status-badge.sold{background:#f8d7da;color:#721c24}
.status-badge.reserved{background:#fff3cd;color:#856404}
.status-badge.in-service{background:#d1ecf1;color:#0c5460}
.chart-container{background:white;padding:20px;border-radius:12px;margin-bottom:15px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen" class="container">
  <div class="login-container">
    <h1 id="login-title">üöó CAR SHOWROOM MANAGER</h1>
    <p id="login-sub">Premium Sales Management System</p>
    <p style="font-size:11px;color:#999;margin-top:8px;">Powered by Advanced Technology</p>
    <div style="margin-top:30px;">
      <div class="error-msg" id="login-error"></div>
      <div class="form-group" style="text-align:left;">
        <label id="lbl-password">Password</label>
        <input type="password" id="login-password" placeholder="Enter password">
      </div>
      <button class="btn btn-primary" onclick="login()" id="btn-login">üîì Login</button>
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div id="main-app" class="container hidden">
  <div class="header">
    <h1 id="header-title">üöó CAR SHOWROOM MANAGER</h1>
    <p>Premium Sales Management System</p>
    <p style="font-size:11px;color:#999;margin-top:8px;">Powered by Advanced Technology</p>
    <div class="notification-badge hidden" id="overdue-badge" onclick="switchTabDirect('payments')">
      <span id="overdue-count">0</span> <span id="lbl-overdue">Overdue</span>
    </div>
    <button class="logout-btn lang-btn" onclick="toggleLanguage()">üåê <span id="lang-text">ÿßÿ±ÿØŸà</span></button>
    <button class="logout-btn manage-btn" onclick="manageEmployees()">üë• <span id="lbl-employees">Employees</span></button>
    <button class="logout-btn" onclick="logout()">üö™ <span id="lbl-logout">Logout</span></button>
  </div>

  <div class="install-prompt" id="install-prompt">
    <span id="lbl-install">üì± Install this app for easier access!</span>
    <button onclick="installApp()" id="btn-install">Install</button>
  </div>

  <div class="card">

    <!-- UPLOAD TAB -->
    <div id="upload-tab" class="tab-content active">
      <div class="success-msg" id="upload-success"></div>
      <div class="error-msg" id="upload-error"></div>
      <div class="form-group"><label id="lbl-car-name">Car Name/Model *</label><input type="text" id="car-name" placeholder="e.g., Toyota Corolla 2020"></div>
      <div class="form-group"><label id="lbl-reg-number">Car Registration Number *</label><input type="text" id="reg-number" placeholder="e.g., ABC-123" style="text-transform:uppercase"></div>
      <div class="form-group"><label id="lbl-cust-name">Customer Name *</label><input type="text" id="customer-name" placeholder="e.g., Ahmed Khan"></div>
      <div class="form-group"><label id="lbl-cust-phone">Customer Phone *</label><input type="text" id="customer-phone" placeholder="e.g., 03001234567"></div>
      <div class="form-group"><label id="lbl-sell-date">Selling Date *</label><input type="date" id="selling-date"></div>
      <div class="form-group"><label id="lbl-sell-price">Selling Price (PKR) *</label><input type="number" id="selling-price" placeholder="e.g., 2500000" min="0" step="1000"></div>
      <div class="form-group">
        <label id="lbl-purch-cost">Purchase Cost (PKR) *</label>
        <input type="number" id="purchase-cost" placeholder="e.g., 2000000" min="0" step="1000">
        <small id="lbl-purch-hint" style="color:#666;font-size:12px;display:block;margin-top:5px;">üí° How much did you pay to buy this car?</small>
      </div>
      <div class="form-group">
        <label id="lbl-expenses">Additional Expenses (Optional)</label>
        <small id="lbl-exp-hint" style="color:#666;font-size:12px;display:block;margin-bottom:10px;">Repairs, maintenance, modifications, etc.</small>
        <div id="expenses-container"></div>
        <button type="button" class="btn btn-primary" onclick="addExpenseField()" style="width:auto;padding:10px 15px;margin-top:5px;" id="btn-add-expense">‚ûï Add Expense</button>
      </div>
      <div class="form-group">
        <label id="lbl-pay-type">Payment Type *</label>
        <div class="radio-group">
          <label><input type="radio" name="payment-type" value="CASH" checked onchange="toggleInstallmentSection()"> üíµ <span id="lbl-cash">Cash (Full Payment)</span></label>
          <label><input type="radio" name="payment-type" value="INSTALLMENT" onchange="toggleInstallmentSection()"> üìÖ <span id="lbl-inst">Installment</span></label>
        </div>
      </div>
      <div class="installment-section" id="installment-section">
        <div class="form-group"><label id="lbl-down">Down Payment (PKR) *</label><input type="number" id="down-payment" placeholder="e.g., 500000" min="0" step="1000"></div>
        <div class="form-group">
          <label id="lbl-inst-count">Number of Installments *</label>
          <select id="installment-count" onchange="generateInstallmentFields()">
            <option value="1">1</option><option value="2">2</option><option value="3">3</option>
            <option value="4">4</option><option value="5">5</option><option value="6">6</option>
          </select>
        </div>
        <div id="installment-fields"></div>
      </div>
      <div class="form-group"><label id="lbl-sold-by">Sold By (Employee) *</label><select id="sold-by"><option value="">Select Employee</option></select></div>
      <div class="form-group"><label id="lbl-receipt-photo">Receipt Photo *</label><input type="file" id="receipt-photo" accept="image/*"></div>
      <img id="preview" class="preview-image" style="display:none">
      <button class="btn btn-primary" onclick="uploadReceipt()" id="btn-save-receipt">üíæ Save Receipt</button>
    </div>

    <!-- PAYMENTS TAB -->
    <div id="payments-tab" class="tab-content">
      <h3 style="color:#00D4FF;margin-bottom:20px;font-weight:800;">üí∞ <span id="lbl-pay-track">Payment Tracking</span></h3>
      <div class="alert-box danger" id="overdue-alert"><strong id="lbl-overdue-title">‚ö†Ô∏è Overdue Payments!</strong><div id="overdue-list" style="margin-top:10px;"></div></div>
      <div class="alert-box" id="upcoming-alert"><strong id="lbl-upcoming-title">üìÖ Upcoming Payments</strong><div id="upcoming-list" style="margin-top:10px;"></div></div>
      <div class="stats" style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
        <div class="stat-item"><div class="stat-number" id="total-pending">‚Ç®0</div><div class="stat-label" id="lbl-total-pending">Total Pending</div></div>
        <div class="stat-item"><div class="stat-number" id="total-received">‚Ç®0</div><div class="stat-label" id="lbl-total-received">Total Received</div></div>
      </div>
      <button class="btn btn-primary" onclick="loadPayments()" style="margin-bottom:15px;" id="btn-refresh-pay">üîÑ Refresh</button>
      <div id="payments-list"></div>
    </div>

    <!-- SEARCH TAB -->
    <div id="search-tab" class="tab-content">
      <div class="form-group"><label id="lbl-search-reg">Search by Registration Number</label><input type="text" id="search-input" placeholder="e.g., ABC-123" style="text-transform:uppercase"></div>
      <div class="form-group"><label id="lbl-filter-emp">Filter by Employee</label><select id="search-employee"><option value="">All Employees</option></select></div>
      <button class="btn btn-primary" onclick="performSearch()" id="btn-search">üîç Search</button>
      <div id="search-results"></div>
    </div>

    <!-- ALL TAB -->
    <div id="all-tab" class="tab-content">
      <div class="stats"><div class="stat-item"><div class="stat-number" id="total-receipts">0</div><div class="stat-label" id="lbl-total-receipts">Total Receipts</div></div></div>
      <button class="btn btn-primary" onclick="loadAllReceipts()" style="margin-bottom:15px;" id="btn-refresh-all">üîÑ Refresh</button>
      <div id="all-receipts"></div>
    </div>

    <!-- PROFIT TAB -->
    <div id="profit-tab" class="tab-content">
      <h3 style="color:#00D4FF;margin-bottom:20px;text-align:center;font-weight:800;">üíµ <span id="lbl-profit-title">Profit &amp; Loss</span></h3>
      <div style="background:linear-gradient(135deg,#00D4FF 0%,#6B46C1 100%);padding:20px;border-radius:15px;color:white;margin-bottom:20px;">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px;">
          <div><div style="font-size:12px;opacity:.9" id="lbl-tot-rev">Total Revenue</div><div style="font-size:18px;font-weight:700;word-break:break-all;line-height:1.2" id="profit-revenue">‚Ç®0</div></div>
          <div><div style="font-size:12px;opacity:.9" id="lbl-purch-cost-p">Purchase Cost</div><div style="font-size:18px;font-weight:700;word-break:break-all;line-height:1.2" id="profit-purchase">‚Ç®0</div></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px;">
          <div><div style="font-size:12px;opacity:.9" id="lbl-tot-exp">Total Expenses</div><div style="font-size:18px;font-weight:700;word-break:break-all;line-height:1.2" id="profit-expenses">‚Ç®0</div></div>
          <div><div style="font-size:12px;opacity:.9" id="lbl-profit-margin">Profit Margin</div><div style="font-size:18px;font-weight:700;line-height:1.2" id="profit-margin">0%</div></div>
        </div>
        <div style="border-top:2px solid rgba(255,255,255,.3);padding-top:15px;margin-top:15px;">
          <div style="font-size:14px;opacity:.9" id="lbl-net-profit">Net Profit</div>
          <div style="font-size:26px;font-weight:700;word-break:break-all;line-height:1.2" id="profit-net">‚Ç®0</div>
        </div>
      </div>
      <button class="btn btn-primary" onclick="openExportModal()" style="margin-bottom:15px;">
        üìä Export Reports
      </button>
      <button class="btn btn-primary" onclick="calculateProfit()" style="margin-bottom:15px;" id="btn-refresh-profit">üîÑ Refresh</button>
      <!-- Profit Charts -->
      <div style="margin-bottom:30px;">
        <h4 style="color:#00D4FF;margin-bottom:15px;font-weight:700;">üìà Profit Visualization</h4>
        <div class="chart-container">
          <canvas id="profitChart" height="200"></canvas>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px;">
          <div class="chart-container">
            <canvas id="expenseChart" height="150"></canvas>
          </div>
          <div class="chart-container">
            <canvas id="marginChart" height="150"></canvas>
          </div>
        </div>
      </div>
      
      <h4 style="color:#00D4FF;margin:20px 0 15px 0;font-weight:700;" id="lbl-profit-by-car">Profit by Car</h4>
      <div id="profit-breakdown"></div>
    </div>

    <!-- ANALYTICS TAB -->
    <div id="analytics-tab" class="tab-content">
      <h3 style="color:#00D4FF;margin-bottom:20px;text-align:center;font-weight:800;">üìä <span id="lbl-analytics">Sales Analytics</span></h3>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:15px;margin-bottom:25px;">
        <div style="background:linear-gradient(135deg,#00D4FF 0%,#6B46C1 100%);padding:20px;border-radius:10px;color:white;text-align:center;">
          <div style="font-size:28px;font-weight:700" id="total-cars">0</div>
          <div style="font-size:12px;margin-top:5px" id="lbl-total-cars">Total Cars Sold</div>
        </div>
        <div style="background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%);padding:20px;border-radius:10px;color:white;text-align:center;">
          <div style="font-size:22px;font-weight:700;word-break:break-all" id="total-revenue">‚Ç®0</div>
          <div style="font-size:12px;margin-top:5px" id="lbl-total-rev-a">Total Revenue</div>
        </div>
      </div>
      <div style="background:rgba(0,212,255,.1);padding:15px;border-radius:10px;margin-bottom:20px;border:1px solid rgba(0,212,255,.2);">
        <h4 style="color:#00D4FF;margin-bottom:15px;font-weight:700;">üèÜ <span id="lbl-top-sales">Top Salespeople</span></h4>
        <div id="top-salespeople-list"></div>
      </div>
      <div style="background:rgba(0,212,255,.1);padding:15px;border-radius:10px;margin-bottom:20px;border:1px solid rgba(0,212,255,.2);">
        <h4 style="color:#00D4FF;margin-bottom:15px;font-weight:700;">üöó <span id="lbl-best-cars">Best Selling Cars</span></h4>
        <div id="best-selling-list"></div>
      </div>
      <div style="background:rgba(0,212,255,.1);padding:20px;border-radius:10px;margin-bottom:20px;border:1px solid rgba(0,212,255,.2);">
        <h4 style="color:#00D4FF;margin-bottom:15px;font-weight:700;">üìÖ <span id="lbl-this-week">This Week</span></h4>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
          <div><div style="font-size:12px;color:#666" id="lbl-cars-sold-w">Cars Sold</div><div style="font-size:24px;font-weight:700;color:#00D4FF" id="week-cars">0</div></div>
          <div><div style="font-size:12px;color:#666" id="lbl-rev-w">Revenue</div><div style="font-size:22px;font-weight:700;color:#11998e;word-break:break-all" id="week-revenue">‚Ç®0</div></div>
        </div>
      </div>
      <div style="background:rgba(0,212,255,.1);padding:20px;border-radius:10px;margin-bottom:20px;border:1px solid rgba(0,212,255,.2);">
        <h4 style="color:#00D4FF;margin-bottom:15px;font-weight:700;">üìÜ <span id="lbl-this-month">This Month</span></h4>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
          <div><div style="font-size:12px;color:#666" id="lbl-cars-sold-m">Cars Sold</div><div style="font-size:24px;font-weight:700;color:#00D4FF" id="month-cars">0</div></div>
          <div><div style="font-size:12px;color:#666" id="lbl-rev-m">Revenue</div><div style="font-size:22px;font-weight:700;color:#11998e;word-break:break-all" id="month-revenue">‚Ç®0</div></div>
        </div>
      </div>
      <button class="btn btn-primary" onclick="calculateAnalytics()" style="margin-bottom:15px;" id="btn-refresh-analytics">üîÑ Refresh Analytics</button>
    </div>

    <div style="text-align:center;padding:20px 0 100px 0;color:#00D4FF;font-size:13px;font-weight:700;">Created by WM ‚ù§Ô∏è</div>

    <!-- BOTTOM NAV -->
    <div class="tab-buttons">
      <button class="tab-btn active" onclick="switchTab('upload',event)"><span class="tab-icon">üì§</span><span id="tab-upload">Upload</span></button>
      <button class="tab-btn" onclick="switchTab('payments',event)"><span class="tab-icon">üí∞</span><span id="tab-payments">Payments</span><span class="badge hidden" id="payment-badge">0</span></button>
      <button class="tab-btn" onclick="switchTab('search',event)"><span class="tab-icon">üîç</span><span id="tab-search">Search</span></button>
      <button class="tab-btn" onclick="switchTab('all',event)"><span class="tab-icon">üìã</span><span id="tab-all">All</span></button>
      <button class="tab-btn" onclick="switchTab('profit',event)"><span class="tab-icon">üíµ</span><span id="tab-profit">Profit</span></button>
      <button class="tab-btn" onclick="switchTab('analytics',event)"><span class="tab-icon">üìä</span><span id="tab-analytics">Stats</span></button>
    </div>
  </div>
</div>

<!-- RECEIPT MODAL -->
<div id="modal" class="modal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeModal()" id="btn-close-modal">‚úï Close</button>
    <img id="modal-image" class="modal-image">
    <div style="text-align:center;margin-top:15px;">
      <div style="color:white;font-size:20px;font-weight:700" id="modal-reg"></div>
      <div style="color:white;font-size:14px;margin-top:5px" id="modal-details"></div>
      <div id="modal-installments" style="margin-top:15px;"></div>
      <div style="margin-top:15px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
        <button class="btn btn-primary" onclick="downloadReceipt()" id="btn-download" style="width:auto;padding:10px 20px;background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%);">üíæ Download</button>
        <button class="btn btn-primary" onclick="editReceipt()" id="btn-edit" style="width:auto;padding:10px 20px;background:linear-gradient(135deg,#D4AF37 0%,#FFD700 100%);color:#333;">‚úèÔ∏è Edit</button>
        <button class="btn btn-primary" onclick="openDriveLink()" id="btn-drive" style="width:auto;padding:10px 20px;">üìÅ Drive</button>
        <button class="delete-btn" onclick="deleteReceipt()" id="btn-delete">üóëÔ∏è Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- EDIT MODAL -->
<div id="edit-modal" class="modal">
  <div class="modal-content" style="max-width:600px;">
    <button class="close-modal" onclick="closeEditModal()" id="btn-close-edit">‚úï Close</button>
    <div style="background:white;padding:30px;border-radius:16px;margin-top:50px;">
      <h3 style="color:#00D4FF;margin-bottom:20px;font-weight:800;text-align:center;">‚úèÔ∏è <span id="lbl-edit-title">Edit Receipt</span></h3>
      <div class="success-msg" id="edit-success"></div>
      <div class="error-msg" id="edit-error"></div>
      <div class="form-group"><label id="lbl-edit-car">Car Name/Model</label><input type="text" id="edit-car-name"></div>
      <div class="form-group"><label id="lbl-edit-reg">Registration Number</label><input type="text" id="edit-reg-number" style="text-transform:uppercase"></div>
      <div class="form-group"><label id="lbl-edit-cust">Customer Name</label><input type="text" id="edit-customer-name"></div>
      <div class="form-group"><label id="lbl-edit-phone">Customer Phone</label><input type="text" id="edit-customer-phone"></div>
      <div class="form-group"><label id="lbl-edit-date">Selling Date</label><input type="date" id="edit-selling-date"></div>
      <div class="form-group"><label id="lbl-edit-price">Selling Price (PKR)</label><input type="number" id="edit-selling-price" min="0" step="1000"></div>
      <div class="form-group"><label id="lbl-edit-cost">Purchase Cost (PKR)</label><input type="number" id="edit-purchase-cost" min="0" step="1000"></div>
      <div class="form-group"><label id="lbl-edit-sold">Sold By</label><select id="edit-sold-by"><option value="">Select Employee</option></select></div>
      <button class="btn btn-primary" onclick="saveEditedReceipt()" id="btn-save-edit">üíæ Save Changes</button>
      <button class="btn" onclick="closeEditModal()" id="btn-cancel-edit" style="background:#6c757d;color:white;margin-top:10px;">Cancel</button>
    </div>
  </div>
</div>

<script>
const CONFIG = {
  PASSWORD: 'hasnain123',
  SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbzAaxqPHhGV9sLotNqpSLQXNliyZJyqywB31WGOUOmxRYHgF2zA8_ZDQYKqSSDk_PjDEA/exec'
};

// ===================== FULL TRANSLATIONS =====================
const LANG = {
  en: {
    'login-title':'üöó CAR SHOWROOM MANAGER','login-sub':'Premium Sales Management System',
    'lbl-password':'Password','btn-login':'üîì Login','login-error':'‚ùå Incorrect password',
    'header-title':'üöó CAR SHOWROOM MANAGER','lbl-overdue':'Overdue',
    'lbl-employees':'Employees','lbl-logout':'Logout','lang-text':'ÿßÿ±ÿØŸà',
    'lbl-install':'üì± Install this app for easier access!','btn-install':'Install',
    'lbl-car-name':'Car Name/Model *','lbl-reg-number':'Car Registration Number *',
    'lbl-cust-name':'Customer Name *','lbl-cust-phone':'Customer Phone *',
    'lbl-sell-date':'Selling Date *','lbl-sell-price':'Selling Price (PKR) *',
    'lbl-purch-cost':'Purchase Cost (PKR) *',
    'lbl-purch-hint':'üí° How much did you pay to buy this car?',
    'lbl-expenses':'Additional Expenses (Optional)',
    'lbl-exp-hint':'Repairs, maintenance, modifications, etc.',
    'btn-add-expense':'‚ûï Add Expense','lbl-pay-type':'Payment Type *',
    'lbl-cash':'Cash (Full Payment)','lbl-inst':'Installment',
    'lbl-down':'Down Payment (PKR) *','lbl-inst-count':'Number of Installments *',
    'lbl-sold-by':'Sold By (Employee) *','lbl-receipt-photo':'Receipt Photo *',
    'btn-save-receipt':'üíæ Save Receipt',
    'lbl-pay-track':'Payment Tracking','lbl-overdue-title':'‚ö†Ô∏è Overdue Payments!',
    'lbl-upcoming-title':'üìÖ Upcoming Payments',
    'lbl-total-pending':'Total Pending','lbl-total-received':'Total Received',
    'btn-refresh-pay':'üîÑ Refresh',
    'lbl-search-reg':'Search by Registration Number','lbl-filter-emp':'Filter by Employee',
    'btn-search':'üîç Search',
    'lbl-total-receipts':'Total Receipts','btn-refresh-all':'üîÑ Refresh',
    'lbl-profit-title':'Profit & Loss','lbl-tot-rev':'Total Revenue',
    'lbl-purch-cost-p':'Purchase Cost','lbl-tot-exp':'Total Expenses',
    'lbl-profit-margin':'Profit Margin','lbl-net-profit':'Net Profit',
    'lbl-exp-sales':'Sales','lbl-exp-profit':'Profit',
    'lbl-exp-payments':'Payments','lbl-exp-expenses':'Expenses',
    'btn-refresh-profit':'üîÑ Refresh','lbl-profit-by-car':'Profit by Car',
    'lbl-analytics':'Sales Analytics','lbl-total-cars':'Total Cars Sold',
    'lbl-total-rev-a':'Total Revenue','lbl-top-sales':'Top Salespeople',
    'lbl-best-cars':'Best Selling Cars','lbl-this-week':'This Week',
    'lbl-this-month':'This Month','lbl-cars-sold-w':'Cars Sold','lbl-rev-w':'Revenue',
    'lbl-cars-sold-m':'Cars Sold','lbl-rev-m':'Revenue',
    'btn-refresh-analytics':'üîÑ Refresh Analytics',
    'btn-close-modal':'‚úï Close','btn-download':'üíæ Download',
    'btn-edit':'‚úèÔ∏è Edit','btn-drive':'üìÅ Drive','btn-delete':'üóëÔ∏è Delete',
    'btn-close-edit':'‚úï Close','lbl-edit-title':'Edit Receipt',
    'lbl-edit-car':'Car Name/Model','lbl-edit-reg':'Registration Number',
    'lbl-edit-cust':'Customer Name','lbl-edit-phone':'Customer Phone',
    'lbl-edit-date':'Selling Date','lbl-edit-price':'Selling Price (PKR)',
    'lbl-edit-cost':'Purchase Cost (PKR)','lbl-edit-sold':'Sold By',
    'btn-save-edit':'üíæ Save Changes','btn-cancel-edit':'Cancel',
    'tab-upload':'Upload','tab-payments':'Payments','tab-search':'Search',
    'tab-all':'All','tab-profit':'Profit','tab-analytics':'Stats'
  },
  ur: {
    'login-title':'üöó ⁄©ÿßÿ± ÿ¥Ÿà ÿ±ŸàŸÖ ŸÖ€åŸÜ€åÿ¨ÿ±','login-sub':'Ÿæÿ±€åŸÖ€åŸÖ ÿ≥€åŸÑÿ≤ ŸÖ€åŸÜÿ¨ŸÖŸÜŸπ ÿ≥ÿ≥ŸπŸÖ',
    'lbl-password':'Ÿæÿßÿ≥ Ÿàÿ±⁄à','btn-login':'üîì ŸÑÿß⁄Ø ÿßŸÜ','login-error':'‚ùå ÿ∫ŸÑÿ∑ Ÿæÿßÿ≥ Ÿàÿ±⁄à',
    'header-title':'üöó ⁄©ÿßÿ± ÿ¥Ÿà ÿ±ŸàŸÖ ŸÖ€åŸÜ€åÿ¨ÿ±','lbl-overdue':'ÿßÿØÿßÿ¶€å⁄Ø€å ÿ®ÿßŸÇ€å',
    'lbl-employees':'ŸÖŸÑÿßÿ≤ŸÖ€åŸÜ','lbl-logout':'ŸÑÿß⁄Ø ÿ¢ÿ§Ÿπ','lang-text':'English',
    'lbl-install':'üì± ÿ¢ÿ≥ÿßŸÜ ÿ±ÿ≥ÿßÿ¶€å ⁄©€í ŸÑ€å€í ÿßŸÜÿ≥ŸπÿßŸÑ ⁄©ÿ±€å⁄∫!','btn-install':'ÿßŸÜÿ≥ŸπÿßŸÑ',
    'lbl-car-name':'⁄Øÿß⁄ë€å ⁄©ÿß ŸÜÿßŸÖ/ŸÖÿß⁄àŸÑ *','lbl-reg-number':'ÿ±ÿ¨ÿ≥Ÿπÿ±€åÿ¥ŸÜ ŸÜŸÖÿ®ÿ± *',
    'lbl-cust-name':'⁄Øÿß€Å⁄© ⁄©ÿß ŸÜÿßŸÖ *','lbl-cust-phone':'⁄Øÿß€Å⁄© ⁄©ÿß ŸÅŸàŸÜ *',
    'lbl-sell-date':'ŸÅÿ±ŸàÿÆÿ™ ⁄©€å ÿ™ÿßÿ±€åÿÆ *','lbl-sell-price':'ŸÅÿ±ŸàÿÆÿ™ ⁄©€å ŸÇ€åŸÖÿ™ (PKR) *',
    'lbl-purch-cost':'ÿÆÿ±€åÿØÿßÿ±€å ⁄©€å ŸÇ€åŸÖÿ™ (PKR) *',
    'lbl-purch-hint':'üí° ÿ¢Ÿæ ŸÜ€í €å€Å ⁄Øÿß⁄ë€å ⁄©ÿ™ŸÜ€í ŸÖ€å⁄∫ ÿÆÿ±€åÿØ€åÿü',
    'lbl-expenses':'ÿßÿ∂ÿßŸÅ€å ÿßÿÆÿ±ÿßÿ¨ÿßÿ™ (ÿßÿÆÿ™€åÿßÿ±€å)',
    'lbl-exp-hint':'ŸÖÿ±ŸÖÿ™ÿå ÿØ€å⁄©⁄æ ÿ®⁄æÿßŸÑÿå ÿ™ÿ®ÿØ€åŸÑ€åÿß⁄∫ Ÿàÿ∫€åÿ±€Å',
    'btn-add-expense':'‚ûï ÿßÿÆÿ±ÿßÿ¨ÿßÿ™ ÿ¥ÿßŸÖŸÑ ⁄©ÿ±€å⁄∫','lbl-pay-type':'ÿßÿØÿßÿ¶€å⁄Ø€å ⁄©€å ŸÇÿ≥ŸÖ *',
    'lbl-cash':'ŸÜŸÇÿØ (ŸÖ⁄©ŸÖŸÑ ÿßÿØÿßÿ¶€å⁄Ø€å)','lbl-inst':'ŸÇÿ≥ÿ∑€å⁄∫',
    'lbl-down':'Ÿæ€åÿ¥⁄Ø€å ÿßÿØÿßÿ¶€å⁄Ø€å (PKR) *','lbl-inst-count':'ŸÇÿ≥ÿ∑Ÿà⁄∫ ⁄©€å ÿ™ÿπÿØÿßÿØ *',
    'lbl-sold-by':'ŸÅÿ±ŸàÿÆÿ™ ⁄©ŸÜŸÜÿØ€Å (ŸÖŸÑÿßÿ≤ŸÖ) *','lbl-receipt-photo':'ÿ±ÿ≥€åÿØ ⁄©€å ÿ™ÿµŸà€åÿ± *',
    'btn-save-receipt':'üíæ ÿ±ÿ≥€åÿØ ŸÖÿ≠ŸÅŸàÿ∏ ⁄©ÿ±€å⁄∫',
    'lbl-pay-track':'ÿßÿØÿßÿ¶€å⁄Ø€å Ÿπÿ±€å⁄©ŸÜ⁄Ø','lbl-overdue-title':'‚ö†Ô∏è ÿßÿØÿßÿ¶€å⁄Ø€å ŸÖ€å⁄∫ ÿ™ÿßÿÆ€åÿ±!',
    'lbl-upcoming-title':'üìÖ ÿ¢ŸÜ€í ŸàÿßŸÑ€å ÿßÿØÿßÿ¶€å⁄Ø€åÿß⁄∫',
    'lbl-total-pending':'⁄©ŸÑ ÿ®ÿßŸÇ€å','lbl-total-received':'⁄©ŸÑ ŸàÿµŸàŸÑ ÿ¥ÿØ€Å',
    'btn-refresh-pay':'üîÑ ÿ™ÿßÿ≤€Å ⁄©ÿ±€å⁄∫',
    'lbl-search-reg':'ÿ±ÿ¨ÿ≥Ÿπÿ±€åÿ¥ŸÜ ŸÜŸÖÿ®ÿ± ÿ≥€í ÿ™ŸÑÿßÿ¥','lbl-filter-emp':'ŸÖŸÑÿßÿ≤ŸÖ ÿ≥€í ŸÅŸÑŸπÿ± ⁄©ÿ±€å⁄∫',
    'btn-search':'üîç ÿ™ŸÑÿßÿ¥',
    'lbl-total-receipts':'⁄©ŸÑ ÿ±ÿ≥€åÿØ€å⁄∫','btn-refresh-all':'üîÑ ÿ™ÿßÿ≤€Å ⁄©ÿ±€å⁄∫',
    'lbl-profit-title':'ŸÖŸÜÿßŸÅÿπ ÿßŸàÿ± ŸÜŸÇÿµÿßŸÜ','lbl-tot-rev':'⁄©ŸÑ ÿ¢ŸÖÿØŸÜ€å',
    'lbl-purch-cost-p':'ÿÆÿ±€åÿØÿßÿ±€å ⁄©€å ŸÑÿß⁄Øÿ™','lbl-tot-exp':'⁄©ŸÑ ÿßÿÆÿ±ÿßÿ¨ÿßÿ™',
    'lbl-profit-margin':'ŸÖŸÜÿßŸÅÿπ ⁄©ÿß ŸÖÿßÿ±ÿ¨ŸÜ','lbl-net-profit':'ÿÆÿßŸÑÿµ ŸÖŸÜÿßŸÅÿπ',
    'lbl-exp-sales':'ŸÅÿ±ŸàÿÆÿ™','lbl-exp-profit':'ŸÖŸÜÿßŸÅÿπ',
    'lbl-exp-payments':'ÿßÿØÿßÿ¶€å⁄Ø€åÿß⁄∫','lbl-exp-expenses':'ÿßÿÆÿ±ÿßÿ¨ÿßÿ™',
    'btn-refresh-profit':'üîÑ ÿ™ÿßÿ≤€Å ⁄©ÿ±€å⁄∫','lbl-profit-by-car':'⁄Øÿß⁄ë€å ⁄©€í ŸÑÿ≠ÿßÿ∏ ÿ≥€í ŸÖŸÜÿßŸÅÿπ',
    'lbl-analytics':'ÿ≥€åŸÑÿ≤ ÿ™ÿ¨ÿ≤€å€Å','lbl-total-cars':'⁄©ŸÑ ŸÅÿ±ŸàÿÆÿ™ ÿ¥ÿØ€Å ⁄Øÿß⁄ë€åÿß⁄∫',
    'lbl-total-rev-a':'⁄©ŸÑ ÿ¢ŸÖÿØŸÜ€å','lbl-top-sales':'ÿßÿπŸÑ€åŸ∞ ŸÅÿ±ŸàÿÆÿ™ ⁄©ŸÜŸÜÿØ⁄ØÿßŸÜ',
    'lbl-best-cars':'ÿ≥ÿ® ÿ≥€í ÿ≤€åÿßÿØ€Å ŸÅÿ±ŸàÿÆÿ™ €ÅŸàŸÜ€í ŸàÿßŸÑ€å ⁄Øÿß⁄ë€åÿß⁄∫',
    'lbl-this-week':'ÿßÿ≥ €ÅŸÅÿ™€í','lbl-this-month':'ÿßÿ≥ ŸÖ€Å€åŸÜ€í',
    'lbl-cars-sold-w':'ŸÅÿ±ŸàÿÆÿ™ ÿ¥ÿØ€Å ⁄Øÿß⁄ë€åÿß⁄∫','lbl-rev-w':'ÿ¢ŸÖÿØŸÜ€å',
    'lbl-cars-sold-m':'ŸÅÿ±ŸàÿÆÿ™ ÿ¥ÿØ€Å ⁄Øÿß⁄ë€åÿß⁄∫','lbl-rev-m':'ÿ¢ŸÖÿØŸÜ€å',
    'btn-refresh-analytics':'üîÑ ÿ™ÿ¨ÿ≤€å€Å ÿ™ÿßÿ≤€Å ⁄©ÿ±€å⁄∫',
    'btn-close-modal':'‚úï ÿ®ŸÜÿØ ⁄©ÿ±€å⁄∫','btn-download':'üíæ ⁄àÿßÿ§ŸÜ ŸÑŸà⁄à',
    'btn-edit':'‚úèÔ∏è ÿ™ÿ±ŸÖ€åŸÖ','btn-drive':'üìÅ ⁄àÿ±ÿßÿ¶€åŸà','btn-delete':'üóëÔ∏è ÿ≠ÿ∞ŸÅ ⁄©ÿ±€å⁄∫',
    'btn-close-edit':'‚úï ÿ®ŸÜÿØ ⁄©ÿ±€å⁄∫','lbl-edit-title':'ÿ±ÿ≥€åÿØ ŸÖ€å⁄∫ ÿ™ÿ±ŸÖ€åŸÖ',
    'lbl-edit-car':'⁄Øÿß⁄ë€å ⁄©ÿß ŸÜÿßŸÖ/ŸÖÿß⁄àŸÑ','lbl-edit-reg':'ÿ±ÿ¨ÿ≥Ÿπÿ±€åÿ¥ŸÜ ŸÜŸÖÿ®ÿ±',
    'lbl-edit-cust':'⁄Øÿß€Å⁄© ⁄©ÿß ŸÜÿßŸÖ','lbl-edit-phone':'⁄Øÿß€Å⁄© ⁄©ÿß ŸÅŸàŸÜ',
    'lbl-edit-date':'ŸÅÿ±ŸàÿÆÿ™ ⁄©€å ÿ™ÿßÿ±€åÿÆ','lbl-edit-price':'ŸÅÿ±ŸàÿÆÿ™ ⁄©€å ŸÇ€åŸÖÿ™ (PKR)',
    'lbl-edit-cost':'ÿÆÿ±€åÿØÿßÿ±€å ⁄©€å ŸÇ€åŸÖÿ™ (PKR)','lbl-edit-sold':'ŸÅÿ±ŸàÿÆÿ™ ⁄©ŸÜŸÜÿØ€Å',
    'btn-save-edit':'üíæ ÿ™ÿ®ÿØ€åŸÑ€åÿß⁄∫ ŸÖÿ≠ŸÅŸàÿ∏ ⁄©ÿ±€å⁄∫','btn-cancel-edit':'ŸÖŸÜÿ≥ŸàÿÆ ⁄©ÿ±€å⁄∫',
    'tab-upload':'ÿßŸæ ŸÑŸà⁄à','tab-payments':'ÿßÿØÿßÿ¶€å⁄Ø€åÿß⁄∫','tab-search':'ÿ™ŸÑÿßÿ¥',
    'tab-all':'ÿ™ŸÖÿßŸÖ','tab-profit':'ŸÖŸÜÿßŸÅÿπ','tab-analytics':'ÿßÿπÿØÿßÿØŸàÿ¥ŸÖÿßÿ±'
  },
  ar: {
    'login-title':'üöó ŸÖÿØŸäÿ± ÿµÿßŸÑÿ© ÿßŸÑÿ≥Ÿäÿßÿ±ÿßÿ™','login-sub':'ŸÜÿ∏ÿßŸÖ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™ ÿßŸÑŸÖÿ™ŸÖŸäÿ≤',
    'lbl-password':'ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±','btn-login':'üîì ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ','login-error':'‚ùå ŸÉŸÑŸÖÿ© ŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©',
    'header-title':'üöó ŸÖÿØŸäÿ± ÿµÿßŸÑÿ© ÿßŸÑÿ≥Ÿäÿßÿ±ÿßÿ™','lbl-overdue':'ŸÖÿ™ÿ£ÿÆÿ±',
    'lbl-employees':'ÿßŸÑŸÖŸàÿ∏ŸÅŸàŸÜ','lbl-logout':'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿÆÿ±Ÿàÿ¨','lang-text':'English',
    'tab-upload':'ÿ™ÿ≠ŸÖŸäŸÑ','tab-payments':'ÿßŸÑŸÖÿØŸÅŸàÿπÿßÿ™','tab-search':'ÿ®ÿ≠ÿ´',
    'tab-all':'ÿßŸÑŸÉŸÑ','tab-profit':'ÿßŸÑÿ±ÿ®ÿ≠','tab-analytics':'ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™'
  },
  hi: {
    'login-title':'üöó ‡§ï‡§æ‡§∞ ‡§∂‡•ã‡§∞‡•Ç‡§Æ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§ï','login-sub':'‡§™‡•ç‡§∞‡•Ä‡§Æ‡§ø‡§Ø‡§Æ ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§® ‡§™‡•ç‡§∞‡§£‡§æ‡§≤‡•Ä',
    'lbl-password':'‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°','btn-login':'üîì ‡§≤‡•â‡§ó‡§ø‡§®','login-error':'‚ùå ‡§ó‡§≤‡§§ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°',
    'header-title':'üöó ‡§ï‡§æ‡§∞ ‡§∂‡•ã‡§∞‡•Ç‡§Æ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§ï','lbl-overdue':'‡§¨‡§ï‡§æ‡§Ø‡§æ',
    'lbl-employees':'‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä','lbl-logout':'‡§≤‡•â‡§ó ‡§Ü‡§â‡§ü','lang-text':'English',
    'tab-upload':'‡§Ö‡§™‡§≤‡•ã‡§°','tab-payments':'‡§≠‡•Å‡§ó‡§§‡§æ‡§®','tab-search':'‡§ñ‡•ã‡§ú',
    'tab-all':'‡§∏‡§≠‡•Ä','tab-profit':'‡§≤‡§æ‡§≠','tab-analytics':'‡§Ü‡§Ç‡§ï‡§°‡§º‡•á'
  },
  zh: {
    'login-title':'üöó Ê±ΩËΩ¶Â±ïÂéÖÁªèÁêÜ','login-sub':'È´òÁ∫ßÈîÄÂîÆÁÆ°ÁêÜÁ≥ªÁªü',
    'lbl-password':'ÂØÜÁ†Å','btn-login':'üîì ÁôªÂΩï','login-error':'‚ùå ÂØÜÁ†ÅÈîôËØØ',
    'header-title':'üöó Ê±ΩËΩ¶Â±ïÂéÖÁªèÁêÜ','lbl-overdue':'ÈÄæÊúü',
    'lbl-employees':'ÂëòÂ∑•','lbl-logout':'ÁôªÂá∫','lang-text':'English',
    'tab-upload':'‰∏ä‰º†','tab-payments':'‰ªòÊ¨æ','tab-search':'ÊêúÁ¥¢',
    'tab-all':'ÂÖ®ÈÉ®','tab-profit':'Âà©Ê∂¶','tab-analytics':'ÁªüËÆ°'
  },
  es: {
    'login-title':'üöó Gestor de Concesionario','login-sub':'Sistema Premium de Gesti√≥n de Ventas',
    'lbl-password':'Contrase√±a','btn-login':'üîì Iniciar Sesi√≥n','login-error':'‚ùå Contrase√±a incorrecta',
    'header-title':'üöó Gestor de Concesionario','lbl-overdue':'Vencido',
    'lbl-employees':'Empleados','lbl-logout':'Cerrar Sesi√≥n','lang-text':'English',
    'tab-upload':'Subir','tab-payments':'Pagos','tab-search':'Buscar',
    'tab-all':'Todo','tab-profit':'Beneficio','tab-analytics':'Estad√≠sticas'
  },
  fr: {
    'login-title':'üöó Gestionnaire de Concession','login-sub':'Syst√®me Premium de Gestion des Ventes',
    'lbl-password':'Mot de passe','btn-login':'üîì Connexion','login-error':'‚ùå Mot de passe incorrect',
    'header-title':'üöó Gestionnaire de Concession','lbl-overdue':'En retard',
    'lbl-employees':'Employ√©s','lbl-logout':'D√©connexion','lang-text':'English',
    'tab-upload':'T√©l√©charger','tab-payments':'Paiements','tab-search':'Rechercher',
    'tab-all':'Tout','tab-profit':'Profit','tab-analytics':'Statistiques'
  },
  de: {
    'login-title':'üöó Autohaus Manager','login-sub':'Premium Verkaufs-Management-System',
    'lbl-password':'Passwort','btn-login':'üîì Anmelden','login-error':'‚ùå Falsches Passwort',
    'header-title':'üöó Autohaus Manager','lbl-overdue':'√úberf√§llig',
    'lbl-employees':'Mitarbeiter','lbl-logout':'Abmelden','lang-text':'English',
    'tab-upload':'Hochladen','tab-payments':'Zahlungen','tab-search':'Suchen',
    'tab-all':'Alle','tab-profit':'Gewinn','tab-analytics':'Statistiken'
  },
  tr: {
    'login-title':'üöó Oto Galerisi Y√∂neticisi','login-sub':'Premium Satƒ±≈ü Y√∂netim Sistemi',
    'lbl-password':'≈ûifre','btn-login':'üîì Giri≈ü','login-error':'‚ùå Yanlƒ±≈ü ≈üifre',
    'header-title':'üöó Oto Galerisi Y√∂neticisi','lbl-overdue':'Gecikmi≈ü',
    'lbl-employees':'√áalƒ±≈üanlar','lbl-logout':'√áƒ±kƒ±≈ü','lang-text':'English',
    'tab-upload':'Y√ºkle','tab-payments':'√ñdemeler','tab-search':'Ara',
    'tab-all':'T√ºm√º','tab-profit':'K√¢r','tab-analytics':'ƒ∞statistikler'
  },
  ru: {
    'login-title':'üöó –ú–µ–Ω–µ–¥–∂–µ—Ä –ê–≤—Ç–æ—Å–∞–ª–æ–Ω–∞','login-sub':'–ü—Ä–µ–º–∏—É–º –°–∏—Å—Ç–µ–º–∞ –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ü—Ä–æ–¥–∞–∂–∞–º–∏',
    'lbl-password':'–ü–∞—Ä–æ–ª—å','btn-login':'üîì –í–æ–π—Ç–∏','login-error':'‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å',
    'header-title':'üöó –ú–µ–Ω–µ–¥–∂–µ—Ä –ê–≤—Ç–æ—Å–∞–ª–æ–Ω–∞','lbl-overdue':'–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ',
    'lbl-employees':'–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏','lbl-logout':'–í—ã–π—Ç–∏','lang-text':'English',
    'tab-upload':'–ó–∞–≥—Ä—É–∑–∏—Ç—å','tab-payments':'–ü–ª–∞—Ç–µ–∂–∏','tab-search':'–ü–æ–∏—Å–∫',
    'tab-all':'–í—Å–µ','tab-profit':'–ü—Ä–∏–±—ã–ª—å','tab-analytics':'–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞'
  }
};

let currentLang = localStorage.getItem('lang') || 'en';
let employeesList = JSON.parse(localStorage.getItem('employees')) || [];
let currentViewingReceipt = null;
let allReceiptsCache = [];
let allInstallmentsCache = [];
let allExpensesCache = [];
let expenseFieldCount = 0;
let deferredPrompt;

// ===================== LANGUAGE =====================
function applyLanguage() {
  const t = LANG[currentLang] || LANG['en'];
  // Remove all language classes
  document.body.classList.remove('urdu','arabic','hindi','chinese','spanish','french','german','turkish','russian');
  // Add current language class
  if (currentLang !== 'en') {
    document.body.classList.add(currentLang === 'ur' ? 'urdu' : 
                                 currentLang === 'ar' ? 'arabic' :
                                 currentLang === 'hi' ? 'hindi' :
                                 currentLang === 'zh' ? 'chinese' :
                                 currentLang === 'es' ? 'spanish' :
                                 currentLang === 'fr' ? 'french' :
                                 currentLang === 'de' ? 'german' :
                                 currentLang === 'tr' ? 'turkish' :
                                 currentLang === 'ru' ? 'russian' : '');
  }
  // Update every translatable element by id
  Object.keys(t).forEach(id => {
    const el = document.getElementById(id);
    if (el) el.innerHTML = t[id];
  });
}

function toggleLanguage() {
  const langs = ['en','ur','ar','hi','zh','es','fr','de','tr','ru'];
  const currentIndex = langs.indexOf(currentLang);
  currentLang = langs[(currentIndex + 1) % langs.length];
  localStorage.setItem('lang', currentLang);
  applyLanguage();
}

// ===================== EMPLOYEES =====================
function loadEmployeesIntoDropdowns() {
  ['sold-by','search-employee'].forEach(id => {
    const sel = document.getElementById(id);
    if (!sel) return;
    const first = sel.options[0].textContent;
    sel.innerHTML = `<option value="">${first}</option>`;
    employeesList.forEach(e => { const o = document.createElement('option'); o.value = o.textContent = e; sel.appendChild(o); });
  });
}

function manageEmployees() {
  const a = prompt('üë• Manage Employees\n\n1 - View All\n2 - Add New\n3 - Remove\n\nEnter choice (1/2/3):');
  if (a === '1') { alert(employeesList.length ? 'Employees:\n' + employeesList.join('\n') : 'No employees yet.'); }
  else if (a === '2') {
    const n = prompt('Enter employee name:');
    if (n && n.trim() && !employeesList.includes(n.trim())) {
      employeesList.push(n.trim()); employeesList.sort();
      localStorage.setItem('employees', JSON.stringify(employeesList));
      loadEmployeesIntoDropdowns(); alert('‚úÖ Added: ' + n.trim());
    }
  } else if (a === '3') {
    const r = prompt('Remove:\n' + employeesList.join('\n') + '\n\nEnter name:');
    const i = employeesList.indexOf(r && r.trim());
    if (i > -1) { employeesList.splice(i,1); localStorage.setItem('employees', JSON.stringify(employeesList)); loadEmployeesIntoDropdowns(); alert('‚úÖ Removed'); }
  }
}

// ===================== EXPENSES =====================
function addExpenseField() {
  expenseFieldCount++;
  const c = document.getElementById('expenses-container');
  const d = document.createElement('div');
  d.className = 'installment-item'; d.id = 'expense-' + expenseFieldCount; d.style.marginBottom = '10px';
  d.innerHTML = `<div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
    <select id="expense-type-${expenseFieldCount}" style="flex:1;min-width:90px;">
      <option value="Repair">Repair</option><option value="Maintenance">Maintenance</option>
      <option value="Modification">Modification</option><option value="Other">Other</option>
    </select>
    <input type="text" id="expense-desc-${expenseFieldCount}" placeholder="Description" style="flex:2;min-width:100px;">
    <input type="number" id="expense-amount-${expenseFieldCount}" placeholder="Amount" min="0" step="1000" style="flex:1;min-width:80px;">
    <button type="button" onclick="removeExpenseField(${expenseFieldCount})" class="delete-btn" style="padding:8px 12px;">‚úï</button>
  </div>`;
  c.appendChild(d);
}
function removeExpenseField(id) { const el = document.getElementById('expense-'+id); if(el) el.remove(); }

// ===================== PWA =====================
window.addEventListener('beforeinstallprompt', e => { e.preventDefault(); deferredPrompt = e; document.getElementById('install-prompt').style.display = 'flex'; });
function installApp() { if(deferredPrompt){ deferredPrompt.prompt(); deferredPrompt.userChoice.then(()=>{ deferredPrompt=null; document.getElementById('install-prompt').style.display='none'; }); } }
if ('serviceWorker' in navigator) { window.addEventListener('load', () => navigator.serviceWorker.register('sw.js').catch(()=>{})); }

// ===================== INIT =====================
document.addEventListener('DOMContentLoaded', () => {
  checkLogin(); applyLanguage(); loadEmployeesIntoDropdowns();
  document.getElementById('receipt-photo').addEventListener('change', e => {
    const f = e.target.files[0];
    if (f) { const r = new FileReader(); r.onload = ev => { const p = document.getElementById('preview'); p.src = ev.target.result; p.style.display = 'block'; }; r.readAsDataURL(f); }
  });
  document.getElementById('login-password').addEventListener('keyup', e => { if(e.key==='Enter') login(); });
  document.getElementById('selling-date').value = new Date().toISOString().split('T')[0];
});

function checkLogin() { if(sessionStorage.getItem('loggedIn')==='true') showMainApp(); else showLoginScreen(); }
function login() {
  const pw = document.getElementById('login-password').value;
  const err = document.getElementById('login-error');
  if (pw === CONFIG.PASSWORD) { sessionStorage.setItem('loggedIn','true'); showMainApp(); }
  else { err.textContent = LANG[currentLang]['login-error'] || '‚ùå Incorrect password'; err.style.display = 'block'; }
}
function logout() { sessionStorage.removeItem('loggedIn'); showLoginScreen(); }
function showLoginScreen() { document.getElementById('login-screen').classList.remove('hidden'); document.getElementById('main-app').classList.add('hidden'); }
function showMainApp() { document.getElementById('login-screen').classList.add('hidden'); document.getElementById('main-app').classList.remove('hidden'); loadAllReceipts(); loadPayments(); }

function switchTab(tab, ev) {
  if (ev) { document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); ev.target.closest('.tab-btn').classList.add('active'); }
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.getElementById(tab+'-tab').classList.add('active');
  if (tab==='all') loadAllReceipts();
  else if (tab==='analytics') calculateAnalytics();
  else if (tab==='payments') loadPayments();
  else if (tab==='profit') calculateProfit();
}
function switchTabDirect(tab) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.getElementById(tab+'-tab').classList.add('active');
  if (tab==='payments') loadPayments();
}

function toggleInstallmentSection() {
  const pt = document.querySelector('input[name="payment-type"]:checked').value;
  document.getElementById('installment-section').style.display = pt==='INSTALLMENT' ? 'block' : 'none';
  if (pt==='INSTALLMENT') generateInstallmentFields();
}
function generateInstallmentFields() {
  const cnt = parseInt(document.getElementById('installment-count').value);
  let h = '<h4 style="color:#00D4FF;margin:15px 0 10px 0;font-weight:700;">Installment Details:</h4>';
  for (let i=1; i<=cnt; i++) {
    h += `<div class="installment-item"><strong>Installment ${i}</strong>
      <div class="form-group"><label>Due Date</label><input type="date" id="inst-date-${i}"></div>
      <div class="form-group"><label>Amount (PKR)</label><input type="number" id="inst-amount-${i}" placeholder="Amount" min="0" step="1000"></div></div>`;
  }
  document.getElementById('installment-fields').innerHTML = h;
}

// ===================== UPLOAD =====================
async function uploadReceipt() {
  const v = {
    carName: document.getElementById('car-name').value.trim(),
    regNumber: document.getElementById('reg-number').value.trim().toUpperCase(),
    customerName: document.getElementById('customer-name').value.trim(),
    customerPhone: document.getElementById('customer-phone').value.trim(),
    sellingDate: document.getElementById('selling-date').value,
    sellingPrice: document.getElementById('selling-price').value.trim(),
    purchaseCost: document.getElementById('purchase-cost').value.trim(),
    soldBy: document.getElementById('sold-by').value
  };
  const expenses = [];
  for (let i=1; i<=expenseFieldCount; i++) {
    const tEl=document.getElementById(`expense-type-${i}`), dEl=document.getElementById(`expense-desc-${i}`), aEl=document.getElementById(`expense-amount-${i}`);
    if (tEl&&dEl&&aEl) { const amt=parseFloat(aEl.value)||0; if(amt>0) expenses.push({type:tEl.value, description:dEl.value.trim()||'No description', amount:amt}); }
  }
  const paymentType = document.querySelector('input[name="payment-type"]:checked').value;
  const photoFile = document.getElementById('receipt-photo').files[0];
  const sMsg = document.getElementById('upload-success'), eMsg = document.getElementById('upload-error');
  sMsg.style.display='none'; eMsg.style.display='none';
  if (!v.carName||!v.regNumber||!v.customerName||!v.customerPhone||!v.sellingDate||!v.sellingPrice||parseFloat(v.sellingPrice)<=0||!v.purchaseCost||parseFloat(v.purchaseCost)<=0||!v.soldBy||!photoFile) {
    eMsg.textContent='Please fill all required fields'; eMsg.style.display='block'; return;
  }
  let downPayment=0, installments=[];
  if (paymentType==='INSTALLMENT') {
    downPayment = parseFloat(document.getElementById('down-payment').value)||0;
    if (downPayment<=0) { eMsg.textContent='Please enter down payment'; eMsg.style.display='block'; return; }
    const cnt = parseInt(document.getElementById('installment-count').value);
    for (let i=1; i<=cnt; i++) {
      const dt=document.getElementById(`inst-date-${i}`).value, am=parseFloat(document.getElementById(`inst-amount-${i}`).value)||0;
      if (!dt||am<=0) { eMsg.textContent=`Fill installment ${i} details`; eMsg.style.display='block'; return; }
      installments.push({dueDate:dt, amount:am});
    }
    const ti = installments.reduce((s,x)=>s+x.amount,0), te = parseFloat(v.sellingPrice)-downPayment;
    if (Math.abs(ti-te)>100) { eMsg.textContent=`Installments ‚Ç®${ti.toLocaleString()} does not match remaining ‚Ç®${te.toLocaleString()}`; eMsg.style.display='block'; return; }
  }
  if (photoFile.size>10*1024*1024) { eMsg.textContent='Image too large (max 10MB)'; eMsg.style.display='block'; return; }
  const btn=event.target, origTxt=btn.innerHTML; btn.innerHTML='‚è≥ Uploading...'; btn.disabled=true;
  try {
    const imageData = await new Promise((res,rej)=>{const r=new FileReader();r.onload=e=>res(e.target.result);r.onerror=()=>rej(new Error('Failed to read image'));r.readAsDataURL(photoFile);});
    const receiptId = v.regNumber+'_'+v.sellingDate+'_'+Date.now();
    const result = await post({action:'upload', receiptId, ...v, sellingPrice:parseFloat(v.sellingPrice), purchaseCost:parseFloat(v.purchaseCost), expenses, paymentType, downPayment, installments, imageData, fileName:receiptId+'.'+photoFile.name.split('.').pop(), mimeType:photoFile.type, timestamp:new Date().toISOString()});
    if (result.success) {
      sMsg.textContent=`‚úÖ Receipt saved for ${v.carName} (${v.regNumber})`; sMsg.style.display='block';
      ['car-name','reg-number','customer-name','customer-phone','selling-price','purchase-cost','sold-by'].forEach(id=>document.getElementById(id).value='');
      document.getElementById('expenses-container').innerHTML=''; expenseFieldCount=0;
      document.getElementById('receipt-photo').value=''; document.getElementById('preview').style.display='none';
      document.querySelector('input[name="payment-type"][value="CASH"]').checked=true; toggleInstallmentSection();
      window.scrollTo(0,0);
    } else throw new Error(result.error||'Upload failed');
  } catch(err) { eMsg.textContent='‚ùå '+err.message; eMsg.style.display='block'; }
  finally { btn.innerHTML=origTxt; btn.disabled=false; }
}

// ===================== API HELPER =====================
async function post(data) {
  const res = await fetch(CONFIG.SCRIPT_URL, {method:'POST', body:JSON.stringify(data)});
  return res.json();
}

// ===================== LOAD DATA - FIXED EXPENSE MERGE =====================
async function loadAllData() {
  const result = await post({action:'getAll'});
  if (result.success) {
    allReceiptsCache = result.receipts || [];
    allInstallmentsCache = result.installments || [];
    allExpensesCache = result.expenses || [];
    // KEY FIX: merge expenses from sheet into each receipt object
    allReceiptsCache.forEach(r => {
      const sheetExps = allExpensesCache.filter(e => e.receiptId === r.receiptId);
      if (sheetExps.length > 0) {
        // Always use sheet expenses (they are the source of truth)
        r.expenses = sheetExps.map(e => ({
          type: e.expenseType || e.type || 'Other',
          description: e.description || '',
          amount: parseFloat(e.amount) || 0
        }));
      } else if (!r.expenses) {
        r.expenses = [];
      }
    });
  }
  return result;
}

async function loadAllReceipts() {
  const div = document.getElementById('all-receipts');
  div.innerHTML='<div class="loading">Loading...</div>';
  try {
    await loadAllData();
    document.getElementById('total-receipts').textContent = allReceiptsCache.length;
    if (allReceiptsCache.length > 0) {
      allReceiptsCache.sort((a,b)=>new Date(b.sellingDate)-new Date(a.sellingDate));
      div.innerHTML = allReceiptsCache.map(r => receiptCardHTML(r)).join('');
    } else {
      div.innerHTML='<div class="no-results">No receipts yet</div>';
    }
  } catch(err) { div.innerHTML='<div class="no-results">Error loading receipts</div>'; console.error(err); }
}

async function loadPayments() {
  try {
    await loadAllData();
    displayPaymentSummary(); checkOverduePayments();
  } catch(err) { console.error(err); }
}

function receiptCardHTML(r) {
  const dt = new Date(r.sellingDate).toLocaleDateString();
  const pr = '‚Ç®'+parseFloat(r.sellingPrice).toLocaleString();
  let sc='', sb='';
  if (r.paymentType==='CASH') { sb='<span class="payment-badge cash">üíµ Paid in Full</span>'; }
  else {
    const ri=allInstallmentsCache.filter(i=>i.receiptId===r.receiptId);
    const pend=ri.filter(i=>i.status==='PENDING'), over=pend.filter(i=>new Date(i.dueDate)<new Date());
    if(over.length>0){sc='overdue-payment';sb=`<span class="payment-badge pending">‚ö†Ô∏è ${over.length} Overdue</span>`;}
    else if(pend.length>0){sc='pending-payment';sb=`<span class="payment-badge installment">üìÖ ${pend.length} Pending</span>`;}
    else sb='<span class="payment-badge cash">‚úÖ Completed</span>';
  }
  const statusBadge = r.status ? `<span class="status-badge ${(r.status||'AVAILABLE').toLowerCase().replace('_','-')}">${
    r.status === 'AVAILABLE' ? 'üü¢ Available' :
    r.status === 'SOLD' ? 'üî¥ Sold' :
    r.status === 'RESERVED' ? 'üü° Reserved' :
    r.status === 'IN_SERVICE' ? 'üîµ In Service' : 'üü¢ Available'
  }</span>` : '';
  
  return `<div class="receipt-item ${sc}" onclick='viewReceiptByData(${JSON.stringify(r).replace(/'/g,"&#39;")})'>
    <div class="receipt-reg">${r.carName||'N/A'} ${statusBadge}</div>
    <div class="receipt-date">Reg: ${r.regNumber}</div>
    <div class="receipt-date">Customer: ${r.customerName||'N/A'}</div>
    <div class="receipt-date">Date: ${dt} ¬∑ Price: ${pr}</div>
    <div class="receipt-date">Sold by: ${r.soldBy||'N/A'}</div>
    ${sb}</div>`;
}

function displayPaymentSummary() {
  const ir = allReceiptsCache.filter(r=>r.paymentType==='INSTALLMENT');
  let tp=0, tr=0, pl='';
  ir.forEach(r=>{
    const ri=allInstallmentsCache.filter(i=>i.receiptId===r.receiptId);
    const pend=ri.filter(i=>i.status==='PENDING'), paid=ri.filter(i=>i.status==='PAID');
    tp+=pend.reduce((s,i)=>s+parseFloat(i.amount),0);
    tr+=parseFloat(r.downPayment||0)+paid.reduce((s,i)=>s+parseFloat(i.amount),0);
    if(pend.length>0){const ov=pend.filter(i=>new Date(i.dueDate)<new Date()); pl+=`<div class="receipt-item ${ov.length>0?'overdue-payment':'pending-payment'}" onclick='viewReceiptByData(${JSON.stringify(r).replace(/'/g,"&#39;")})'><div class="receipt-reg">${r.carName} (${r.regNumber})</div><div class="receipt-date">Customer: ${r.customerName}</div><div class="receipt-date">Pending: ‚Ç®${pend.reduce((s,i)=>s+parseFloat(i.amount),0).toLocaleString()}</div>${ov.length>0?`<span class="payment-badge pending">‚ö†Ô∏è ${ov.length} Overdue</span>`:`<span class="payment-badge installment">üìÖ ${pend.length} Pending</span>`}</div>`;}
  });
  document.getElementById('total-pending').textContent='‚Ç®'+tp.toLocaleString();
  document.getElementById('total-received').textContent='‚Ç®'+tr.toLocaleString();
  document.getElementById('payments-list').innerHTML=pl||'<div class="no-results">No pending payments</div>';
}

function checkOverduePayments() {
  const today=new Date();
  const ov=allInstallmentsCache.filter(i=>i.status==='PENDING'&&new Date(i.dueDate)<today);
  const up=allInstallmentsCache.filter(i=>{const d=new Date(i.dueDate),df=Math.ceil((d-today)/86400000);return i.status==='PENDING'&&df>=0&&df<=7;});
  if(ov.length>0){document.getElementById('overdue-badge').classList.remove('hidden');document.getElementById('overdue-count').textContent=ov.length;document.getElementById('payment-badge').classList.remove('hidden');document.getElementById('payment-badge').textContent=ov.length;}
  else{document.getElementById('overdue-badge').classList.add('hidden');document.getElementById('payment-badge').classList.add('hidden');}
  if(ov.length>0){document.getElementById('overdue-list').innerHTML=ov.map(i=>{const r=allReceiptsCache.find(x=>x.receiptId===i.receiptId);return r?`<div>‚Ä¢ ${r.carName} (${r.regNumber}) - ‚Ç®${parseFloat(i.amount).toLocaleString()} - ${Math.ceil((today-new Date(i.dueDate))/86400000)} days overdue</div>`:''}).join('');document.getElementById('overdue-alert').style.display='block';}
  else document.getElementById('overdue-alert').style.display='none';
  if(up.length>0){document.getElementById('upcoming-list').innerHTML=up.map(i=>{const r=allReceiptsCache.find(x=>x.receiptId===i.receiptId);return r?`<div>‚Ä¢ ${r.carName} (${r.regNumber}) - ‚Ç®${parseFloat(i.amount).toLocaleString()} - Due in ${Math.ceil((new Date(i.dueDate)-today)/86400000)} days</div>`:''}).join('');document.getElementById('upcoming-alert').style.display='block';}
  else document.getElementById('upcoming-alert').style.display='none';
}

async function performSearch() {
  const si=document.getElementById('search-input').value.trim().toUpperCase();
  const se=document.getElementById('search-employee').value;
  const rd=document.getElementById('search-results');
  rd.innerHTML='<div class="loading">Searching...</div>';
  if(allReceiptsCache.length===0) await loadAllData();
  let f=allReceiptsCache;
  if(si) f=f.filter(r=>r.regNumber.includes(si)||(r.carName||'').toUpperCase().includes(si)||(r.customerName||'').toUpperCase().includes(si));
  if(se) f=f.filter(r=>r.soldBy===se);
  rd.innerHTML = f.length ? f.map(r=>receiptCardHTML(r)).join('') : '<div class="no-results">‚ùå Not found</div>';
}

async function viewReceiptByData(receipt) {
  const mi=document.getElementById('modal-image');
  mi.src=`https://drive.google.com/thumbnail?id=${receipt.driveFileId}&sz=w1000`;
  mi.onerror=function(){this.src=`https://drive.google.com/uc?export=view&id=${receipt.driveFileId}`;};
  document.getElementById('modal-reg').textContent=`${receipt.carName} (${receipt.regNumber})`;
  const dt=new Date(receipt.sellingDate).toLocaleDateString();
  document.getElementById('modal-details').innerHTML=`Customer: ${receipt.customerName}<br>Phone: ${receipt.customerPhone}<br>Date: ${dt}<br>Price: ‚Ç®${parseFloat(receipt.sellingPrice).toLocaleString()}<br>Sold by: ${receipt.soldBy}<br>Payment: ${receipt.paymentType}`;
  const mi2=document.getElementById('modal-installments');
  if(receipt.paymentType==='INSTALLMENT'){
    const ri=allInstallmentsCache.filter(i=>i.receiptId===receipt.receiptId);
    let h='<div style="background:rgba(255,255,255,.1);padding:15px;border-radius:10px;margin-top:15px;">';
    h+=`<div style="color:white;font-weight:700;margin-bottom:10px;">Down Payment: ‚Ç®${parseFloat(receipt.downPayment).toLocaleString()}</div>`;
    ri.forEach(i=>{
      const ip=i.status==='PAID',io=!ip&&new Date(i.dueDate)<new Date();
      const sc=ip?'#28a745':io?'#dc3545':'#D4AF37', st=ip?'‚úÖ Paid':io?'‚ö†Ô∏è Overdue':'üìÖ Pending';
      h+=`<div style="background:rgba(255,255,255,.2);padding:10px;border-radius:8px;margin-bottom:8px;border-left:4px solid ${sc};">
        <div style="color:white;">Installment ${i.installmentNumber}: ‚Ç®${parseFloat(i.amount).toLocaleString()}</div>
        <div style="color:white;font-size:12px;">Due: ${new Date(i.dueDate).toLocaleDateString()}</div>
        <div style="color:${sc};font-weight:700;font-size:12px;">${st}</div>
        ${!ip?`<button class="btn btn-success btn-small" style="margin-top:8px;" onclick="markInstallmentPaid('${i.installmentId}',event)">Mark as Paid</button>`:''}
      </div>`;
    });
    h+='</div>'; mi2.innerHTML=h;
  } else mi2.innerHTML='';
  document.getElementById('modal').classList.add('active');
  currentViewingReceipt=receipt;
}

async function markInstallmentPaid(iid,ev) {
  ev.stopPropagation();
  if(!confirm('Mark as paid?')) return;
  try {
    const r=await post({action:'markInstallmentPaid', installmentId:iid});
    if(r.success){alert('‚úÖ Marked as paid');await loadAllReceipts();await loadPayments();closeModal();}
    else throw new Error(r.error);
  } catch(e){alert('‚ùå Error: '+e.message);}
}

function closeModal(){document.getElementById('modal').classList.remove('active');currentViewingReceipt=null;}
function openDriveLink(){if(currentViewingReceipt&&currentViewingReceipt.driveLink)window.open(currentViewingReceipt.driveLink,'_blank');}

async function deleteReceipt() {
  if(!currentViewingReceipt||!confirm('Delete this receipt?')) return;
  try {
    const r=await post({action:'delete', receiptId:currentViewingReceipt.receiptId, driveFileId:currentViewingReceipt.driveFileId});
    if(r.success){closeModal();loadAllReceipts();alert('‚úÖ Deleted');}
    else throw new Error(r.error);
  } catch(e){alert('‚ùå Error: '+e.message);}
}

async function downloadReceipt() {
  if(!currentViewingReceipt) return;
  const link=document.createElement('a');
  link.href=`https://drive.google.com/uc?export=download&id=${currentViewingReceipt.driveFileId}`;
  link.download=`${currentViewingReceipt.regNumber}_${currentViewingReceipt.carName}.jpg`;
  link.target='_blank'; document.body.appendChild(link); link.click(); document.body.removeChild(link);
  alert('‚úÖ Download started!');
}

function editReceipt() {
  if(!currentViewingReceipt) return;
  closeModal();
  const r=currentViewingReceipt;
  document.getElementById('edit-car-name').value=r.carName||'';
  document.getElementById('edit-reg-number').value=r.regNumber||'';
  document.getElementById('edit-customer-name').value=r.customerName||'';
  document.getElementById('edit-customer-phone').value=r.customerPhone||'';
  document.getElementById('edit-selling-date').value=r.sellingDate||'';
  document.getElementById('edit-selling-price').value=r.sellingPrice||'';
  document.getElementById('edit-purchase-cost').value=r.purchaseCost||'';
  const sel=document.getElementById('edit-sold-by');
  sel.innerHTML='<option value="">Select Employee</option>';
  employeesList.forEach(e=>{const o=document.createElement('option');o.value=o.textContent=e;if(e===r.soldBy)o.selected=true;sel.appendChild(o);});
  document.getElementById('edit-modal').classList.add('active');
  ['edit-success','edit-error'].forEach(id=>document.getElementById(id).style.display='none');
}
function closeEditModal(){document.getElementById('edit-modal').classList.remove('active');}

async function saveEditedReceipt() {
  const vals={
    carName:document.getElementById('edit-car-name').value.trim(),
    regNumber:document.getElementById('edit-reg-number').value.trim().toUpperCase(),
    customerName:document.getElementById('edit-customer-name').value.trim(),
    customerPhone:document.getElementById('edit-customer-phone').value.trim(),
    sellingDate:document.getElementById('edit-selling-date').value,
    sellingPrice:document.getElementById('edit-selling-price').value.trim(),
    purchaseCost:document.getElementById('edit-purchase-cost').value.trim(),
    soldBy:document.getElementById('edit-sold-by').value,
    paymentType:currentViewingReceipt.paymentType,
    downPayment:currentViewingReceipt.downPayment||0
  };
  const err=document.getElementById('edit-error'), suc=document.getElementById('edit-success');
  err.style.display='none'; suc.style.display='none';
  if(!vals.carName||!vals.regNumber||!vals.customerName||!vals.customerPhone||!vals.sellingDate||!vals.sellingPrice||!vals.purchaseCost||!vals.soldBy){
    err.textContent='Please fill all fields';err.style.display='block';return;
  }
  const btn=event.target, ot=btn.innerHTML; btn.innerHTML='‚è≥ Saving...'; btn.disabled=true;
  try {
    const r=await post({
      action:'updateReceipt',
      receiptId:currentViewingReceipt.receiptId,
      carName:vals.carName,
      regNumber:vals.regNumber,
      customerName:vals.customerName,
      customerPhone:vals.customerPhone,
      sellingDate:vals.sellingDate,
      sellingPrice:parseFloat(vals.sellingPrice),
      purchaseCost:parseFloat(vals.purchaseCost),
      soldBy:vals.soldBy,
      paymentType:vals.paymentType,
      downPayment:vals.downPayment
    });
    if(r.success){suc.textContent='‚úÖ Updated!';suc.style.display='block';await loadAllReceipts();await loadPayments();setTimeout(closeEditModal,1500);}
    else throw new Error(r.error||'Update failed');
  } catch(e){err.textContent='‚ùå '+e.message;err.style.display='block';}
  finally{btn.innerHTML=ot;btn.disabled=false;}
}

// ===================== PROFIT - FIXED: reads expenses from sheet =====================
function getExpensesForReceipt(r) {
  // Priority: merged expenses on receipt object (from sheet), fallback to inline
  if (r.expenses && r.expenses.length > 0) return r.expenses;
  return allExpensesCache
    .filter(e => e.receiptId === r.receiptId)
    .map(e => ({ type: e.expenseType||e.type||'Other', description: e.description||'', amount: parseFloat(e.amount)||0 }));
}

async function calculateProfit() {
  if(allReceiptsCache.length===0) await loadAllData();
  let tr=0, tp=0, te=0;
  allReceiptsCache.forEach(r=>{
    tr+=parseFloat(r.sellingPrice)||0;
    tp+=parseFloat(r.purchaseCost)||0;
    te+=getExpensesForReceipt(r).reduce((s,e)=>s+(parseFloat(e.amount)||0),0);
  });
  const np=tr-tp-te, pm=tr>0?((np/tr)*100):0;
  document.getElementById('profit-revenue').textContent='‚Ç®'+tr.toLocaleString();
  document.getElementById('profit-purchase').textContent='‚Ç®'+tp.toLocaleString();
  document.getElementById('profit-expenses').textContent='‚Ç®'+te.toLocaleString();
  document.getElementById('profit-net').textContent='‚Ç®'+np.toLocaleString();
  document.getElementById('profit-margin').textContent=pm.toFixed(1)+'%';
  showProfitBreakdown();
}

function drawProfitCharts() {
  if (allReceiptsCache.length === 0) return;
  
  try {
    // Prepare data
    const carNames = allReceiptsCache.map(r => (r.carName || 'N/A').substring(0,20));
    const revenues = allReceiptsCache.map(r => parseFloat(r.sellingPrice) || 0);
    const profits = allReceiptsCache.map(r => {
      const s = parseFloat(r.sellingPrice) || 0;
      const p = parseFloat(r.purchaseCost) || 0;
      const e = getExpensesForReceipt(r).reduce((sum,x)=>sum+(parseFloat(x.amount)||0),0);
      return s - p - e;
    });
    
    // Chart 1: Revenue vs Profit Bar Chart (last 10 cars)
    const ctx1 = document.getElementById('profitChart');
    if (ctx1) {
      if (window.profitChartInstance) {
        window.profitChartInstance.destroy();
      }
      window.profitChartInstance = new Chart(ctx1.getContext('2d'), {
        type: 'bar',
        data: {
          labels: carNames.slice(-10),
          datasets: [{
            label: 'Revenue',
            data: revenues.slice(-10),
            backgroundColor: 'rgba(0,212,255,0.7)',
            borderColor: '#00D4FF',
            borderWidth: 2
          }, {
            label: 'Profit',
            data: profits.slice(-10),
            backgroundColor: 'rgba(40,167,69,0.7)',
            borderColor: '#28a745',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true, position: 'top' },
            title: { display: true, text: 'Revenue vs Profit (Last 10 Cars)' }
          },
          scales: {
            y: { beginAtZero: true, ticks: { callback: val => '‚Ç®' + val.toLocaleString() } }
          }
        }
      });
    }
    
    // Chart 2: Expense Breakdown Pie Chart
    const expenseTypes = {};
    allReceiptsCache.forEach(r => {
      getExpensesForReceipt(r).forEach(e => {
        const type = e.type || 'Other';
        expenseTypes[type] = (expenseTypes[type] || 0) + (parseFloat(e.amount) || 0);
      });
    });
    
    const ctx2 = document.getElementById('expenseChart');
    if (ctx2 && Object.keys(expenseTypes).length > 0) {
      if (window.expenseChartInstance) {
        window.expenseChartInstance.destroy();
      }
      window.expenseChartInstance = new Chart(ctx2.getContext('2d'), {
        type: 'pie',
        data: {
          labels: Object.keys(expenseTypes),
          datasets: [{
            data: Object.values(expenseTypes),
            backgroundColor: [
              'rgba(255,99,132,0.7)',
              'rgba(54,162,235,0.7)',
              'rgba(255,206,86,0.7)',
              'rgba(75,192,192,0.7)',
              'rgba(153,102,255,0.7)',
              'rgba(255,159,64,0.7)'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true, position: 'bottom', labels: { font: { size: 10 } } },
            title: { display: true, text: 'Expense Breakdown' }
          }
        }
      });
    }
    
    // Chart 3: Profit Margin Doughnut
    const margins = allReceiptsCache.map(r => {
      const s = parseFloat(r.sellingPrice) || 0;
      const p = parseFloat(r.purchaseCost) || 0;
      const e = getExpensesForReceipt(r).reduce((sum,x)=>sum+(parseFloat(x.amount)||0),0);
      return s > 0 ? ((s-p-e)/s)*100 : 0;
    });
    const avgMargin = margins.length > 0 ? margins.reduce((a,b)=>a+b,0) / margins.length : 0;
    
    const ctx3 = document.getElementById('marginChart');
    if (ctx3) {
      if (window.marginChartInstance) {
        window.marginChartInstance.destroy();
      }
      window.marginChartInstance = new Chart(ctx3.getContext('2d'), {
        type: 'doughnut',
        data: {
          labels: ['Profit Margin', 'Costs'],
          datasets: [{
            data: [Math.max(0,avgMargin), Math.max(0,100-avgMargin)],
            backgroundColor: [
              'rgba(40,167,69,0.7)',
              'rgba(220,53,69,0.7)'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true, position: 'bottom' },
            title: { display: true, text: 'Avg Profit Margin: ' + avgMargin.toFixed(1) + '%' }
          }
        }
      });
    }
  } catch(error) {
    console.error('Chart error:', error);
  }
}

function showProfitBreakdown() {
  const c=document.getElementById('profit-breakdown');
  if(!allReceiptsCache.length){c.innerHTML='<div class="no-results">No data</div>';return;}
  c.innerHTML=allReceiptsCache.map(r=>{
    const s=parseFloat(r.sellingPrice)||0, p=parseFloat(r.purchaseCost)||0;
    const e=getExpensesForReceipt(r).reduce((sum,x)=>sum+(parseFloat(x.amount)||0),0);
    const pf=s-p-e, mg=s>0?((pf/s)*100):0, col=pf>=0?'#28a745':'#dc3545';
    return `<div class="receipt-item" style="border-left:4px solid ${col};">
      <div class="receipt-reg">${r.carName||'N/A'} (${r.regNumber})</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;font-size:12px;">
        <div>Selling: ‚Ç®${s.toLocaleString()}</div><div>Purchase: ‚Ç®${p.toLocaleString()}</div>
        <div>Expenses: ‚Ç®${e.toLocaleString()}</div>
        <div style="font-weight:700;color:${col};">Profit: ‚Ç®${pf.toLocaleString()} (${mg.toFixed(1)}%)</div>
      </div>
      <div class="receipt-date" style="margin-top:8px;">Sold by: ${r.soldBy||'N/A'}</div></div>`;
  }).join('');
}

// ===================== EXPORT MODAL =====================
function openExportModal() {
  document.getElementById('export-modal').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeExportModal() {
  document.getElementById('export-modal').classList.remove('active');
  document.body.style.overflow = 'auto';
}

// Close modal when clicking outside
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('export-modal');
  if (modal) {
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeExportModal();
      }
    });
  }
});

function exportAnalyticsReport() {
  if (allReceiptsCache.length === 0) {
    alert('No data to export');
    return;
  }
  
  const wb = XLSX.utils.book_new();
  
  // Sales by employee
  const employeeSales = {};
  allReceiptsCache.forEach(r => {
    const emp = r.soldBy || 'Unknown';
    if (!employeeSales[emp]) {
      employeeSales[emp] = { count: 0, revenue: 0, profit: 0 };
    }
    employeeSales[emp].count++;
    employeeSales[emp].revenue += parseFloat(r.sellingPrice) || 0;
    const expenses = getExpensesForReceipt(r).reduce((s,e)=>s+(parseFloat(e.amount)||0),0);
    employeeSales[emp].profit += (parseFloat(r.sellingPrice)||0) - (parseFloat(r.purchaseCost)||0) - expenses;
  });
  
  const employeeData = Object.keys(employeeSales).map(emp => ({
    'Employee': emp,
    'Cars Sold': employeeSales[emp].count,
    'Revenue': employeeSales[emp].revenue,
    'Profit': employeeSales[emp].profit,
    'Avg per Car': employeeSales[emp].count > 0 ? Math.round(employeeSales[emp].profit / employeeSales[emp].count) : 0
  }));
  
  const ws1 = XLSX.utils.json_to_sheet(employeeData);
  XLSX.utils.book_append_sheet(wb, ws1, 'By Employee');
  
  // Best selling cars
  const carSales = {};
  allReceiptsCache.forEach(r => {
    const car = r.carName || 'Unknown';
    carSales[car] = (carSales[car] || 0) + 1;
  });
  
  const carData = Object.keys(carSales)
    .map(car => ({ 'Car Model': car, 'Units Sold': carSales[car] }))
    .sort((a,b) => b['Units Sold'] - a['Units Sold']);
  
  const ws2 = XLSX.utils.json_to_sheet(carData);
  XLSX.utils.book_append_sheet(wb, ws2, 'By Car Model');
  
  XLSX.writeFile(wb, `Analytics_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
}

function exportInventoryReport() {
  if (allReceiptsCache.length === 0) {
    alert('No data to export');
    return;
  }
  
  const inventoryData = allReceiptsCache.map(r => ({
    'Car Name': r.carName || 'N/A',
    'Registration': r.regNumber || 'N/A',
    'Status': r.status || 'AVAILABLE',
    'Selling Price': parseFloat(r.sellingPrice) || 0,
    'Purchase Cost': parseFloat(r.purchaseCost) || 0,
    'Customer': r.customerName || 'N/A',
    'Date': r.sellingDate || 'N/A',
    'Sold By': r.soldBy || 'N/A'
  }));
  
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(inventoryData);
  XLSX.utils.book_append_sheet(wb, ws, 'Inventory');
  XLSX.writeFile(wb, `Inventory_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
}

// ===================== EXPORT =====================
function exportSalesReport(){
  const d=allReceiptsCache.map(r=>{const e=getExpensesForReceipt(r).reduce((s,x)=>s+(parseFloat(x.amount)||0),0);const pf=(parseFloat(r.sellingPrice)||0)-(parseFloat(r.purchaseCost)||0)-e;return{'Receipt ID':r.receiptId,'Car':r.carName,'Reg':r.regNumber,'Customer':r.customerName,'Phone':r.customerPhone,'Date':r.sellingDate,'Selling':r.sellingPrice,'Purchase':r.purchaseCost||0,'Expenses':e,'Profit':pf,'Payment':r.paymentType,'Sold By':r.soldBy};});
  exportToExcel(d,'Sales_Report_'+new Date().toISOString().split('T')[0]);
}
function exportProfitReport(){
  const d=allReceiptsCache.map(r=>{const s=parseFloat(r.sellingPrice)||0,p=parseFloat(r.purchaseCost)||0,e=getExpensesForReceipt(r).reduce((s2,x)=>s2+(parseFloat(x.amount)||0),0),pf=s-p-e;return{'Car':r.carName,'Reg':r.regNumber,'Date':r.sellingDate,'Selling':s,'Purchase':p,'Expenses':e,'Gross':s-p,'Net Profit':pf,'Margin %':(s>0?((pf/s)*100).toFixed(2):0),'Sold By':r.soldBy};});
  exportToExcel(d,'Profit_Report_'+new Date().toISOString().split('T')[0]);
}
function exportPaymentReport(){
  const d=[];allReceiptsCache.forEach(r=>{if(r.paymentType==='INSTALLMENT'){allInstallmentsCache.filter(i=>i.receiptId===r.receiptId).forEach(i=>{d.push({'Car':r.carName,'Reg':r.regNumber,'Customer':r.customerName,'Phone':r.customerPhone,'Inst #':i.installmentNumber,'Due':i.dueDate,'Amount':i.amount,'Status':i.status,'Paid':i.paidDate||'N/A'});});}});
  exportToExcel(d,'Payment_Report_'+new Date().toISOString().split('T')[0]);
}
function exportExpenseReport(){
  const d=allExpensesCache.map(e=>{const r=allReceiptsCache.find(x=>x.receiptId===e.receiptId);return{'Car':r?r.carName:'N/A','Reg':e.receiptId,'Type':e.expenseType||e.type,'Description':e.description,'Amount':e.amount,'Date':e.date};});
  exportToExcel(d,'Expense_Report_'+new Date().toISOString().split('T')[0]);
}
function exportToExcel(data,name){
  if(!data||!data.length){alert('‚ùå No data to export');return;}
  const ws=XLSX.utils.json_to_sheet(data),wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Report');XLSX.writeFile(wb,name+'.xlsx');
}

// ===================== ANALYTICS =====================
async function calculateAnalytics() {
  if(allReceiptsCache.length===0) await loadAllData();
  const now=new Date();
  const total=allReceiptsCache.length;
  const rev=allReceiptsCache.reduce((s,r)=>s+(parseFloat(r.sellingPrice)||0),0);
  const today=new Date(now.getFullYear(),now.getMonth(),now.getDate());
  const dw=today.getDay(), mo=dw===0?-6:1-dw;
  const ws=new Date(today); ws.setDate(today.getDate()+mo);
  const wr=allReceiptsCache.filter(r=>new Date(r.sellingDate)>=ws);
  const mr=allReceiptsCache.filter(r=>new Date(r.sellingDate)>=new Date(now.getFullYear(),now.getMonth(),1));
  document.getElementById('total-cars').textContent=total;
  document.getElementById('total-revenue').textContent='‚Ç®'+rev.toLocaleString();
  document.getElementById('week-cars').textContent=wr.length;
  document.getElementById('week-revenue').textContent='‚Ç®'+wr.reduce((s,r)=>s+(parseFloat(r.sellingPrice)||0),0).toLocaleString();
  document.getElementById('month-cars').textContent=mr.length;
  document.getElementById('month-revenue').textContent='‚Ç®'+mr.reduce((s,r)=>s+(parseFloat(r.sellingPrice)||0),0).toLocaleString();
  calculateTopSalespeople(); calculateBestSellingCars();
}

function calculateTopSalespeople(){
  const es={};allReceiptsCache.forEach(r=>{const e=r.soldBy||'Unknown';if(!es[e])es[e]={count:0,revenue:0};es[e].count++;es[e].revenue+=parseFloat(r.sellingPrice)||0;});
  const s=Object.entries(es).sort((a,b)=>b[1].count-a[1].count).slice(0,5);
  const medals=['ü•á','ü•à','ü•â','üèÖ'];
  document.getElementById('top-salespeople-list').innerHTML=s.length?s.map(([n,d],i)=>`<div style="background:white;padding:12px;border-radius:8px;margin-bottom:10px;display:flex;align-items:center;gap:10px;"><span style="font-size:24px;">${medals[Math.min(i,3)]}</span><div><div style="font-weight:700;color:#00D4FF;">${n}</div><div style="font-size:12px;color:#666;">${d.count} cars ¬∑ ‚Ç®${d.revenue.toLocaleString()}</div></div></div>`).join(''):'<div class="no-results">No data</div>';
}
function calculateBestSellingCars(){
  const cc={};allReceiptsCache.forEach(r=>{const c=r.carName||'Unknown';if(!cc[c])cc[c]={count:0,revenue:0};cc[c].count++;cc[c].revenue+=parseFloat(r.sellingPrice)||0;});
  const s=Object.entries(cc).sort((a,b)=>b[1].count-a[1].count).slice(0,5);
  const medals=['ü•á','ü•à','ü•â','üèÖ'];
  document.getElementById('best-selling-list').innerHTML=s.length?s.map(([n,d],i)=>`<div style="background:white;padding:12px;border-radius:8px;margin-bottom:10px;display:flex;align-items:center;gap:10px;"><span style="font-size:24px;">${medals[Math.min(i,3)]}</span><div><div style="font-weight:700;color:#00D4FF;">${n}</div><div style="font-size:12px;color:#666;">${d.count} sold ¬∑ ‚Ç®${d.revenue.toLocaleString()}</div></div></div>`).join(''):'<div class="no-results">No data</div>';
}

document.getElementById('modal').addEventListener('click',e=>{if(e.target===document.getElementById('modal'))closeModal();});
document.getElementById('edit-modal').addEventListener('click',e=>{if(e.target===document.getElementById('edit-modal'))closeEditModal();});
</script>

<!-- EXPORT MODAL -->
<div id="export-modal" class="export-modal">
  <div class="export-modal-content">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
      <h3 style="margin:0;">üìä Export Reports</h3>
      <button onclick="closeExportModal()" style="background:#dc3545;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:700;">‚úï</button>
    </div>
    
    <div class="export-option" onclick="exportSalesReport();closeExportModal();">
      <div class="icon">üìä</div>
      <div class="text">
        <div class="title">Sales Report</div>
        <div class="desc">Complete list of all receipts with details</div>
      </div>
    </div>
    
    <div class="export-option" onclick="exportProfitReport();closeExportModal();">
      <div class="icon">üíµ</div>
      <div class="text">
        <div class="title">Profit Report</div>
        <div class="desc">Profit breakdown per car sold</div>
      </div>
    </div>
    
    <div class="export-option" onclick="exportPaymentReport();closeExportModal();">
      <div class="icon">üí∞</div>
      <div class="text">
        <div class="title">Payment Report</div>
        <div class="desc">Installment status and tracking</div>
      </div>
    </div>
    
    <div class="export-option" onclick="exportExpenseReport();closeExportModal();">
      <div class="icon">üí∏</div>
      <div class="text">
        <div class="title">Expense Report</div>
        <div class="desc">All additional expenses incurred</div>
      </div>
    </div>
    
    <div class="export-option" onclick="exportAnalyticsReport();closeExportModal();">
      <div class="icon">üìà</div>
      <div class="text">
        <div class="title">Analytics Report</div>
        <div class="desc">Performance metrics and statistics</div>
      </div>
    </div>
    
    <div class="export-option" onclick="exportInventoryReport();closeExportModal();">
      <div class="icon">üöó</div>
      <div class="text">
        <div class="title">Inventory Report</div>
        <div class="desc">Current stock status overview</div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
